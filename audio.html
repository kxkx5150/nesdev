<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache" />
  </head>
  <body>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-1">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Nerdy Nights Sound: Part 1: make a music/sfx engine</h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b><font size="5">The APU</font></b
        ><br />
        <br />
        Music and sound effects on the NES are generated by the <b>APU</b> (Audio Processing Unit), the
        sound chip inside the CPU.&nbsp; The CPU "talks" to the APU through a series of I/O ports, much
        like it does with the PPU and joypads.<br />
        <br />
        PPU: $2000-$2007<br />
        Joypads: $4016-$4017<br />
        APU: $4000-$4015, $4017<br />
        <br />
        <b><font size="4">Channels</font></b
        ><br />
        <br />
        The APU has 5 channels: Square 1, Square 2, Triangle, Noise and DMC.&nbsp; The first four play
        waves and are used in just about every game.&nbsp; The DMC channel plays samples (pre-recorded
        sounds) and is used less often.<br />
        <br />
        <b
          ><font size="3"><font size="2">Square</font></font></b
        ><br />
        The square channels produce square waveforms.&nbsp; A square wave is named for its shape.&nbsp;
        It looks like this:<br />
        &nbsp;
        <div id="j.ge" style="text-align: left">
          <img
            src="img/square_wave.jpg"
            style="width: 240px; height: 50px"
            original-src="http://tummaigames.com/square_wave.jpg"
            show-src="img/square_wave.jpg"
          />
        </div>
        <br />
        As you can see the wave transitions instantaneously from its high point to its low point (where
        the lines are vertical).&nbsp; This gives it a hollow sound like a woodwind or an electric
        guitar.<br />
        <br />
        <b
          ><font size="3"><font size="2">Triangle</font></font></b
        ><br />
        The triangle channel produces triangle waveforms.&nbsp; A triangle wave is also named for its
        shape.&nbsp; It looks like this:<br />
        &nbsp;
        <div id="rnep" style="text-align: left">
          <img
            src="img/triangle_wave.jpg"
            style="width: 240px; height: 50px"
            original-src="http://tummaigames.com/triangle_wave.jpg"
            show-src="img/triangle_wave.jpg"
          />
        </div>
        <br />
        The sound of a triangle wave is smoother and less harsh than a square wave. On the NES, the
        triangle channel is often used for bass lines (in low octaves) or a flute (in high
        octaves).&nbsp; It can also be used for drums.<br />
        <br />
        <font size="2"><b>Noise</b></font
        ><br />
        The noise channel has a random generator, which makes the waves it produces sound like..
        noise.&nbsp; This channel is generally used for percussion and explosion sounds.<br />
        <br />
        <font size="2"><b>DMC</b></font
        ><br />
        The DMC channel plays samples, which are pre-recorded sounds.&nbsp; It is often used to play
        voice recordings ("Blades of Steel") and percussion samples.&nbsp; Samples take up a lot of ROM
        space, so not many games make use of the DMC channel.<br />
        <br />
        <br />
        <b><font size="4">Enabling Channels</font></b
        ><br />
        <br />
        Before you can use the channels to produce sounds, you need to enable them.&nbsp; Channels are
        toggled on and off via port $4015:<br />
        <br />
        <span style="font-family: Courier New">APUFLAGS ($4015)</span
        ><br style="font-family: Courier New" />
        <br style="font-family: Courier New" />
        <span style="font-family: Courier New">76543210</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; |||||</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; ||||+- Square 1 (0: disable; 1: enable)</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; |||+-- Square 2</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; ||+--- Triangle</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; |+---- Noise</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; +----- DMC</span><br />
        <br />
        Here are some code examples using $4015 to enable and disable channels:&nbsp; &nbsp;<br />
        &nbsp; &nbsp;<br />
        <span style="font-family: Courier New">&nbsp;&nbsp; lda #%00000001</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New"
          >&nbsp;&nbsp; sta $4015 ;enable Square 1 channel, disable others</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; lda #%00010110</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New"
          >&nbsp;&nbsp; sta $4015 ;enable Square 2, Triangle and DMC channels.&nbsp; Disable Square 1 and
          Noise.</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; sta $4015 ;disable all channels</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp; lda #$0F</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New"
          >&nbsp;&nbsp; sta $4015 ;enable Square 1, Square 2, Triangle and Noise channels.&nbsp; Disable
          DMC.</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this is the most
          common usage.</span
        ><br />
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />
        Try opening up some of your favorite games in FCEUXD SP and set a breakpoint on writes to
        $4015.&nbsp; Take a look at what values are getting written there.&nbsp; If you don't know how to
        do this, follow these steps:<br />
        <br />
        1. Open FCEUXD SP<br />
        2. Load a ROM<br />
        3. Open up the Debugger by pressing F1 or going to Tools-&gt;Debugger<br />
        4. In the top right corner of the debugger, under "BreakPoints", click the "Add..." button<br />
        5. Type "4015" in the first box after "Address:"<br />
        6. Check the checkbox next to "Write"<br />
        7. Set "Memory" to "CPU Mem"<br />
        8. Leave "Condition" and "Name" blank and click "OK"<br />
        <br />
        Now FCEUX will pause emulation and snap the debugger anytime your game makes a write (usually via
        STA) to $4015.&nbsp; The debugger will tell you the contents of the registers at that moment, so
        you can check what value will be written to $4015.&nbsp; Some games will write to $4015 every
        frame, and some only do so once at startup.&nbsp; Try resetting the game if your debugger isn't
        snapping.<br />
        <br />
        What values are being written to $4015?&nbsp; Can you tell what channels your game is using?<br />
        <br />
        <br />
        <b><font size="4">Square 1 Channel</font></b
        ><br />
        <br />
        Let's make a beep.&nbsp; This week we'll learn how to produce a sound on the Square 1
        channel.&nbsp; The Square channels are everybody's favorites because you can control the volume
        and tone and perform sweeps on them.&nbsp; You can produce a lot of interesting effects using the
        Squares.<br />
        <br />
        Square 1 is controlled via ports $4000-$4003.&nbsp; The first port, $4000, controls the duty
        cycle (ie, tone) and volume for the channel.&nbsp; It looks like this:<br />
        <br />
        <span style="font-family: Courier New">SQ1_ENV ($4000)</span
        ><br style="font-family: Courier New" />
        <br style="font-family: Courier New" />
        <span style="font-family: Courier New">76543210</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">||||||||</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">||||++++- Volume</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New"
          >|||+----- Saw Envelope Disable (0: use internal counter for volume; 1: use Volume for
          volume)</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New"
          >||+------ Length Counter Disable (0: use Length Counter; 1: disable Length Counter)</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">++------- Duty Cycle</span><br />
        <br />
        For our purposes, we will focus on Volume and Duty Cycle.&nbsp; We will set Saw Envelope Disable
        and Length Counter Disable to 1 and then forget about them.&nbsp; If we leave Saw Envelopes on,
        the volume of the channel will be controlled by an internal counter.&nbsp; If we turn them off,
        WE have control of the volume.&nbsp; If WE have control, we can code our own envelopes (much more
        versatile).&nbsp; Same thing with the Length Counter.&nbsp; If we disable it, we have more
        control over note lengths.&nbsp; If that didn't make sense, don't worry.&nbsp; It will become
        clearer later.&nbsp; For now we're just going to disable and forget about them.<br />
        <br />
        <i>Volume</i> controls the channel's volume.&nbsp; It's 4 bits long so it can have a value from
        0-F.&nbsp; A volume of 0 silences the channel.&nbsp; 1 is very quiet and F is loud.<br />
        <br />
        <i>Duty Cycle</i> controls the tone of the Square channel.&nbsp; It's 2 bits long, so there are
        four possible values:<br />
        <br />
        00 = a weak, grainy tone.&nbsp; Think of the engine sounds in RC Pro-Am. (12.5% Duty)<br />
        01 = a solid mid-strength tone. (25% Duty)<br />
        10 = a strong, full tone, like a clarinet or a lead guitar (50% Duty)<br />
        11 = sounds a lot like 01 (25% Duty negated)<br />
        <br />
        The best way to know the difference in sound is to listen yourself.&nbsp; I recommend downloading
        <a
          href="http://famitracker.shoodot.net/"
          target="_blank"
          original-href="http://famitracker.shoodot.net/"
          >FamiTracker</a
        >
        and playing with the different Duty settings in the Instrument Editor.<br />
        <br />
        For those interested, Duty Cycle actually refers to the percentage of time that the wave is in
        "up" position vs. "down" position.&nbsp; Here are some pictures:<br />
        <br />
        12.5%
        <div id="f0:l" style="text-align: left">
          <img
            src="img/square_wave_125_duty.jpg"
            style="width: 240px; height: 50px"
            original-src="http://tummaigames.com/square_wave_125_duty.jpg"
            show-src="img/square_wave_125_duty.jpg"
          />
        </div>
        25%<br /><br />
        <div id="ilti" style="text-align: left">
          <img
            src="img/square_wave_25_duty.jpg"
            style="width: 240px; height: 50px"
            original-src="http://tummaigames.com/square_wave_25_duty.jpg"
            show-src="img/square_wave_25_duty.jpg"
          />
        </div>
        50%<br /><br />
        <div id="bjx0" style="text-align: left">
          <img
            src="img/square_wave_50_duty.jpg"
            style="width: 240px; height: 50px"
            original-src="http://tummaigames.com/square_wave_50_duty.jpg"
            show-src="img/square_wave_50_duty.jpg"
          />
        </div>
        25% negated<br /><br />
        <div id="qi76" style="text-align: left">
          <img
            src="img/square_wave_25neg_duty.jpg"
            style="width: 240px; height: 50px"
            original-src="http://tummaigames.com/square_wave_25neg_duty.jpg"
            show-src="img/square_wave_25neg_duty.jpg"
          />
        </div>
        <br />
        Don't sweat it if graphs and waves aren't your thing.&nbsp; Use your ears instead.<br />
        <br />
        Here's a code snippet that sets the Duty and Volume for the Square 1 channel:<br />
        <br />
        <span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10111111; Duty 10 (50%), volume F (max!)</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; sta $4000</span><br />
        <br />
        $4001 controls sweeps for Square 1.&nbsp; We'll skip them for now.<br />
        <br />
        <font size="2"><b>Setting the Note</b></font
        ><br />
        $4002 and $4003 control the period of the wave, or in other words what note you hear (A, C#, G,
        etc).&nbsp; Periods are 11-bits long.&nbsp; $4002 holds the low 8-bits and $4003 holds the high
        3-bits of the period.&nbsp; We'll get into more detail in a future tutorial, but for now just
        know that changing the values written to these ports will change the note that is played.<br />
        <br />
        <span style="font-family: Courier New">SQ1_LO ($4002)</span
        ><br style="font-family: Courier New" />
        <br style="font-family: Courier New" />
        <span style="font-family: Courier New">76543210</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">||||||||</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">++++++++- Low 8-bits of period</span
        ><br style="font-family: Courier New" />
        <br style="font-family: Courier New" />
        <span style="font-family: Courier New">SQ1_HI ($4003)</span
        ><br style="font-family: Courier New" />
        <br style="font-family: Courier New" />
        <span style="font-family: Courier New">76543210</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">||||||||</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">|||||+++- High 3-bits of period</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">+++++---- Length Counter</span><br />
        <br />
        The Length Counter, if enabled, controls how long the note is played.&nbsp; We disabled it up in
        the $4000 section, so we can forget about it for now.<br />
        <br />
        Here is some code that will produce an eternal beep on the Square 1 channel:<br />
        <br />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; lda #%00000001</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; sta $4015 ;enable square 1</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; lda #%10111111 ;Duty 10, Volume F</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; sta $4000</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$C9&nbsp;&nbsp;&nbsp; ;0C9 is a C# in NTSC mode</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; sta $4002</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; sta $4003</span><br />
        &nbsp;&nbsp; &nbsp;<br />
        <b>Putting It All Together</b><br />
        Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/square1.zip"
          target="_blank"
          original-href="http://tummaigames.com/square1.zip"
          >square1.zip</a
        >
        sample files. All the code above is in the square1.asm file. Make sure square1.asm and
        square1.bat are all in the same folder as NESASM3, then double click square1.bat. That will run
        NESASM3 and should produce the square1.nes file. Run that NES file in FCEUXD SP to listen to your
        beep!&nbsp; Edit square1.asm to change the Volume (0 to F), or to change the Duty Cycle for the
        square wave.&nbsp; Try changing the period to produce different notes.<br />
        <br />
        <b>Next Week</b>:
        <a
          href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22610"
          target="_blank"
          original-href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22610"
          >Square 2 and Triangle.&nbsp; Multiple beeps!</a
        >
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-1__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22484"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-2">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Nerdy Nights Sound: Part 2: Square 2 and Triangle Basics</h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22484"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22484"
          >APU Overview and Square 1 Basics</a
        ><br /><br /><b>This week</b>: We will learn how to makes sounds with the Square 2 and Triangle
        channels.<br /><br /><font size="4" style="font-weight: bold">Square 2</font><br /><br />Last
        time we produced a beep on the Square 1 channel by making writes to $4000-$4003.&nbsp; Now we'll
        learn how to do it with Square 2.&nbsp; This is very easy because Square 1 and Square 2 are
        almost identical.&nbsp; We control the Square 2 channel with ports $4004-$4007, and they more or
        less mirror Square 1's $4000-4003.<br /><br /><span style="font-family: Courier New"
          ><b>SQ2_ENV</b> ($4004)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">||||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >||||++++- Volume</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|||+----- Saw Envelope Disable (0: use internal counter for volume; 1: use Volume for
          volume)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >||+------ Length Counter Disable (0: use Length Counter; 1: disable Length Counter)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >++------- Duty Cycle</span
        ><br /><br />
        <br /><span style="font-family: Courier New"><b>SQ2_SWEEP</b> ($4005)</span><br />Skip this for
        now.&nbsp; This port, incidentally, is where Square 2 differs from Square 1.<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New"
          ><b
            ><br />
            SQ2_LO</b
          >
          ($4006)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">||||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >++++++++- Low 8-bits of period</span
        ><br /><br /><span style="font-family: Courier New"
          ><b
            ><br />
            SQ2_HI</b
          >
          ($4007)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">||||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|||||+++- High 3-bits of period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >+++++---- Length Counter</span
        ><br /><br />To produce a sound, first we enable the channel via $4015:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%00000010 ;enable Square 2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4015</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Then we write to the Square 2 ports:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%00111000 ;Duty Cycle 00, Volume 8 (half volume)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4004</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$A9&nbsp;&nbsp; ;$0A9 is an E in NTSC mode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4006</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4007</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Except for sweeps, the Square 2 channel works just like the
        Square 1 channel.<br />&nbsp;&nbsp; &nbsp;<br /><b><font size="4">Triangle</font></b
        ><br /><br />The Triangle channel produces triangle waveforms which have a smooth sound to
        them.&nbsp; Think of the flute-like melody in the Dragon Warrior overland song.&nbsp; That's the
        Triangle.<br /><br />Unlike the Square channels, we have no control over the Triangle channel's
        volume or tone.&nbsp; It makes only one type of sound and it's either on (playing) or off
        (silent).&nbsp; We manipulate the Triangle channel via ports $4008-$400B.<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">TRI_CTRL ($4008)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">||||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|+++++++- Value</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >+-------- Control Flag (0: use internal counters; 1: disable internal counters)</span
        ><br /><br />The triangle channel has two internal counters that can be used to automatically
        control note duration.&nbsp; We are going to disable them so that we can control note length
        manually.&nbsp; We will set the <b>Control Flag</b> to 1 and forget about it.<br /><br />When the
        internal counters are disabled, <b>Value</b> controls whether the channel is on or off.&nbsp; To
        silence the channel, set Value to 0.&nbsp; To turn the channel on (ie, unsilence), set Value to
        any non-zero value.&nbsp; Here are some examples:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10000000 ;silence the Triangle channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10000001 ;Triangle channel on</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10001111 ;Triangle channel on</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%11111111 ;Triangle channel on</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Note that the last three examples are functionally the
        same.&nbsp; Any non-zero value in Value makes the Triangle channel play.<br /><br /><b
          >Unused Port</b
        ><br />$4009 is unused<br /><br /><b>Setting the Note</b><br />$400A and $400B control the period
        of the wave, or in other words what note you hear (A, C#, G, etc).&nbsp; Like the Squares,
        Triangle periods are 11-bits long.&nbsp; $400A holds the low 8-bits and $400B holds the high
        3-bits of the period.&nbsp; We'll learn more about periods next week, but for now just know that
        changing the values written to these ports will change the note that is played.<br /><br /><span
          style="font-family: Courier New"
          >TRI_LO ($400A)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">||||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >++++++++- Low 8-bits of period</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >TRI_HI ($400B)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">||||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|||||+++- High 3-bits of period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >+++++---- Length Counter</span
        ><br /><br />The Length Counter, if enabled, controls how long the note is played.&nbsp; We
        disabled it up in the $4008 section, so we can forget about it for now.<br /><br />Here is some
        code to play an eternal beep on the Triangle channel:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%00000100 ;enable Triangle channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4015</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10000001 ;disable counters, non-zero Value turns channel on</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$42&nbsp;&nbsp; ;a period of $042 plays a G# in NTSC mode.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400A</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400B</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><font size="4"><b>Multiple Beeps</b></font
        ><br />We now know how to use the Square 1, Square 2 and Triangle channels to make sound.&nbsp;
        It doesn't take too much extra work to make them all play at the same time.&nbsp; We just have to
        enable all three channels via $4015 and then write to the ports.&nbsp; Here's some code that will
        play a C#m chord (C# E G#) using the knowledge we have gained up to now:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%00000111&nbsp; ;enable Sq1, Sq2 and Tri channels</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4015</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;Square 1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%00111000&nbsp; ;Duty 00, Volume 8 (half volume)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4000</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$C9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$0C9 is a C# in NTSC
          mode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;low 8 bits of period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;high 3 bits of period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;Square 2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%01110110&nbsp; ;Duty 01, Volume 6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4004</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$A9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$0A9 is an E in NTSC
          mode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4006</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4007</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;Triangle</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10000001&nbsp; ;Triangle channel on</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$42&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$042 is a G# in NTSC
          mode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400A</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400B</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Putting It All Together</b><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/triad.zip"
          target="_blank"
          original-href="http://tummaigames.com/triad.zip"
          >triad.zip</a
        >
        sample files. All the code above is in the triad.asm file. Make sure triad.asm and triad.bat are
        all in the same folder as NESASM3, then double click triad.bat. That will run NESASM3 and should
        produce the triad.nes file. Run that NES file in FCEUXD SP to listen to your C#m chord!&nbsp;
        Edit triad.asm to change the Volume and Duty Cycle for the square waves.&nbsp; Try changing the
        Periods to produce different notes.<br /><br />Try to silence the various channels by either
        disabling them via $4015 or silencing them via $4000/$4004/$4008.<br /><br />Finally try writing
        some code that will silence/unsilence the individual channels based on user input, like so:<br /><br /><span
          style="font-weight: bold"
          >A</span
        >: toggle Square 1 channel on/off<br /><span style="font-weight: bold">B</span>: toggle Square 2
        channel on/off<br /><span style="font-weight: bold">Select</span>: toggle Triangle channel
        on/off<br /><br /><b>Next Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22776"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22776"
          >Periods and Lookup Tables</a
        ><br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-2__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22610"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-3">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Nerdy Nights Sound: Part 3: Periods and lookup tables</h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22610"
          target="_blank"
          original-href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22610"
          >Square 2 and Triangle Basics</a
        ><br /><br /><b>This week</b>: We will learn about periods and build a period lookup table that
        spans 8 octaves.<br /><br /><b><font size="4">Periods</font></b
        ><br /><br />In the last two lessons, I've been giving you the values to plug into the 11-bit
        periods for the Square and Triangle channels.&nbsp; I haven't been giving you an explanation of
        what a period is, or where I got those numbers.&nbsp; So this week we're going to learn about
        periods.<br /><b
          ><br />
          What is a period?</b
        ><br />A period refers to the length of a wave, or rather the <i>time</i> length of the
        <i>repeating</i> part of a wave.&nbsp; Take a look at this square wave (x-axis is time):<br /><br />
        <div id="xdzs" style="text-align: left">
          <img
            style="width: 240px; height: 50px"
            src="img/File_id_d36ccdg_32dh4jjkdf_b"
            original-src="http://docs.google.com/File?id=d36ccdg_32dh4jjkdf_b"
            show-src="img/File_id_d36ccdg_32dh4jjkdf_b"
          />
        </div>
        Notice how it is repeating.&nbsp; It starts high and remains high for 2 time units.&nbsp; Then it
        goes low and remains low for 2 time units.&nbsp; Then it repeats.&nbsp; When we say period, we
        are talking about the horizontal time length of this repeating wave.&nbsp; In this case, the
        period is 4 time units.&nbsp; The longer a period is, the lower the note will sound.&nbsp;&nbsp;
        Conversely, the shorter a period is, the higher the note will sound.&nbsp; Look at these 3 Square
        waves:<br /><br />Period = 6 time units<br />
        <div id="o6dq" style="text-align: left">
          <img
            style="width: 240px; height: 50px"
            src="img/File_id_d36ccdg_33fm9jm9dg_b"
            original-src="http://docs.google.com/File?id=d36ccdg_33fm9jm9dg_b"
            show-src="img/File_id_d36ccdg_33fm9jm9dg_b"
          />
        </div>
        <br />Period = 4 time units<br />
        <div id="wj8x" style="text-align: left">
          <img
            style="width: 240px; height: 50px"
            src="img/File_id_d36ccdg_34gmf46jdj_b"
            original-src="http://docs.google.com/File?id=d36ccdg_34gmf46jdj_b"
            show-src="img/File_id_d36ccdg_34gmf46jdj_b"
          />
        </div>
        <br />Period = 1 time unit<br />
        <div id="mw1w" style="text-align: left">
          <img
            style="width: 240px; height: 50px"
            src="img/File_id_d36ccdg_354r6gfhx5_b"
            original-src="http://docs.google.com/File?id=d36ccdg_354r6gfhx5_b"
            show-src="img/File_id_d36ccdg_354r6gfhx5_b"
          />
        </div>
        <br />The top wave has the longest period (6 time units) and it will sound the lowest.&nbsp; The
        bottom wave has a short period (1 time unit) and will sound higher than the other two.<br /><br />On
        the NES, we write an 11-bit period to the APU ports.&nbsp; The smaller the number, the shorter
        the period, the higher the note.&nbsp; Larger numbers = longer periods = lower notes.&nbsp; Look
        at the following code snippets that write an 11-bit period to the Square 1 ports:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$C9</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$05</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003 ;period $5C9: large number = long period = low note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;----</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$09</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003 ;period $009: small number = short period = very high note</span
        ><br /><br /><b>Periods -&gt; Notes</b><br />So how do we know which 11-bit period values
        correspond to which notes?&nbsp; The magic forumla is:<br /><br />&nbsp;&nbsp;&nbsp; P = C/(F*16)
        - 1<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; P = Period<br />&nbsp;&nbsp;&nbsp; C = CPU
        speed (in Hz) <br />&nbsp;&nbsp;&nbsp; F = Frequency of the note (also in Hz). &nbsp;<br />&nbsp;&nbsp;
        &nbsp;<br />The value of C differs between NTSC and PAL machines, which is why a game made for
        NTSC will sound funny on a PAL NES, and vice-versa.<br /><br />To find the period values for
        notes, we will have to look up note frequencies and plug them into the formula.&nbsp; Or we can
        cross our fingers and hope somebody has already done the work for us and put the answers in an
        easy-to-read table.&nbsp; Lucky for us a cool fellow named Celius has done just that, for both
        NTSC and PAL.&nbsp; Here are the charts:<br /><br /><a
          href="downloads/missing/NotesTableNTSC.txt"
          target="_blank"
          original-href="http://www.freewebs.com/the_bott/NotesTableNTSC.txt"
          >http://www.freewebs.com/the_bott/NotesTableNTSC.txt</a
        ><br />
        <a
          href="downloads/missing/NotesTablePAL.txt"
          target="_blank"
          original-href="http://www.freewebs.com/the_bott/NotesTablePAL.txt"
          >http://www.freewebs.com/the_bott/NotesTablePAL.txt</a
        ><br />
        <br /><b><font size="4">Lookup Tables</font></b
        ><br />It is fairly common practice to store period values in a lookup table.&nbsp; A
        <b>lookup table</b> is a table of pre-calculated data stored in ROM.&nbsp; Like an answer
        sheet.&nbsp; Lookup tables are used to cut down on complicated, time-consuming
        calculations.&nbsp; Let's look at a trivial example.&nbsp; Let's say you want a subroutine that
        takes a value in A and returns 3^A.&nbsp; If you took the brute-force approach, you might write
        something like this:<br /><br /><span style="font-family: Courier New">multiplier .rs 1</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >; takes a value (0-5) in A and returns 3^A</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >three_to_the_a:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .not_zero</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;3^0 is 1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.not_zero:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$03</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.loop:&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta multiplier</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dey</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .done</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc multiplier</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc multiplier</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />It works, but it's not very pretty.&nbsp; Here is how we would do
        it with a lookup table:<br /><br /><span style="font-family: Courier New"
          >;lookup table with pre-calculated answers</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">powers_of_3:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte 1, 3, 9, 27, 81, 243</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >three_to_the_a:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda powers_of_3, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Easier to code.&nbsp; Easier to read.&nbsp; And it runs faster
        too.<br /><br /><b>NESASM3 Tip#1: Local Labels</b><br />You may have noticed in the above example
        that I put a period in front of some labels: <b>.done</b>, <b>.loop</b>, <b>.not_zero</b>.&nbsp;
        NESASM3 treats these as local labels.&nbsp; There are two types of labels: global and
        local.&nbsp; A <b>global label</b> exists across the whole program and must be unique.&nbsp; A
        <b>local label</b> only exists between two global labels.&nbsp; This means that we can reuse the
        names of local labels - they only need to be unique within their scope.&nbsp; Using local labels
        saves you the trouble of having to create unique names for common case labels (like
        looping).&nbsp; I tend to use local labels for all labels that occur within subroutines.&nbsp; To
        make a label local, stick a period in front of it.<br />&nbsp;&nbsp; &nbsp;<br /><font size="3"
          ><b>Note Lookup Table</b></font
        ><br />Let's take Celius's tables and turn them into a note lookup table. Period values are 11
        bits so we will need to define our lookup table using words.&nbsp; Note that .word is the same as
        .dw.&nbsp; Here is a note_table for NTSC:<br /><br /><span style="font-family: Courier New"
          >;Note: octaves in music traditionally start from C, not A. &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; I've adjusted my octave numbers to reflect this.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">note_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          .word&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          $07F1, $0780, $0713 ; A1-B1 ($00-$02)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $06AD, $064D, $05F3, $059D, $054D, $0500, $04B8, $0475, $0435, $03F8,
          $03BF, $0389 ; C2-B2 ($03-$0E)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $0356, $0326, $02F9, $02CE, $02A6, $027F, $025C, $023A, $021A, $01FB,
          $01DF, $01C4 ; C3-B3 ($0F-$1A)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $01AB, $0193, $017C, $0167, $0151, $013F, $012D, $011C, $010C, $00FD,
          $00EF, $00E2 ; C4-B4 ($1B-$26)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $00D2, $00C9, $00BD, $00B3, $00A9, $009F, $0096, $008E, $0086, $007E,
          $0077, $0070 ; C5-B5 ($27-$32)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $006A, $0064, $005E, $0059, $0054, $004F, $004B, $0046, $0042, $003F,
          $003B, $0038 ; C6-B6 ($33-$3E)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $0034, $0031, $002F, $002C, $0029, $0027, $0025, $0023, $0021, $001F,
          $001D, $001B ; C7-B7 ($3F-$4A)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $001A, $0018, $0017, $0015, $0014, $0013, $0012, $0011, $0010, $000F,
          $000E, $000D ; C8-B8 ($4B-$56)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $000C, $000C, $000B, $000A, $000A, $0009,
          $0008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ; C9-F#9 ($57-$5D)</span
        ><br style="font-family: Courier New" /><br />Notice that at the highest octaves, some notes have
        the same value (C9 and C#9 for example).&nbsp; This is due to rounding.&nbsp; We lose precision
        the higher we go, and a lot of the highest notes will sound out of tune as a result.&nbsp; So in
        songs we probably wouldn't use octaves 8 and 9.&nbsp; These high notes could be utilized for
        sound effects though, so we'll leave them in.<br />&nbsp;&nbsp; &nbsp;<br />Once we have a note
        lookup table, we use the note we want as an index into the table and pull the period values from
        it, like this:<br />&nbsp;&nbsp; &nbsp;<br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$0C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;the 13th entry in the table (A2)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;multiply
          by 2 because we are indexing into a table of words</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y&nbsp;&nbsp; ;read the low byte of the period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;write to SQ1_LO</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y ;read the high byte of the period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;write to SQ1_HI</span
        ><br />&nbsp;&nbsp; &nbsp;<br />To make it easier to know which index to use for each note, we
        can create a list of <b>symbols</b>:<br /><br /><span style="font-family: Courier New"
          >;Note: octaves in music traditionally start at C, not A</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >;Octave 1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >A1 = $00&nbsp;&nbsp;&nbsp; ;"1" means octave 1.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >As1 = $01&nbsp;&nbsp; ;"s" means "sharp"</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >Bb1 = $01&nbsp;&nbsp; ;"b" means "flat".&nbsp; A# == Bb</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">B1 = $02</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >;Octave 2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">C2 = $03</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">Cs2 = $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">Db2 = $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">D2 = $05</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">;...</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">A2 = $0C</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">As2 = $0D</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">Bb2 = $0D</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">B2 = $0E</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >;Octave 3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">C3 = $0F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">;... etc</span
        ><br /><br />Now we can use our new symbols instead of the actual index values:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda
          <b>#A2</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;A2.&nbsp;
          #A2 will evaluate to #$0C</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;multiply
          by 2 because we are indexing into a table of words</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y&nbsp;&nbsp; ;read the low byte of the period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;write to SQ1_LO</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y ;read the high byte of the period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;write to SQ1_HI</span
        ><br />&nbsp;&nbsp; &nbsp;<br />And if later we want to have a series of notes, symbols are much
        easier to read and alter:<br /><br /><span style="font-family: Courier New">sound_data:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C3, E3, G3, B3, C4, E4, G4, B4, C5 ; Cmaj7 (CEGB)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_data_no_symbols:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $0F, $13, $16, $1A, $1B, $1F, $22, $26, $27 ;same as above, but hard
          to read. Cmaj7 (CEGB)</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><br /><b>Low Notes On Squares (Sweep Unit)</b><br />One last
        thing needs to be mentioned.&nbsp; It's very important.&nbsp; It has to do with the Square
        channels' sweep units.&nbsp;&nbsp; The sweep units can silence the square channels in certain
        situations (Periods &gt;= $400, our lowest notes), <i>even when disabled</i>.&nbsp; We'll have to
        take a quick look at the sweep unit ports to solve this problem.<br /><br /><span
          style="font-family: Courier New"
          >SQ1_SWEEP ($4001), SQ2_SWEEP ($4005)</span
        ><br style="font-family: Courier New" />
        <br style="font-family: Courier New" />
        <span style="font-family: Courier New">76543210</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">||||||||</span><br style="font-family: Courier New" />
        <span style="font-family: Courier New">|||||+++- Shift</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">||||+---- Negate</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">|+++----- Sweep Unit Period</span
        ><br style="font-family: Courier New" />
        <span style="font-family: Courier New">+-------- Enable (1: enabled; 0: disabled)</span
        ><br /><br />I'm not going to go into how it works now, but the unwanted silencing of low notes
        can be circumvented by <b>setting the negate flag</b>:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$08&nbsp;&nbsp;&nbsp; ;set Negate flag on the sweep unit</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4001&nbsp;&nbsp; ;or $4005 for Square 2.</span
        ><br />&nbsp;&nbsp; &nbsp;<br />If you really want to know why, check the Sweep Unit section of
        blargg's
        <a
          href="scraper/files/apu_ref.txt"
          target="_blank"
          original-href="http://www.slack.net/%7Eant/nes-emu/apu_ref.txt"
          >NES APU Sound Hardware Technical Reference</a
        >.<br /><br /><b>What about PAL?</b><br />For simplicity, these tutorials are going to use NTSC
        numbers.&nbsp; Once we finish our sound engine I'll try to whip up a tutorial about adding PAL
        support.<br /><br /><b>Putting It All Together</b><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/periods.zip"
          target="_blank"
          original-href="http://tummaigames.com/periods.zip"
          >periods.zip</a
        >
        sample files.&nbsp; Make sure periods.asm, periods.chr, note_table.i and periods.bat are all in
        the same folder as NESASM3, then double click periods.bat. That will run NESASM3 and should
        produce the periods.nes file. Run that NES file in FCEUXD SP.&nbsp; Use the d-pad to select and
        play any note from our note table on the Square 1 channel.&nbsp; Controls are as follows:<br /><br /><b
          >Up</b
        >
        - Play selected note<br /><b>Down</b> - Stop note<br /><b>Left</b> - Move selection down a
        note<br /><b>Right</b> - Move selection up a note<br /><br /><b>Homework</b>: Edit periods.asm
        and add support for the Square 2 and Triangle channels.&nbsp; Allow the user to select between
        channels and play different notes on all three of them.<br /><br /><b>Homework #2</b>: Read
        Disch's document
        <a
          href="http://nesdevhandbook.googlepages.com/theframe.html"
          target="_blank"
          original-href="http://nesdevhandbook.googlepages.com/theframe.html"
          >The Frame and NMIs</a
        >.&nbsp; Pay special attention to the "Take Full Advantage of NMI" section.&nbsp; We are going to
        use this style of NMI handler with our sound engine.&nbsp; In fact, periods.asm already uses
        it.<br /><br /><b>Next Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23024"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23024"
          >Starting our sound engine.</a
        ><br /><br /><br /><br /><br /><br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-3__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22776"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-4">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Nerdy Nights Sound: Part 4: sound engine skeleton</h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22776"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=22776"
          >Periods, Lookup Tables</a
        ><br /><br /><b>This Week</b>: Sound Engine Basics.&nbsp; We will setup the framework to get our
        sound engine running.<br /><br /><b><font size="4">Sound Engine</font></b
        ><br /><br />Now that we know how to get notes to play we can start thinking about our sound
        engine.&nbsp; What do we want it to be able to do?&nbsp; How will the main program interact with
        it?<br /><br />It's good practice to separate the different pieces of your program.&nbsp; The
        sound engine shouldn't be messing with main program code and vice-versa.&nbsp; If you mix them,
        your code becomes harder to read, the danger of variable conflicts increases and you open
        yourself up to hard-to-find bugs.&nbsp;&nbsp; If you keep the different pieces of your program
        separate, you get the opposite: your code reads well, you avoid variable conflicts, and bugs are
        easier to trace.&nbsp; Separation also improves your ability to reuse code.&nbsp; If your sound
        engine only accesses its own internal routines and variables, it makes it that much easier to
        pull it out from one game and plug it into another.<br /><br />There has to be some communication
        between the main program and the sound engine of course.&nbsp; The main program needs to be able
        to tell the sound engine to do things like: "Play song 2" or "shut up".&nbsp; But we don't want
        the main program sticking its nose in the sound engine's business.&nbsp; We only want it to issue
        commands.&nbsp; The sound engine will handle the rest on its own.<br /><br />To set this up, we
        will create a small set of subroutines that the main program can use to invoke the sound engine
        and give it commands.&nbsp; I'll call these subroutines "<b>entrances</b>".&nbsp; We want as few
        entrances into the sound engine as possible.&nbsp; The sound engine itself will have several
        internal subroutines it can work with, but the main program will only use the entrances.<br /><br /><b
          >Entrances</b
        ><br />So what will our entrance subroutines be?&nbsp; We need to think about what the main
        program would need to tell the sound engine to do.&nbsp; Here is a list of entrances we might
        want for our sound engine:<br /><br />-Initialize sound engine&nbsp;&nbsp;&nbsp; (sound_init)<br />-Load
        new song/sfx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (sound_load)<br />-Play a
        frame of music/sfx&nbsp; (sound_play_frame)<br />-Disable sound
        engine&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (sound_disable)<br /><br />The names in paranthesis
        are what I'm going to call the subroutines in code.&nbsp; I prefixed them with sound_ for
        readability.&nbsp; You can tell at a glance that they are sound routines.&nbsp; Here is a rundown
        of what our commands will do:<br /><br /><b>sound_init</b> will enable channels and silence
        them.&nbsp; It will also initialize sound engine variables.<br /><br /><b>sound_load</b> will
        take a song/sfx number as input.&nbsp; It will use that song number to index into a table of
        pointers to song headers.&nbsp; It will read the appropriate header and set up sound engine
        variables.&nbsp; If that didn't make sense, don't worry.&nbsp; We'll be covering this stuff next
        week.<br /><br /><b>sound_play_frame</b> will advance the sound engine by one frame.&nbsp; It
        will run the note timers, read from the data streams (if necessary), update sound variables and
        make writes to the APU ports.&nbsp; This stuff will also be covered in future weeks.<br /><b
          ><br />
          sound_disable</b
        >
        will disable channels via $4015 and set a disable flag variable.<br /><br />We already know
        enough to knock out two of those, sound_init and sound_disable.&nbsp; Let's write them now.&nbsp;
        We'll write skeleton code for the other entrance subroutines as well.&nbsp; A few things to
        mention before we do that though:<br /><br /><b>RAM</b><br />A sound engine requires a lot of
        RAM.&nbsp; A large sound engine might even take up a full page of RAM.&nbsp; For this tutorial,
        we'll stick all our sound engine variables on the $300 page of RAM.&nbsp; There is nothing magic
        about this number.&nbsp; I chose $300 for convenience.&nbsp; $000 is your zero-page RAM.&nbsp;
        $100 is your stack.&nbsp; If you completed the original Nerdy Nights series, $200 will be your
        Sprite OAM.&nbsp; So $300 is next in line.<br /><br /><b>ROM</b><br />The sound engine itself
        won't require a lot of ROM space for code, but if you have a lot of music your song data might
        take up a lot of space.&nbsp; For this reason, I'm going to change our header to give us two 16k
        PRG-ROM banks, like this:<br /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .inesprg 2 ;2x 16kb PRG code</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Now we have twice as much ROM space, just in case we need
        it.&nbsp; BTW, this is the maximum amount of ROM we can have without using a mapper.<br />&nbsp;&nbsp;
        &nbsp;<br /><b>Noise Channel</b><br />I purposely haven't covered the Noise channel yet.&nbsp; We
        will want to silence it in our init code though, so I will go ahead and teach that much.&nbsp;
        Noise channel volume is controlled via port $400C.&nbsp; It works the same as $4000/$4004 does
        for the Square channels, except there is no Duty Cycle control:<br /><br /><span
          style="font-family: Courier New"
          >NOISE_ENV ($400C)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; ||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; ||++++- Volume</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; |+----- Saw Envelope Disable (0: use internal counter for volume; 1: use Volume for
          volume)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; +------ Length Counter Disable (0: use Length Counter; 1: disable Length Counter)</span
        ><br />&nbsp; <br />Like the Squares, we will silence the Noise channel by setting both disable
        flags, and setting the Volume to 0.<br />&nbsp;&nbsp; &nbsp;<br /><b
          ><font size="3">Skeleton Sound Engine</font></b
        ><br />Let's write the entrance subroutines to our sound engine.&nbsp; Most of this code should
        be very familiar to you if you completed the first three tutorials in this series.<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .rsset $0300 ;sound engine variables will be on the $0300 page of RAM</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_disable_flag&nbsp; .rs 1&nbsp;&nbsp; ;a flag variable that keeps track of whether the
          sound engine is disabled or not.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if set, sound_play_frame will return without doing anything.</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .bank 0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .org $8000&nbsp; ;we have two 16k PRG banks now.&nbsp; We will stick our
          sound engine in the first one, which starts at $8000.</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >sound_init:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$0F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4015&nbsp;&nbsp; ;enable Square 1, Square 2, Triangle and Noise
          channels</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$30</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4000&nbsp;&nbsp; ;set Square 1 volume to 0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4004&nbsp;&nbsp; ;set Square 2 volume to 0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400C&nbsp;&nbsp; ;set Noise volume to 0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008&nbsp;&nbsp; ;silence Triangle</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_disable_flag&nbsp; ;clear disable flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;later, if we have other variables we want to initialize, we will do that
          here.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_disable:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4015&nbsp;&nbsp; ;disable all channels</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_disable_flag&nbsp; ;set disable flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >sound_load:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;nothing here yet</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_play_frame:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_disable_flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .done&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if disable flag is set,
          don't advance a frame</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;nothing here yet</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><br />&nbsp;&nbsp; &nbsp;<br /><b
          >Driving the Sound Engine</b
        ><br />We have the framework setup for our sound engine to run.&nbsp; The main program now has
        subroutines it can call to issue commands to the sound engine.&nbsp; Most of them don't do
        anything yet, but we can still integrate them into the main program.&nbsp; First we will want to
        make a call to sound_init somewhere in our reset code:<br /><br /><span
          style="font-family: Courier New"
          >RESET:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sei</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cld</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx #$FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; txs</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inx</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;... clear memory, etc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr sound_init</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;... more reset stuff</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Next we need something to drive our sound engine.&nbsp; Music is
        time-based.&nbsp; In any piece of music, assuming a constant tempo, each quarter note needs to
        last exactly as long as every other quarter note.&nbsp; A whole note has to be exactly as long as
        four quarter notes.&nbsp; If our sound engine is going to play music, it needs to be time-based
        as well.&nbsp; We have a subroutine, sound_play_frame, that will advance our sound engine a frame
        at a time.&nbsp; Now we need to ensure it gets called repeatedly at a regular time interval.<br /><br />One
        way to do this is to stick it in the NMI.&nbsp; Recall that when enabled, the NMI will trigger at
        the start of every vblank.&nbsp; Vblank is the only safe time to write to the PPU, so the NMI is
        typically full of drawing code.&nbsp; We don't want to waste our precious vblank time running
        sound code, but what about after we are finished drawing?&nbsp; If we stick our call to
        sound_play_frame at the end of NMI, after the drawing code, we are set.&nbsp; sound_play_frame
        gets called once per frame, and we avoid stepping on the PPU's toes.&nbsp; And since
        sound_play_frame doesn't write to the PPU registers, it doesn't matter if our sound code spills
        out of vblank. &nbsp;<br /><br />Let's setup the NMI to drive our sound engine:<br /><br /><span
          style="font-family: Courier New"
          >NMI:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; pha&nbsp;&nbsp;&nbsp;&nbsp; ;save registers</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; txa</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; pha</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tya</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; pha</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do sprite DMA</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;update palettes if needed</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;draw stuff on the screen</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;set scroll</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr sound_play_frame&nbsp;&nbsp;&nbsp; ;run our sound engine after all
          drawing code is done.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;this ensures our sound engine gets run once per frame.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta
          sleeping&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;did you do your
          homework and read Disch's document last week?</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;<a
            href="http://nesdevhandbook.googlepages.com/theframe.html"
            target="_blank"
            original-href="http://nesdevhandbook.googlepages.com/theframe.html"
            >http://nesdevhandbook.googlepages...</a
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; pla&nbsp;&nbsp;&nbsp;&nbsp; ;restore registers</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; pla</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tax</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; pla</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rti</span
        ><br /><b
          ><br />
          .include</b
        ><br />To further separate our sound engine from the main program, we can keep all our sound
        engine code in a separate file.&nbsp; NESASM3 gives us a directive .include that we can use to
        copy a source file into our main program.&nbsp; We actually used this directive last week to
        include the note_table.i file, which contained our period lookup table. &nbsp;<br /><br />Using
        .include to copy a source file into our code is very similar to how we use .incbin to import a
        .chr file.&nbsp; Assuming our sound engine code is saved in a file called sound_engine.asm, we
        will add the following code to our main program:<br />&nbsp;&nbsp; &nbsp;<br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .include "sound_engine.asm"</span
        ><br /><br />We will continue to include note_table.i, but since it is part of our sound engine
        we will stick the .include directive in the sound_engine.asm file.<br /><br />It's not bad
        practice to use includes a lot.&nbsp; You can pull your joypad routines out and stick them in
        their own file.&nbsp; You can have separate files for your gamestate code, for your PPU routines
        and for just about anything else you can think of.&nbsp; Breaking up your code like this will
        make it easier to find things as your program gets larger and more complicated.&nbsp; It also
        makes it easier to plug your old routines into new programs.<br />&nbsp;&nbsp; &nbsp;<br /><b
          >Putting It All Together</b
        ><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/skeleton.zip"
          target="_blank"
          original-href="http://tummaigames.com/skeleton.zip"
          >skeleton.zip</a
        >
        sample files.&nbsp; Make sure skeleton.asm, sound_engine.asm, skeleton.chr, note_table.i,
        sound_data.i and skeleton.bat are all in the same folder as NESASM3, then double click
        skeleton.bat. That will run NESASM3 and should produce the skeleton.nes file. Run that NES file
        in FCEUXD SP.<br /><br />I've hardcoded sound_load and sound_play_frame to play a little melody
        on the Square 1 channel.&nbsp; It uses a simple frame counter to control note speed.&nbsp; The
        data for the music is found in the sound_data.i file.&nbsp;&nbsp; Use the controller to interact
        with the sound engine.&nbsp; Controls are as follows:<br />&nbsp;&nbsp; &nbsp;<br /><span
          style="font-weight: bold"
          >A</span
        >: Play sound from the beginning (sound_load)<br /><span style="font-weight: bold">B</span>:
        Initialize the sound engine (sound_init)<br /><span style="font-weight: bold">Start</span>:
        Disable sound engine (sound_disable)<br /><br />Try editing sound_engine.asm to change the data
        stream that sound_play_frame reads from.&nbsp; The different data streams available are located
        in sound_data.i.&nbsp; Try adding your own data stream to sound_data.i too.&nbsp; Use the note
        symbols we made last week and terminate your data stream with $FF.<br /><br /><b>Homework</b>:
        Write two new sound engine entrance subroutines for the main program to use:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        1. sound_pause: pauses playback of the sound, but retains the current position in the data
        stream.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2. sound_unpause: if the sound is
        currently paused, resumes play from the saved position.<br />Then modify handle_joypad to allow
        the user to pause/unpause the music.<br /><br /><b>Homework #2</b>: If the ideas presented in
        Disch's
        <a
          href="http://nesdevhandbook.googlepages.com/theframe.html"
          target="_blank"
          original-href="http://nesdevhandbook.googlepages.com/theframe.html"
          >The Frames and NMIs</a
        >
        document are still fuzzy in your head, read it again.
        <img
          src="img/blank.gif"
          border="0"
          style="display: none"
          original-src="i/expressions/face-icon-small-smile.gif"
          show-src="img/blank.gif"
        /><br /><br /><b>Extra Credit</b>:&nbsp; See if you can understand how my drawing buffer
        works.&nbsp; Use Disch's document to help you.&nbsp; I won't cover drawing buffers in these sound
        tutorials, for obvious reasons, but it is definitely worth your time to learn how to use them.<br />&nbsp;&nbsp;
        &nbsp;<br /><b>Next week</b>:
        <a
          href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23452"
          target="_blank"
          original-href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23452"
          >Sound Data, Pointer Tables, Headers</a
        ><br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-4__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23024"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-5">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">
          Nerdy Nights Sound: Part 5: Sound Data, Pointer Tables, Headers
        </h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23024"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23024"
          >Sound Engine Basics, Skeleton sound engine</a
        ><br /><br /><b>This Week</b>: Sound Data, Pointer Tables, Headers<br /><br /><font size="4"
          ><b>Designing Sound Data</b></font
        ><br /><br />We have a skeleton sound engine in place.&nbsp; Time to pack it with flesh and
        organs.&nbsp; Before we can play a song, we will have to load a song.&nbsp; Before we can load a
        song, we will need song data.&nbsp; So our next step is to decide how our sound data will
        look.&nbsp; We'll need to design our data format, create some test data and then build our engine
        to read and play that data.<br /><br /><b>Data Formats</b><br />So how do we go about designing a
        sound data format?&nbsp; A good place to start would be to look at what we are aiming to
        play.&nbsp; We know that our sound engine will have two basic types of sound data:<br /><br />1.
        Music<br />2. Sound Effects (SFX)<br /><br /><i>Music</i> plays in the background.&nbsp; It uses
        the first 4 channels, has a tempo, and usually loops over and over again.<br /><br /><i
          >Sound Effects</i
        >
        are triggered by game events (eg, ball hitting a paddle) and don't loop indefinitely.<br /><br />Sound
        effects have the job of communicating to the player what is going on right now, so they have
        priority over music.&nbsp; If there is music playing on the Square 2 channel, and a sound effect
        is also using the Square 2 channel, the sound effect should play instead of the music.<br /><br />Depending
        on the game, some sound effects may have higher priority than others.&nbsp; For example, in a
        Zelda-like game the sound of the player taking damage would have priority over the sound of the
        player swinging their sword.&nbsp; The former communicates critical information to the player
        while the latter is just for effect.<br /><br /><b>Streams</b><br />As mentioned above, a sound
        effect will have to share a channel (or channels) with the music.&nbsp; This is unavoidable
        because music typically uses all the channels at once, all the time.&nbsp; So when a sound effect
        starts playing, it has to steal a channel (or more) away from the music.&nbsp; The music will
        continue to play on the other channels, but the shared channel will go to the sound effect.&nbsp;
        This creates an interesting problem: if we stop music on a channel to play a sound effect, how do
        we know where to resume the music on that channel when the sound effect is finished?<br /><br />The
        answer is that we don't actually stop the music on the shared channel.&nbsp; We still advance it
        frame by frame in time with the other music channels.&nbsp; We just don't write its data to the
        APU ports when a sound effect is playing.<br /><br />To do this, we will need to keep track of
        multiple streams of sound data.&nbsp; A data <b>stream</b> is a sequence of bytes stored in ROM
        that the sound engine will read and translate into APU writes.&nbsp; Each stream corresponds to
        one channel.&nbsp; Music will have 4 data streams - one for each channel.&nbsp; Sound effects
        will have 2 streams and the sfx themselves will choose which channel(s) they use.&nbsp; So 6
        streams total that could potentially be running at the same time.&nbsp; We will number them like
        this:<br /><br /><span style="font-family: Courier New"
          >MUSIC_SQ1 = $00 ;these are stream number constants</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >MUSIC_SQ2 = $01 ;stream number is used to index into stream variables (see below)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >MUSIC_TRI = $02</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >MUSIC_NOI = $03</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >SFX_1&nbsp;&nbsp;&nbsp;&nbsp; = $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >SFX_2&nbsp;&nbsp;&nbsp;&nbsp; = $05</span
        ><br /><br /><br />Each stream will need it's own variables in RAM.&nbsp; An easy way to organize
        this is to reserve RAM space in blocks and use the stream number as an index: <br /><br /><span
          style="font-family: Courier New"
          >;reserve 6 bytes each, one for each stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_curr_sound .rs 6&nbsp;&nbsp;&nbsp;&nbsp; ;what song/sfx # is this stream currently
          playing?&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_channel .rs 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;what channel is it playing
          on?</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_vol_duty .rs 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;volume/duty settings for this
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_note_LO .rs 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;low 8 bits of period for the
          current note playing on the stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_note_HI .rs 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;high 3 bits of the note
          period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">;..etc</span
        ><br /><br />Here we have 6 bytes reserved for each variable.&nbsp; Each stream gets its own
        byte, for example:<br />&nbsp;&nbsp;&nbsp; stream_vol_duty+0:&nbsp; MUSIC_SQ1's volume/duty
        settings<br />&nbsp;&nbsp;&nbsp; stream_vol_duty+1:&nbsp; MUSIC_SQ2's volume/duty<br />&nbsp;&nbsp;&nbsp;
        stream_vol_duty+2:&nbsp; MUSIC_TRI's on/off<br />&nbsp;&nbsp;&nbsp; stream_vol_duty+3:&nbsp;
        MUSIC_NOI's volume<br />&nbsp;&nbsp;&nbsp; stream_vol_duty+4:&nbsp; SFX_1's volume/duty<br />&nbsp;&nbsp;&nbsp;
        stream_vol_duty+5:&nbsp; SFX_2's volume/duty<br />&nbsp;&nbsp; &nbsp;<br />In our
        sound_play_frame code we will loop through all of the streams using the stream number as an
        index:<br />&nbsp;&nbsp; &nbsp;<br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx #$00&nbsp;&nbsp;&nbsp; ;start at stream 0 (MUSIC_SQ1)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;read from data stream in ROM if necessary</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;update stream variables based on what we read</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_vol_duty, x&nbsp; ;the value in x determines which stream we are
          working with</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do stuff with volume</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do stuff with note periods</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do more stuff with other variables</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;next stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpx #$06&nbsp;&nbsp;&nbsp; ;loop through all six streams</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .loop</span
        ><br /><br />The music streams will always be running, updating the APU ports with their data
        frame by frame.&nbsp; When a sound effect starts playing, one or both of the sfx streams will
        start running.&nbsp; Because our loop processes the SFX streams last, they will write to the APU
        last and thus overwrite the shared-channel music streams.&nbsp; Our channel conflict is taken
        care of automatically by the order of our loop!<br />&nbsp;&nbsp; &nbsp;<br /><font size="4"
          ><b>Music</b></font
        ><br />We now have an idea of how our stream data will be stored in RAM, but there are still many
        unanswered questions.&nbsp; How do we load a song?&nbsp; How do we know where to find the data
        streams in ROM?&nbsp; How do we read from those data streams?&nbsp; How do we interpret what we
        read from those streams?<br /><br />To answer these questions, we need to make a data
        format.&nbsp; Let's start with music.&nbsp; What should our music data look like?&nbsp; Most NES
        music data is divided into three types:<br /><br />1. <b>Note</b> - what note to play: A3, G#5,
        C2, etc<br />2. <b>Note Length</b> - how long to play the notes: eighth note, quarter note, whole
        note, etc<br />3. <b>Opcodes</b> - opcodes tell the engine to perform specific tasks: loop,
        adjust volume, change Duty Cycle for squares, etc<br />*3.5. <b>Arguments</b> - some opcodes will
        take arguments as input (e.g. how many times to loop, where to loop to).<br /><br /><b>Ranges</b
        ><br />We will need to design our data format to make it easy for the sound engine to
        differentiate between these three types of data.&nbsp; We do this by specifying ranges.&nbsp; For
        example, we might say that byte values of $00-$7F represent Notes.&nbsp; $80-$9F are Note
        Lengths, and $A0-$FF are opcodes.&nbsp; I just made those numbers up.&nbsp; It really doesn't
        matter what values we use.&nbsp; The important thing is that we have ranges to test against to
        determine whether a byte is a note, note length or opcode.&nbsp; In our engine code we will have
        something like this:<br /><br /><span style="font-family: Courier New">fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_pointer], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read a byte from the
          data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc
          .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if &lt;
          #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note Length stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note stuff</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This code reads a byte from the sound data and then tests that
        byte to see which range it falls into.&nbsp; It jumps to a different section of code for each
        possible range.&nbsp; Almost any data format you create will be divided into ranges like this,
        whether it be sound data, map data, text data, whatever.<br /><br /><b>BPL and BMI</b><br />These
        two branch instructions are worth learning if you don't know them already.&nbsp; After BEQ, BNE,
        BCS and BCC they are the most common branch instructions.&nbsp; They are often used in
        range-testing.<br /><br /><b>BPL</b> tests the Negative (N) flag and will branch if it is
        clear.&nbsp; Think of BPL as Branch if PLus.&nbsp; The N flag will be clear if the last
        instruction executed resulted in a value less than #$80 (ie, <i>bit7 clear</i>).<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%01101011</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; |</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; +-------- bit7 is clear.&nbsp; This will clear
          the N flag.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl .somewhere&nbsp; ;N flag is clear, so this will branch</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10010101</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; |</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; +-------- bit7 is set.&nbsp; This will set the N
          flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl .somewhere&nbsp; ;N flag is set, so this will not branch.</span
        ><br /><br /><b>BMI</b> is the opposite.&nbsp; It tests the N flag and will branch if it is
        set.&nbsp; Think of BMI as Branch if MInus.&nbsp; The N flag will be set if the last instruction
        executed resulted in a value greater than or equal to #$80 (ie,
        <i>bit7 set</i>).<br /><br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%01101011</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; |</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; +-------- bit7 is clear.&nbsp; This will clear
          the N flag.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bmi .somewhere&nbsp; ;N flag is clear, so this will not branch</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #%10010101</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; |</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; +-------- bit7 is set.&nbsp; This will set the N
          flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bmi .somewhere&nbsp; ;N flag is set, so this will branch to the label
          .somewhere.</span
        ><br /><br />In the range-testing code above, I used BPL to check if a byte fell into the Note
        range (00-7F).&nbsp; Go back and check it.<br /><font size="4"
          ><br />
          <b>Song Headers</b></font
        ><br />Music on the NES is typically composed of four parts: a Square 1 part, a Square 2 part, a
        Triangle part and a Noise part.&nbsp; When you want to play a song, you will have the main
        program issue a command to the sound engine telling it what song you want to play.&nbsp; It will
        look something like this:<br /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$02</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr sound_load&nbsp; ;load song 2</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Somehow our sound_load subroutine will have to take that "2" and
        translate it into a whole song, complete with Square 1, Square 2, Triangle and Noise parts.&nbsp;
        How does that little number become 4 streams of data?&nbsp; Well, that number is an index into a
        pointer table, a table of pointers to song headers.&nbsp; The song headers themselves will
        contain pointers to the individual channels' data streams.<br /><br /><font size="4"
          ><b>Pointer Tables</b></font
        ><br />A pointer table is a special kind of lookup table.&nbsp; Only instead of holding regular
        old numerical data a pointer table holds <b>addresses</b>.&nbsp; These addresses "point" to the
        start of data.&nbsp; Addresses on the NES are 16-bit ($0000-$FFFF), so pointer tables are always
        tables of words.&nbsp; Let's look at an example:<br /><br /><span
          style="font-family: Courier New"
          >pointer_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $8000, $ABCD, $CC10, $DF1B</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Here we have a pointer table.&nbsp; It's four entries long.&nbsp;
        Each entry is a 16-bit address.&nbsp; Presumably there is data at these four addresses that we
        will want to read sometime in our program.&nbsp; To read this data we will need to index into the
        pointer table, grab the address and store it in a zero-page pointer variable and then read using
        indirect mode:<br /><br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .rsset $0000</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >ptr1 .rs 2&nbsp; ;a 2-byte pointer variable.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;The first byte will hold
          the LO byte of an address</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;The second byte will hold
          the HI byte of an address</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .org $E000&nbsp; ;somewhere in ROM</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$02&nbsp;&nbsp;&nbsp; ;the third entry in the pointer table
          ($CC10)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;multiply by 2 because we are
          indexing into a table of words</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda pointer_table, y&nbsp;&nbsp;&nbsp; ;#$10 - little endian, so words are
          stored LO-byte first</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta ptr1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda pointer_table+1, y&nbsp; ;#$CC</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta ptr1+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;now our pointer is setup in ptr1.&nbsp; It "points" to address
          $CC10.&nbsp; Let's read data from there.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [ptr1], y&nbsp;&nbsp; ;indirect mode.&nbsp; reads the byte at
          $CC10</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta some_variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [ptr1], y&nbsp;&nbsp; ;reads the byte at $CC11</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta some_other_variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;... etc</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This code takes an index and uses it to read an address from our
        pointer_table.&nbsp; It stores this address in a variable called ptr1 (LO byte first).&nbsp; Then
        it reads from this address by using indirect mode.&nbsp; We specify indirect mode by putting []'s
        around our pointer variable.&nbsp; Look at this instruction: &nbsp;<br />&nbsp;&nbsp; &nbsp;<br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [ptr1], y</span
        ><br style="font-family: Courier New" /><br />It means "Find the address ptr1 is pointing
        to.&nbsp; Add Y to that address.&nbsp; Load the value at that address into A".<br /><br />This is
        very versatile because we can stick any address we want into our ptr1 variable and read from
        anywhere!&nbsp; A pointer table is just a lookup table of places we want to read from.<br /><br />Of
        course you usually won't know where exactly in the ROM your data will be.&nbsp; So instead of
        declaring addresses explicitely ($8000, $ABCD, $CC10, etc), you will use labels instead:<br /><br /><span
          style="font-family: Courier New"
          >pointer_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word data1, data2, data3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;these
          entries will evaluate to the 16-bit addresses of the labels below</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >data1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $FF, $16, $82, $44&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;some
          random data</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">data2:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $0E, $EE, $EF, $16, $23</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">data3:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $00, $01</span
        ><br />&nbsp;&nbsp;&nbsp; <br />
        <b>Song Header Pointer Table</b><br />Our songs work the same way.&nbsp; When the main program
        tells the sound engine to play a song, it will send the song number with it.&nbsp; This song
        number is actually an index into a pointer table of song headers:<br />&nbsp;&nbsp; &nbsp;<br /><span
          style="font-family: Courier New"
          >song_headers:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song0_header</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song1_header</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song2_header</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;..etc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">sound_load:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 2.&nbsp; we are indexing into a table of pointers (words)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda song_headers, y&nbsp;&nbsp;&nbsp;&nbsp; ;read LO byte of a pointer from
          the pointer table.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;sound_ptr is a zero page pointer variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda song_headers+1, y&nbsp;&nbsp; ;read HI byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta some_variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;...read the rest of the header data</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><font size="4"><b>Header Data</b></font
        ><br />So what will our song header data look like?&nbsp; At the very least it should tell us:<br /><br />How
        many data streams we have (songs will usually have 4, but sfx will have fewer)<br />Which streams
        those are (which stream index to use)<br />Which channels those streams use<br />Where to find
        those streams (ie, pointers to the beginning of each stream).<br />Initial values for those
        streams (for example, initial volume)<br /><br />As we add more features to our sound engine, we
        may expand our headers to initialize those features.&nbsp; Let's start simple.&nbsp; Our headers
        will look like this:<br /><br /><span style="font-family: Courier New">main header:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >byte #&nbsp; | what it tells us</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | number of streams</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >01+&nbsp;&nbsp;&nbsp;&nbsp; | stream headers (one for each stream)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >stream headers:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >byte #&nbsp; | what it tells us</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | which stream (stream number)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | status byte (see below)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | which channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | initial volume (and duty for squares)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >04-05&nbsp;&nbsp; | pointer to data stream</span
        ><br /><br />The <b>status byte</b> will be a bit-flag that tells us special information about
        the stream.&nbsp; For now we will just use bit0 to mark a stream as enabled or disabled.&nbsp; In
        the future we may use other bits to store other information, such as stream priority.<br /><br
          style="font-family: Courier New"
        /><b><span style="font-family: Courier New">Stream Status Byte</span></b
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +- Enabled (0: stream disabled; 1: enabled)</span
        ><br style="font-family: Courier New" /><br /><br />
        <b>Sample Header</b><br />Here is some code showing a sample header:<br /><br /><span
          style="font-family: Courier New"
          >SQUARE_1 = $00 ;these are channel constants</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >SQUARE_2 = $01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >TRIANGLE = $02</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">NOISE = $03</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >MUSIC_SQ1 = $00 ;these are stream # constants</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >MUSIC_SQ2 = $01 ;stream # is used to index into stream variables</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >MUSIC_TRI = $02</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >MUSIC_NOI = $03</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >SFX_1&nbsp;&nbsp;&nbsp;&nbsp; = $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >SFX_2&nbsp;&nbsp;&nbsp;&nbsp; = $05</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >song0_header:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;4
          streams</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte MUSIC_SQ1&nbsp;&nbsp;&nbsp;&nbsp; ;which stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;status byte (stream enabled)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte SQUARE_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $BC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;initial volume (C) and duty (10)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song0_square1 ;pointer to stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte MUSIC_SQ2&nbsp;&nbsp;&nbsp;&nbsp; ;which stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;status byte (stream enabled)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte SQUARE_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $38&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;initial volume (8) and duty (00)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song0_square2 ;pointer to stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte MUSIC_TRI&nbsp;&nbsp;&nbsp;&nbsp; ;which stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;status byte (stream enabled)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte TRIANGLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $81&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;initial volume (on)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song0_tri&nbsp;&nbsp;&nbsp;&nbsp; ;pointer to stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte MUSIC_NOI&nbsp;&nbsp;&nbsp;&nbsp; ;which stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;disabled.&nbsp; We will have our load routine skip the</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp;&nbsp; rest of the reads if the status byte disables the stream.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp;&nbsp; We are disabling Noise because we haven't covered it yet.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          ><br />
          ;these are the actual data streams that are pointed to in our stream headers. &nbsp;&nbsp; </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >song0_square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, C5, E5, A5 ;some notes.&nbsp; A minor</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >song0_square2:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, A3, A3, E4, A3, A3, E4 ;some notes to play on square 2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">song0_tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, A3, A3, A3, A3, A3, A3 ;triangle data</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Sound Engine Variables</b><br />The last thing we need before
        we can write our sound_load routine is some variables.&nbsp; As mentioned, our sound engine will
        have several streams running simultaneously.&nbsp; Four will be used for music (one for each
        tonal channel).&nbsp; Two will be used for sound effects.&nbsp; So we will declare all variables
        in blocks of 6.&nbsp; Based on our header data, we will need the following variables:<br /><br /><span
          style="font-family: Courier New"
          >stream_curr_sound .rs 6&nbsp;&nbsp;&nbsp;&nbsp; ;reserve 6 bytes, one for each stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_status .rs 6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_channel .rs 6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_vol_duty .rs 6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_ptr_LO .rs 6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_ptr_HI .rs 6</span
        ><br /><br /><b>sound_load</b><br />Now let's write some code to read our header.&nbsp; Pay
        special attention to the X register.&nbsp; I recommend tracing through the code using the sample
        header above.&nbsp; Here is our sound_load routine:<br /><br /><span
          style="font-family: Courier New"
          >;-------------------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >; load_sound will prepare the sound engine to play a song or sfx.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;&nbsp;&nbsp; input:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; A: song/sfx number to play</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">sound_load:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save song
          number</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 2.&nbsp; We are indexing into a table of pointers (words)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda song_headers, y&nbsp;&nbsp;&nbsp;&nbsp; ;setup the pointer to our song
          header</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda song_headers+1, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read the first byte: #
          streams</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_temp2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;store in a
          temp variable.&nbsp; We will use this as a loop counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;stream number</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          tax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;stream number acts as our variable index</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;status byte.&nbsp; 1=
          enable, 0=disable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .next_stream&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if status byte
          is 0, stream disabled, so we are done</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;channel number</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;initial duty and volume
          settings</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_vol_duty, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;pointer to stream
          data.&nbsp; Little endian, so low byte first</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.next_stream:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;song
          number</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_curr_sound, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dec sound_temp2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;our loop
          counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Now our sound_load routine is ready.&nbsp; If the main program
        calls it, like this:<br /><br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00 ;song 0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr sound_load</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Our sound_load routine will take the value in the A register and
        use it to fill our music RAM with everything we need to get our song running!<br /><br /><b
          >Reading Streams</b
        ><br />Once we have our header loaded, we are ready to rock.&nbsp; All of our active streams have
        pointers to their data stored in their stream_ptr_LO and stream_ptr_HI variables.&nbsp; That's
        all we need to start reading data from them.<br /><br />To read data from our data stream, we
        will first copy the stream pointer into a zero-page pointer variable.&nbsp; Then we will read a
        byte using indirect mode and range-test it to determine whether it is a note, note length or
        opcode.&nbsp; If it's a note, we will read from our note_table and store the 11-bit period in
        RAM.&nbsp; Finally, we will update our stream pointer to point to the next byte in the stream.
        &nbsp;<br /><br />First we will need to declare some new variable blocks for the note periods:<br /><br /><span
          style="font-family: Courier New"
          >stream_note_LO .rs 6&nbsp;&nbsp;&nbsp; ;low 8 bits of period</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_note_HI .rs 6&nbsp;&nbsp;&nbsp; ;high 3 bits of period</span
        ><br style="font-family: Courier New" /><br />Here is our se_fetch_byte routine (se_ stands for
        "sound engine"):<br /><br /><span style="font-family: Courier New"
          >;--------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >; se_fetch_byte reads one byte from a sound data stream and handles it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;&nbsp;&nbsp; input: </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; X: stream number</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x&nbsp;&nbsp;&nbsp; ;copy stream pointer into a zero
          page pointer variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read a byte using
          indirect mode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if
          &lt;#$80, we have a note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp
          #$A0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else if &lt;#$A0 we have a note length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else we have an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;nothing here yet</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .update_pointer</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;nothing here yet</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .update_pointer</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          asl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 2 because we are index into a table of words</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save our Y
          register because we are about to destroy it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;pull low 8-bits of
          period and store it in RAM</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y&nbsp;&nbsp;&nbsp;&nbsp; ;pull high 3-bits of period
          from our note table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;restore
          the Y register</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;;update our stream pointers to point to the next byte in the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;.update_pointer:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;set index to the next byte in the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tya</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_ptr_LO, x&nbsp;&nbsp;&nbsp; ;add Y to the LO pointer</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .end</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inc stream_ptr_HI, x&nbsp;&nbsp;&nbsp; ;if there was a carry, add 1 to the
          HI pointer.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.end:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br /><br />Look at the part that updates the stream pointer.&nbsp;&nbsp; After we finish all
        our reads, Y will hold the index of the last byte read.&nbsp; To be ready for the next frame, we
        will want to update our pointer to point to the next byte in the data stream.&nbsp; To do this,
        we increment Y and add it to the pointer.&nbsp; But we have to be careful here.&nbsp; What if our
        current position is something like this:<br /><br />stream_ptr: $C3FF <br />Y: 1&nbsp;&nbsp;
        &nbsp;<br /><br />The next position here should be $C400.&nbsp; But ADC only works on the 8-bit
        level, so if we add 1 to the low byte of the pointer we will get this instead:<br /><br />stream_ptr:
        $C300<br /><br />The FF in the low byte becomes 00, but the high byte remains the same.&nbsp; We
        need to increment the high byte manually.&nbsp; But how do we know when to increment it and when
        to leave it alone?&nbsp; Lucky for us, ADC sets the carry flag whenever it makes a FF-&gt;00
        transition.&nbsp; So we can just check the carry flag after our addition.&nbsp; If it is set,
        increment the high byte of the pointer.&nbsp; If it is clear, don't increment it.&nbsp; That's
        what our code above does.<br /><br /><font size="4"><b>Playing Music</b></font
        ><br />We've loaded our header.&nbsp; We've set up our stream pointers in RAM.&nbsp; We've
        written a routine that will read bytes from the streams and turn them into notes.&nbsp; Now we
        need to update sound_play_frame.&nbsp; sound_play_frame will loop through all 6 streams.&nbsp; It
        will check the status byte to see if they are enabled.&nbsp; If enabled, it will advance the
        stream by one frame.&nbsp; Here's the code:<br /><br /><span style="font-family: Courier New"
          >sound_play_frame:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_disable_flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .done&nbsp;&nbsp; ;if sound engine is disabled, don't advance a
          frame</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inc sound_frame_counter&nbsp;&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_frame_counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$08&nbsp;&nbsp;&nbsp; ;***change this compare value to make the notes
          play faster or slower***</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .done&nbsp;&nbsp; ;only take action once every 8 frames.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx
          #$00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;our stream index.&nbsp; start at MUSIC_SQ1 stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x&nbsp;&nbsp;&nbsp; ;check bit 0 to see if stream is
          enabled</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #$01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .next_stream&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if disabled,
          skip to next stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_fetch_byte&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read from the stream
          and update RAM </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_set_apu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;write
          volume/duty, sweep, and note periods of current stream to the APU ports</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.next_stream:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inx</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpx
          #$06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;loop through all 6 streams.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_frame_counter ;reset frame counter so we can start counting to 8
          again. &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br /><br /><br />And here is se_set_apu which will write a stream's data to the APU ports:<br />&nbsp;&nbsp;
        &nbsp;<br /><span style="font-family: Courier New">se_set_apu:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x&nbsp;&nbsp; ;which channel does this stream write
          to?</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 4 so Y will index into the right set of APU ports (see below)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_vol_duty, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4000, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #TRIANGLE</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcs .end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if Triangle or Noise,
          skip this part</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else, set negate flag
          in sweep unit to allow low notes on Squares</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4001, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.end:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Writing to the APU ports directly like this is actually bad
        form.&nbsp; We'll learn why in a later lesson.<br /><br />One thing to pay attention to is how we
        get our APU port index.&nbsp; We take the channel and multiply it by 4.&nbsp; Recall that we
        declared constants for our channels:<br /><br /><span style="font-family: Courier New"
          >SQUARE_1 = $00 ;these are channel constants</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >SQUARE_2 = $01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >TRIANGLE = $02</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">NOISE = $03</span
        ><br /><br />If our stream_channel is $00 (SQUARE_1), we multiply by 4 to get $00.&nbsp; y = 0<br />&nbsp;&nbsp;&nbsp;
        $4000, y = $4000 &nbsp;<br />&nbsp;&nbsp;&nbsp; $4001, y = $4001 <br />&nbsp;&nbsp;&nbsp; $4002,
        y = $4002 <br />&nbsp;&nbsp;&nbsp; $4003, y = $4003<br />If our stream_channel is $01 (SQUARE_2),
        we multiply by 4 to get $04.&nbsp; y = 4<br />&nbsp;&nbsp;&nbsp; $4000, y = $4004 &nbsp;<br />&nbsp;&nbsp;&nbsp;
        $4001, y = $4005 &nbsp;<br />&nbsp;&nbsp;&nbsp; $4002, y = $4006<br />&nbsp;&nbsp;&nbsp; $4003, y
        = $4007 <br />If our stream_channel is $02 (TRIANGLE), we multiply by 4 to get $08.&nbsp; y =
        8<br />&nbsp;&nbsp;&nbsp; $4000, y = $4008 &nbsp;<br />&nbsp;&nbsp;&nbsp; $4001, y = $4009
        (unused) &nbsp;<br />&nbsp;&nbsp;&nbsp; $4002, y = $400A <br />&nbsp;&nbsp;&nbsp; $4003, y =
        $400B<br />If our stream_channel is $03 (NOISE), we multiply by 4 to get $0C.&nbsp; y = C<br />&nbsp;&nbsp;&nbsp;
        $4000, y = $400C &nbsp;<br />&nbsp;&nbsp;&nbsp; $4001, y = $400D &nbsp;<br />&nbsp;&nbsp;&nbsp;
        $4002, y = $400E<br />&nbsp;&nbsp;&nbsp; $4003, y = $400F<br />
        <br />
        See how everything lines up nicely?<br /><br /><b>Putting It All Together</b><br />Download and
        unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/headers.zip"
          target="_blank"
          original-href="http://tummaigames.com/headers.zip"
          >headers.zip</a
        >
        sample files.&nbsp; Make sure the following files are in the same folder as NESASM3:<br /><br />&nbsp;&nbsp;&nbsp;
        headers.asm<br />&nbsp;&nbsp;&nbsp; sound_engine.asm<br />&nbsp;&nbsp;&nbsp; headers.chr<br />&nbsp;&nbsp;&nbsp;
        note_table.i<br />&nbsp;&nbsp;&nbsp; song0.i<br />&nbsp;&nbsp;&nbsp; song1.i<br />&nbsp;&nbsp;&nbsp;
        song2.i<br />&nbsp;&nbsp;&nbsp; song3.i<br />&nbsp;&nbsp;&nbsp; headers.bat<br /><br />Double
        click headers.bat. That will run NESASM3 and should produce the headers.nes file. Run that NES
        file in FCEUXD SP.<br /><br />Use the controller to select songs and play them.&nbsp; Controls
        are as follows:<br />&nbsp;&nbsp; &nbsp;<br /><b>Up</b>: Play<br /><b>Down</b>: Stop <br /><b
          >Right</b
        >: Next Song<br /><b>Left</b>: Previous Song<br /><br />Song0 is a silence song.&nbsp; It is not
        selectable.&nbsp; headers.asm "plays" song0 to stop the music when you press down.&nbsp; See
        song0.i to find out how it works.<br />Song1 is an evil sounding series of minor thirds.<br />Song2
        is a short sound effect on the Sq2 channel.&nbsp; It uses the SFX_1 stream.&nbsp; Try playing it
        over the other songs to see how it steals the channel from the music.<br />Song3 is a simple
        descending chord progression.<br /><br />Try creating your own songs and sound effects and add
        them into the mix.&nbsp; To add a new song you will need to take the following steps:<br /><br />1)
        create a song header and song data (use the included songs as reference).&nbsp; Note that data
        streams are terminated with $FF<br />2) add your header to the song_headers pointer table at the
        bottom of sound_engine.asm<br />3) update the constant NUM_SONGS to reflect the new song number
        total (also at the bottom of sound_engine.asm)<br /><br />Although not necessary, I recommend
        keeping your song data in a separate file like I've done with song0.i, song1.i, song2.i and
        song3.i.&nbsp; This makes it easier to find the data if you need to edit your song later.&nbsp;
        If you do this, don't forget to .include your file.<br /><br /><b>Next Week</b>:
        <a
          href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=24885"
          target="_blank"
          original-href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=24885"
          >Timing, Note Lengths, Buffering and Rests</a
        ><br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-5__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23452"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-6">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">
          Nerdy Nights Sound: Part 6: Tempo, Note Lengths, Buffering and Rests
        </h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23452"
          target="_blank"
          original-href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=23452"
          >Sound Data, Pointer Tables and Headers</a
        ><br /><br /><b>This Week</b>: Tempo, Note Lengths, Buffering and Rests<br /><br /><b
          ><font size="4">Timing</font></b
        ><br /><br />Last week we put together a huge chunk of the sound engine.&nbsp; We finally got it
        to play something that resembled a song.&nbsp; But we had big limitations when it came to timing
        and note lengths.&nbsp; We were using a single frame counter to keep time across all 6 streams of
        the sound engine.&nbsp; This is a problem because it imposes the music's speed on our sound
        effects.&nbsp; If you were to use such a system in a real game, your sound effects would speed up
        or slow down whenever you change to a faster or slower song.<br /><br />We also made the mistake
        of advancing the sound engine when our frame counter hit its mark, but skipping it when it
        didn't.&nbsp; What happens if a game event triggers a sound effect one or two frames after the
        counter hits its mark?&nbsp; The sound effect won't start until the next time our counter reaches
        its mark - we have to wait for it!&nbsp; There will be a delay.&nbsp; Not good.<br /><br />Worst
        of all, our frame counter also doesn't allow for variable note lengths.&nbsp; Unless every song
        you write is going to consist of only 32nd notes, this is a problem.&nbsp; It becomes apparent
        then that we need a more complex timing system.<br /><br /><font size="3"><b>Tempo</b></font
        ><br />
        <br />We'll correct the first two problems by ripping out the universal counter and giving each
        stream it's own private counter.&nbsp; We'll also change our method of counting.&nbsp; Our old
        method of counting frames and taking action when we reach a certain number is very limited.&nbsp;
        For example, let's say that we have a song and our frame counter is taking action every 4
        frames.&nbsp; Maybe the song sounds a tad faster than we want, so we slow it down by changing the
        speed to update once every 5 frames.&nbsp; But now the song sounds too slow.&nbsp; The speed we
        really want is somewhere in between 4 and 5, but we can't get there with our frame counting
        method.&nbsp; Instead we'll use a ticker.<br /><br /><b>Ticker</b><br />The ticker method
        involves taking a number (a <b>tempo</b>) and adding it to a total, frame by frame.&nbsp;
        Eventually, that total will wraparound from FF-&gt;00 and when it does the carry flag will be set
        (a <b>tick</b>).&nbsp; This carry flag tick will be the signal we look for to advance our
        stream.<br /><br />For example, let's say our tempo value is $40 and our total starts at
        $00.&nbsp; After one frame we will add our tempo to the total.&nbsp; $00 + $40 = $40.&nbsp; Now
        our total is $40.&nbsp; Another frame goes by (2).&nbsp; We add our tempo to the total
        again.&nbsp; $40 + $40 = $80.&nbsp; Our total is $80.&nbsp; Another frame goes by (3).&nbsp; $80
        + $40 = $C0.&nbsp; Another frame goes by (4).&nbsp; $C0 + $40 = $00.&nbsp; Carry flag is
        set.&nbsp; TICK!&nbsp; A tick tells us that it is time to advance this stream.&nbsp; When we
        finish updating, we start adding again until we get another tick.<br /><br />As you can see, a
        tempo value of $40 will advance our stream once every 4 frames.&nbsp; If you do some math (256 /
        5), you will discover that a tempo of $33 will advance the stream roughly every 5 frames.&nbsp;
        If $40 is too fast for your song and $33 is too slow, you still have the values $34-$39 to
        experiment with.&nbsp; Much more versatile!&nbsp; To see why this works, let's see what happens
        with a tempo value of say $36:<br /><br /><span style="font-family: Courier New"
          >$00 + $36 + $36 + $36 + $36 + $36 = $0E (Tick in 5 frames)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$0E + $36 + $36 + $36 + $36 + $36 = $1C (Tick in 5 frames)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$1C + $36 + $36 + $36 + $36&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = $02 (Tick in 4 frames)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$02 + $36 + $36 + $36 + $36 + $26 = $10 (Tick in 5 frames)</span
        ><br /><br />A tempo of $36 produces a tick every 5 frames most of the time, but sometimes it
        only takes 4 frames.&nbsp; You might think that this disparity would make our song sound uneven,
        but really a single frame only lasts about 1/60 of a second.&nbsp; Our ears won't notice.&nbsp;
        It will sound just right to us.<br /><br />Here is some code that demonstrates how to implement a
        ticker:<br /><br /><span style="font-family: Courier New"
          >stream_tempo .rs 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;the value to add to
          our ticker total each frame</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_ticker_total .rs 6&nbsp;&nbsp; ;our running ticker total.</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >sound_play_frame:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_disable_flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .done&nbsp;&nbsp; ;if disable flag is set, don't advance a frame</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop: </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #$01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .endloop&nbsp;&nbsp;&nbsp; ;if stream disabled, skip this stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;add the tempo to the ticker total.&nbsp; If there is a FF-&gt; 0
          transition, there is a tick</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">lda stream_ticker_total, x</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; adc stream_tempo, x</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta stream_ticker_total, x</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bcc .endloop&nbsp;&nbsp;&nbsp; ;carry clear = no tick. if no tick, we are
          done with this stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_fetch_byte&nbsp;&nbsp; ;else there is a tick, so do stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do more stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.endloop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inx</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpx #$06</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Initializing</b><br />Anytime we add a new feature to our
        sound engine we will want to ask ourselves the following questions:<br /><br />1) Is this a
        feature that needs to be initialized for each song/sfx?<br />2) If so, are the values we use to
        initialize the feature variable (ie, not necessarily the same for every song/sfx)?<br /><br />If
        the answer to question #1 is yes, we will have to update sound_load to initialize the feature.<br />If
        the answer to question #2 is also yes, we will have to add a field to the song header
        format.&nbsp; The values to plug into the initialization are different for each song, so the
        songs' headers will need to provide those values for us.<br /><br />In the case of our new timing
        scheme, we have two variables that need to be initialized: sound_ticker_total and
        sound_tempo.&nbsp; Of the two, only sound_tempo will be variable.&nbsp; Different songs will have
        different tempos, but they won't need to have different starting sound_ticker_totals.&nbsp; So we
        will have to add one new field to our song header format for tempo:<br /><br /><span
          style="font-family: Courier New"
          >main header:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >byte #&nbsp; | what it tells us</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | number of streams</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >01+&nbsp;&nbsp;&nbsp;&nbsp; | stream headers (one for each stream)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >stream headers:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >byte #&nbsp; | what it tells us</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | which stream (stream number)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | status byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | which channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | initial volume (and duty for squares)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >04-05&nbsp;&nbsp; | pointer to data stream</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0)"
          >06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | initial tempo</span
        ><br /><br />Then we will need to edit sound_load to read this new byte for each stream and store
        it in RAM.&nbsp; We'll also want to initialize stream_ticker_total to some fixed starting value,
        preferably a high one so that the first tick will happen without a delay.&nbsp; Finally, we will
        have to update all of our songs to include tempos in their headers.<br /><br /><font size="4"
          ><b>Note Lengths</b></font
        ><br /><br />We still have the problem of note lengths.&nbsp; Songs are made up of notes of
        variable length: quarter notes, eighth notes, sixteenth notes, etc.&nbsp; Our sound engine needs
        to be able to differentiate between different note lengths.&nbsp; But how?&nbsp; We will use note
        length counters.<br /><br /><b>Note Length Counters</b><br />Think of the fastest note you'd ever
        need to play, say a 32nd note.&nbsp; Since that will be our fastest note, we'll give it the
        smallest count possible: $01.&nbsp; The next fastest note is a 16th note.&nbsp; In music, a 16th
        note equals two 32nd notes.&nbsp; In other words, a 16th note lasts twice as long as a 32nd
        note.&nbsp; So we will give it a count value that is twice the count value of our 32nd note:
        $02.&nbsp; The next fastest note is an 8th note.&nbsp; An 8th note equals two 16th notes.&nbsp;
        It is twice as long as a 16th note.&nbsp; So its count value will be twice that of the 16th note:
        $04.&nbsp; Going all the way up to a whole note, we can produce a lookup table like this:<br /><br /><span
          style="font-family: Courier New"
          >note_length_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp; ;32nd note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $02&nbsp;&nbsp; ;16th note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $04&nbsp;&nbsp; ;8th note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $08&nbsp;&nbsp; ;quarter note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $10&nbsp;&nbsp; ;half note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $20&nbsp;&nbsp; ;whole note</span
        ><br />&nbsp;&nbsp; &nbsp;<br />We'll add more entries later for things like dotted quarter
        notes, but for now this is sufficient to get us started.<br /><br />To play different note
        lengths, we will give each stream a note length counter:<br /><br /><span
          style="font-family: Courier New"
          >stream_note_length_counter .rs 6</span
        ><br /><br />When a note is played, for example an 8th note, its count value will be pulled from
        the note_length_table and stored in the stream's note length counter.&nbsp; Then every time a
        tick occurs we will decrement the counter.&nbsp; When the note length counter reaches 0, it will
        signal to us that our note has finished playing and it is time for the next note.&nbsp; To say it
        another way, a note's count value is simply how many ticks it lasts.&nbsp; An eighth note is 4
        ticks long.&nbsp; A quarter note is 8 ticks long.&nbsp; A half note is 16 ticks long ($10).<br /><br /><b
          >Note Lengths in Data</b
        ><br />Now we need to add note lengths to our sound data.&nbsp; Recall that we specified that
        byte values in the range of $80-$9F were note lengths:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if
          &lt; #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note length stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note stuff</span
        ><br />&nbsp;&nbsp; &nbsp;<br />So the first byte value that we can use for note lengths is
        $80.&nbsp; We are going to be reading from a lookup table (note_length_table above), so we should
        assign the bytes in the same order as the lookup table. <br /><br /><span
          style="font-family: Courier New"
          >-----+--------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >byte | note length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >-----+--------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$80&nbsp; | 32nd note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$81&nbsp; | 16th note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$82&nbsp; | 8th note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$83&nbsp; | quarter note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$84&nbsp; | half note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >$85&nbsp; | whole note</span
        ><br /><br />Now we can use these values in our sound data to represent note lengths:<br /><br /><span
          style="font-family: Courier New"
          >;music data for song 0, square 1 channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">song0_sq1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $82, C3 ;play a C eighth note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $84, D5 ;play a D half note</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Of course, memorizing which byte value corresponds to which note
        length is a pain.&nbsp; Let's create some aliases to make it easier on us when we are creating
        our sound data:<br /><br /><span style="font-family: Courier New">;note length constants</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >thirtysecond = $80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sixteenth = $81</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">eighth = $82</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >quarter = $83</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">half = $84</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">whole = $85</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >song0_sq1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth, C3&nbsp;&nbsp;&nbsp; ;play a C eighth note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte half, D5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;play a D half note</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Pulling from the table</b><br />There is a small problem
        here.&nbsp; Lookup tables index from 0.&nbsp;&nbsp; This wasn't a problem for note values (C5,
        D3, G6) because our note range started from 0 ($00-$7f).&nbsp; But our note length data has a
        range of $80-$9F.&nbsp; Somehow we will need to translate the note length byte that comes from
        the data stream into a number we can use to index into our table.&nbsp; In other words, we need
        to figure out a way to turn $80 into $00, $81 into $01, $82 into $02, etc.&nbsp; Anything come to
        mind?<br /><br />If you thought "just subtract $80 from the note length value", give yourself a
        cookie.&nbsp; If you thought "just chop off the 7-bit", give yourself two cookies.&nbsp; Both
        solutions work, but the second solution is a little bit faster and only takes one instruction to
        perform:<br /><br /><span style="font-family: Courier New">se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.fetch:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if
          &lt; #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note length stuff</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; and #%01111111&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;chop
          off bit7</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save Y
          because we are about to destroy it</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda note_length_table, y&nbsp;&nbsp;&nbsp; ;get the note length count
          value</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta stream_note_length_counter, x&nbsp;&nbsp; ;stick it in our note length
          counter</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;restore
          Y</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;set index to next byte in the stream</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; jmp
          .fetch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;fetch
          another byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note stuff</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Notice that we jump back up to .fetch after we set the note
        length counter.&nbsp; This is so that we can read the note that will surely follow the note
        length in the data stream.&nbsp; If we simply stop after setting the note length, we'll know how
        long to play, but we won't know which note to play!<br /><br />Here's an updated sound_play_frame
        routine that implements both the ticker and the note length counters.&nbsp; Notice how the note
        length counter is only decremented when we have a tick, and we only advance the stream when the
        note length counter reaches zero:<br /><br /><span style="font-family: Courier New"
          >sound_play_frame:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_disable_flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .done&nbsp;&nbsp; ;if disable flag is set, don't advance a frame</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop: </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #$01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .endloop&nbsp;&nbsp;&nbsp; ;if stream disabled, skip this stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;add the tempo to the ticker total.&nbsp; If there is a FF-&gt; 0
          transition, there is a tick</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ticker_total, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_tempo, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ticker_total, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .endloop&nbsp;&nbsp;&nbsp; ;carry clear = no tick.&nbsp; if no tick, we
          are done with this stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >dec stream_note_length_counter, x&nbsp;&nbsp; ;else there is a tick. decrement the note
            length counter</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne .endloop&nbsp;&nbsp;&nbsp; ;if counter is non-zero, our note isn't
          finished playing yet</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_fetch_byte&nbsp;&nbsp; ;else our note is finished.&nbsp; Time to
          read from the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do more stuff. set volume, note, sweep, etc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.endloop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inx</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpx #$06</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br /><br />We have one last change to make.&nbsp; When we load a new song we will want it to
        start playing immediately, so we should initialize the stream_note_length_counter in the
        sound_load routine to do just that.&nbsp; Our sound_play_frame routine decrements the counter and
        takes action if the result is zero.&nbsp; Therefore, to ensure that our song starts immediately,
        we should initialize our stream_note_length_counter to $01:<br />&nbsp;&nbsp; &nbsp;<br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;somewhere inside the loop of sound_load</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_length_counter, x</span
        ><br />&nbsp;&nbsp; &nbsp;<br />And now our engine supports note lengths.&nbsp; But there is
        still room for improvement.&nbsp; What if we want to play a series of 8th notes?&nbsp; Not an
        uncommon thing to have in music.&nbsp; Here is how our data would have to look now:<br /><br /><span
          style="font-family: Courier New"
          >sound_data:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth, C5, eighth, E5, eighth, G5, eighth, C6, eighth, E6, eighth,
          G6, eighth, C7 ;Cmajor</span
        ><br />&nbsp;&nbsp; &nbsp;<br />That's a lot of "eighth" bytes.&nbsp; Wouldn't it be better to
        just state "eighth" once, and assume that all notes following it are eighth notes?&nbsp; Like
        this:<br /><br /><span style="font-family: Courier New">sound_data:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth, C5, E5, G5, C6, E6, G6, C7 ;Cmajor</span
        ><br />&nbsp;&nbsp; &nbsp;<br />That saved us 6 bytes of ROM space.&nbsp; And if you consider
        that a game may have 20+ songs, each with 4 streams of data, each with potentially several
        strings of equal-length notes, this kind of change might save us hundreds, maybe even thousands
        of bytes!&nbsp; Let's do it.<br /><br />To pull this off, we will have to store the current note
        length count value in RAM.&nbsp; Then when our note length counter runs to 0, we will refill it
        with our RAM count value.<br /><br /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >stream_note_length .rs 6&nbsp;&nbsp;&nbsp; ;note length count value</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >;-------</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.fetch:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if
          &lt; #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note length stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%01111111&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;chop
          off bit7</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save Y
          because we are about to destroy it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_length_table, y&nbsp;&nbsp;&nbsp; ;get the note length count
          value</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >sta stream_note_length, x&nbsp;&nbsp; ;save the note length in RAM so we can use it to
            refill the counter</span
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_length_counter, x&nbsp;&nbsp; ;stick it in our note length
          counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;restore
          Y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;set index to next byte in the stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp
          .fetch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;fetch
          another byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">;--------</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >sound_play_frame:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_disable_flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .done&nbsp;&nbsp; ;if disable flag is set, don't advance a frame</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop: </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #$01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .endloop&nbsp;&nbsp;&nbsp; ;if stream disabled, skip this stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;add the tempo to the ticker total.&nbsp; If there is a FF-&gt; 0
          transition, there is a tick</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ticker_total, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_tempo, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ticker_total, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .endloop&nbsp;&nbsp;&nbsp; ;carry clear = no tick.&nbsp; if no tick, we
          are done with this stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dec stream_note_length_counter, x&nbsp;&nbsp; ;else there is a tick.
          decrement the note length counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .endloop&nbsp;&nbsp;&nbsp; ;if counter is non-zero, our note isn't
          finished playing yet</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >lda stream_note_length, x&nbsp;&nbsp; ;else our note is finished. reload the note length
            counter</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta stream_note_length_counter, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_fetch_byte&nbsp;&nbsp; ;Time to read from the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do more stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.endloop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inx</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpx #$06</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Adding those 4 lines of code just saved us hundreds of bytes of
        ROM space.&nbsp; A nice tradeoff for 6 bytes of RAM.&nbsp; Now our data will be made up of
        "strings", where we have a note length followed by a series of notes:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">sound_data:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth, C5, E5, G5, C6, E6, G6, quarter, C6 ;six 8th notes and a
          quarter note</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Easy to read and easy to write.<br /><b
          ><br />
          Other Note Lengths</b
        ><br />Now that everything is setup, we can add more note lengths to our note_length_table.&nbsp;
        Dotted notes are very common in music.&nbsp; Dotted notes are equal in length to the note plus
        the next fastest note.&nbsp; For example, a dotted quarter note = a quarter note + an 8th
        note.&nbsp; A dotted 8th note = an 8th note + a 16th note.&nbsp; Let's add some dotted notes to
        our table:<br /><br />note_length_table:<br />&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp; ;32nd
        note<br />&nbsp;&nbsp;&nbsp; .byte $02&nbsp;&nbsp; ;16th note<br />&nbsp;&nbsp;&nbsp; .byte
        $04&nbsp;&nbsp; ;8th note<br />&nbsp;&nbsp;&nbsp; .byte $08&nbsp;&nbsp; ;quarter note<br />&nbsp;&nbsp;&nbsp;
        .byte $10&nbsp;&nbsp; ;half note<br />&nbsp;&nbsp;&nbsp; .byte $20&nbsp;&nbsp; ;whole note<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        ;---dotted notes<br />&nbsp;&nbsp;&nbsp; .byte $03&nbsp;&nbsp; ;dotted 16th note<br />&nbsp;&nbsp;&nbsp;
        .byte $06&nbsp;&nbsp; ;dotted 8th note<br />&nbsp;&nbsp;&nbsp; .byte $0C&nbsp;&nbsp; ;dotted
        quarter note<br />&nbsp;&nbsp;&nbsp; .byte $18&nbsp;&nbsp; ;dotted half note<br />&nbsp;&nbsp;&nbsp;
        .byte $30&nbsp;&nbsp; ;dotted whole note?<br />&nbsp;&nbsp; &nbsp;<br />The actual order of our
        note_length_table doesn't matter.&nbsp; We just have to make sure our aliases are in the same
        order as the table:<br /><br /><span style="font-family: Courier New"
          >;note length constants (aliases)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >thirtysecond = $80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sixteenth = $81</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">eighth = $82</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >quarter = $83</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">half = $84</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">whole = $85</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >d_sixteenth = $86</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >d_eighth = $87</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >d_quarter = $88</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">d_half = $89</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >d_whole = $8A&nbsp;&nbsp; ;don't forget we are counting in hex</span
        ><br /><br />Your music will determine what other entries you'll need to add to your note length
        table.&nbsp; If one of your songs has a really really long note, like 3 whole notes tied
        together, add it to the table ($60) and make an alias for it (whole_x3).&nbsp; If your song
        contains a note that is seven 8th notes long (a half note plus a dotted quarter note tied
        together), add it to the table ($1C) and make an alias for it (seven_eighths).<br /><font
          size="4"
          ><b
            ><br />
            Buffering APU Writes</b
          ></font
        ><br />Before, we've been writing to the APU one stream at a time.&nbsp; If two different streams
        shared a channel, they would both write to the same APU ports.&nbsp; If three streams were to
        share a channel, which is possible if there are two different sound effects loaded into SFX_1 and
        SFX_2, all three would write to the same APU ports in the same frame.&nbsp; This is bad
        practice.&nbsp; It can also cause some unwanted noise on the square channels.<br /><br />A better
        method is to buffer our writes.&nbsp; Instead of writing to the APU ports directly, each stream
        will instead write its data to temporary ports in RAM.&nbsp; We'll keep our loop order, so sfx
        streams will still overwrite the music streams.&nbsp; Then when all the streams are done, we will
        copy the contents of our temporary RAM ports directly to the APU ports all at once.&nbsp; This
        ensures that the APU ports only get written to once per frame max.&nbsp; To do this, we first
        need to reserve some RAM space for our temporary port variables:<br /><br /><span
          style="font-family: Courier New"
          >soft_apu_ports .rs 16</span
        ><br /><br />We reserved 16 bytes for our temporary ports.&nbsp; Each one corresponds to an APU
        port:<br /><br /><span style="font-family: Courier New"
          >soft_apu_ports+0&nbsp; -&gt; $4000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;Square 1 ports</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+1&nbsp; -&gt; $4001</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+2&nbsp; -&gt; $4002</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+3&nbsp; -&gt; $4003</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >soft_apu_ports+4&nbsp; -&gt; $4004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;Square 2 ports</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+5&nbsp; -&gt; $4005</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+6&nbsp; -&gt; $4006</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+7&nbsp; -&gt; $4007</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >soft_apu_ports+8&nbsp; -&gt; $4008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;Triangle ports</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+9&nbsp; -&gt; $4009 (unused)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+10 -&gt; $400A</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+11 -&gt; $400B</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >soft_apu_ports+12 -&gt; $400C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;Noise ports</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+13 -&gt; $400D (unused)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+14 -&gt; $400E</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >soft_apu_ports+15 -&gt; $400F</span
        ><br /><br />Let's implement this by working backwards.&nbsp; First we will edit sound_play_frame
        and pull our call to se_set_apu out of the loop.&nbsp; We do this because we only want to write
        to the APU once, after all the streams are done looping:<br /><br /><span
          style="font-family: Courier New"
          >;--------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >; sound_play_frame advances the sound engine by one frame</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_play_frame:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_disable_flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .done&nbsp;&nbsp; ;if disable flag is set, don't advance a frame</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #$01&nbsp;&nbsp;&nbsp; ;check whether the stream is active</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .endloop&nbsp; ;if the channel isn't active, skip it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;add the tempo to the ticker total.&nbsp; If there is a FF-&gt; 0
          transition, there is a tick</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ticker_total, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_tempo, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ticker_total, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .endloop&nbsp;&nbsp;&nbsp; ;carry clear = no tick.&nbsp; if no tick, we
          are done with this stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dec stream_note_length_counter, x&nbsp;&nbsp; ;else there is a tick.
          decrement the note length counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .endloop&nbsp;&nbsp;&nbsp; ;if counter is non-zero, our note isn't
          finished playing yet</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_length, x&nbsp;&nbsp; ;else our note is finished. reload
          the note length counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_length_counter, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_fetch_byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">;snip</span></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.endloop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inx</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpx #$06</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">jsr se_set_apu</span></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Next we will modify se_set_apu to copy the temporary APU ports to
        the real APU ports:<br /><br /><span style="font-family: Courier New">se_set_apu:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$0F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpy #$09</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .skip&nbsp;&nbsp; ;$4009 is unused</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cpy #$0D</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .skip&nbsp;&nbsp; ;$400D is unused</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4000, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.skip:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dey</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl .loop&nbsp;&nbsp; ;stop the loop when Y is goes from $00 -&gt;
          $FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Now we have to write the subroutine that will populate the
        temporary APU ports with a stream's data.&nbsp; This part will get more complicated as we add
        more features to our sound engine, but for now it's quite simple:<br /><br /><span
          style="font-family: Courier New"
          >se_set_temp_ports:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_vol_duty, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports, y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;vol</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$08</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+1, y&nbsp;&nbsp;&nbsp;&nbsp; ;sweep</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+2, y&nbsp;&nbsp;&nbsp;&nbsp; ;period LO</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+3, y&nbsp;&nbsp;&nbsp;&nbsp; ;period HI</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />We will make the call to se_set_temp_ports after our call to
        se_fetch_byte, where the old se_set_apu call was before we snipped it out of the loop.&nbsp;
        Notice that we don't bother to check the channel before writing the sweep.&nbsp; se_set_apu takes
        care of this part for us.&nbsp; There's no harm in writing these values to RAM, so we'll avoid
        branching here to simplify the code.<br /><br /><b>Crackling Sounds</b><br />Writing to the 4th
        port of the Square channels ($4003/$4007) has the side effect of resetting the sequencer.&nbsp;
        If we write here too often, we will get a nasty crackling sound out of our Squares.&nbsp; This is
        not good.<br /><br />The way our engine is setup now, we call se_set_apu once per frame.&nbsp;
        se_set_apu writes to $4003/$4007, so these ports will get written to once per frame.&nbsp; This
        is too often.&nbsp; We need to find a way to write here less often.&nbsp; We will do this by
        cutting out redundant writes.&nbsp; If the value we want to write this frame is the same as the
        value written last frame, skip the write.<br /><br />First we will need to keep track of what was
        last written to the ports.&nbsp; This will require some new variables:<br /><br /><span
          style="font-family: Courier New"
          >sound_sq1_old .rs 1&nbsp; ;the last value written to $4003</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_sq2_old .rs 1&nbsp; ;the last value written to $4007</span
        ><br /><br />Whenever we write to one of these ports, we will also write the value to the
        corresponding sound_port4_old variable.&nbsp; Saving this value will allow us to compare against
        it next frame.&nbsp; To implement this, we will have to unroll our loop in se_set_apu:<br /><br /><span
          style="font-family: Courier New"
          >se_set_apu:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4000</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4001</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_sq1_old&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save the value we
          just wrote to $4003</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.square2:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4004</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+5</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4005</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4006</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+7</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4007</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_sq2_old&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save the value we
          just wrote to $4007</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.triangle:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+8</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+10</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400A</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+11</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400B</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.noise:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+12</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400C</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+14</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400E</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+15</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Now we have a variable that will keep track of the last value
        written to a channel's 4th port.&nbsp; The next step is to add a check before we write:<br /><br /><span
          style="font-family: Courier New"
          >se_set_apu:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4000</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4001</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4002</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >cmp sound_sq1_old&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;compare to last write</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; beq
          .square2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;don't write this
          frame if they were equal</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4003</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_sq1_old&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save the value we
          just wrote to $4003</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.square2:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4004</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+5</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4005</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4006</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+7</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">cmp sound_sq2_old</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; beq .triangle</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4007</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_sq2_old&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save the value we
          just wrote to $4007</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.triangle:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+8</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4008</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+10&nbsp;&nbsp; ;there is no $4009, so we skip it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400A</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+11</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400B</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.noise:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+12</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400C</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+14&nbsp;&nbsp; ;there is no $400D, so we skip it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400E</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda soft_apu_ports+15</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $400F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Finally we have to consider initialization.&nbsp; The only case
        we really have to worry about is the first time a song is played in the game.&nbsp; Consider what
        happens if we initialize the sound_sq1_old and sound_sq2_old variables to $00.&nbsp; We are
        essentially saying that on startup (RESET) the last byte written to $4003/$4007 was a $00, which
        isn't true of course.&nbsp; On startup, no write has ever been made to these ports.&nbsp; If we
        initialize to $00, and if the first note of the first song played has a $00 for the high 3 bits
        of its period, it will get skipped.&nbsp; That is not what we want.&nbsp; Instead, we should
        initialize these variables to some value that will never be written to $4003/$4007, like
        $FF.&nbsp; This ensures that the first note(s) played in the game won't be skipped.<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">sound_init:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$0F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta $4015&nbsp;&nbsp; ;enable Square 1, Square 2, Triangle and Noise
          channels</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_disable_flag&nbsp; ;clear disable flag</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;later, if we have other variables we want to initialize, we will do that
          here.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">lda #$FF</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta sound_sq1_old</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta sound_sq2_old</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">se_silence:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$30</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >sta soft_apu_ports&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;set Square 1 volume to 0</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+4&nbsp;&nbsp;&nbsp; ;set Square 2 volume to 0</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+12&nbsp;&nbsp; ;set Noise volume to 0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >sta soft_apu_ports+8&nbsp;&nbsp;&nbsp;&nbsp; ;silence Triangle</span
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><font size="4"><b>Rests</b></font
        ><br /><br />The final topic we will cover this lesson is rests.&nbsp; A <b>rest</b> is a period
        of silence in between notes.&nbsp; Like notes, rests can be of variable length: quarter rest,
        half rest, whole rest, etc.&nbsp; In other words a rest is a silent note.<br /><br />So how will
        we implement it?&nbsp; We will handle rests by considering a rest to be special case note.&nbsp;
        We will give the rest a dummy period in our note table.&nbsp; Then, when we fetch a byte from the
        data stream and determine the byte to be a note, we will add an extra check to see if that note
        is a rest.&nbsp; If it is, we will make sure that it shuts up the stream.<br /><br />First let's
        add the rest to our note table.&nbsp; We will give it a dummy period.&nbsp; It doesn't really
        matter what value we use.&nbsp; I'm going to give it a period of $0000.&nbsp; We will also want
        to add the rest to our list of note aliases:<br /><br /><span style="font-family: Courier New"
          >note_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word $07F1, $0780, etc...</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;....more note table values here</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.word $0000 ;rest.&nbsp; Last entry</span></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;Note: octaves in music traditionally start at C, not A&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >A1 = $00&nbsp;&nbsp;&nbsp; ;the "1" means Octave 1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >As1 = $01&nbsp;&nbsp; ;the "s" means "sharp"</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >Bb1 = $01&nbsp;&nbsp; ;the "b" means "flat"&nbsp; A# == Bb, so same value</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">B1 = $02</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;..... other aliases here</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">F9 = $5c</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">Fs9 = $5d</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">Gb9 = $5d</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >rest = $5e</span
        ><br /><br />Now we can use the symbol "rest" in our music data.&nbsp; "rest" will evaluate to
        the value $5E, which falls within our note range ($00-$7F).&nbsp; When our sound engine
        encounters a $5E in the data stream, it will pull the period ($0000) from the note table and
        store it in RAM.&nbsp; A period of $0000 is actually low enough to silence the square channels,
        but the triangle channel is still audible at this period so we have more work to do.<br /><br /><b
          >Checking for a rest</b
        ><br />When we encounter a rest, we will want to tell the sound engine to shut this stream up
        until the next note.&nbsp; The rest functions differently from all the other notes, so we will
        need to make a special check for it in our code.&nbsp; We will make a subroutine se_check_rest to
        do this for us:<br /><br /><span style="font-family: Courier New">se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.fetch:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if
          &lt; #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note Length stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;save our index into the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;restore data stream index</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">;check if it's a rest</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; jsr se_check_rest&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.update_pointer:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tya</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .end</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inc stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.end:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />se_check_rest will check to see if the note value is equal to $5E
        or not.&nbsp; If it is, we will need to tell the sound engine to silence the stream.&nbsp; If the
        note isn't equal to $5E, we can go on our merry way.<br /><br />How will we silence our stream
        then?&nbsp; This is actually a little complicated.&nbsp; Recall that the stream's volume
        (stream_vol_duty) is set in the song's header.&nbsp;&nbsp; se_set_temp_ports copies the value of
        stream_vol_duty to soft_apu_ports.&nbsp; If we have se_check_rest modify the stream_vol_duty
        variable directly (set it to 0 volume), the old volume value disappears.&nbsp; We won't know what
        to restore it to when we are done with our rest.&nbsp; Oh no!<br /><br />What we will want to do
        instead is leave stream_vol_duty alone.&nbsp; We will copy it into soft_apu_ports every frame as
        usual.&nbsp; Then, after the copy we will check to see if we are currently resting.&nbsp; If we
        are, we will make another write soft_apu_ports with a value that will set the volume to 0.&nbsp;
        Make sense?<br /><br /><b>stream_status</b><br />To do this we will need to keep track of our
        resting status in a variable.&nbsp; If our sound engine encounters a $5E in the data stream,
        we'll turn our resting status on.&nbsp; If it's not, we'll turn our resting status off.&nbsp;
        There are only two possibilities: on or off.&nbsp; Rather than declare a whole new block of
        variables and waste six bytes of RAM, let's assign one of the bits in our stream_status variable
        to be our rest indicator:<br /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >Stream Status Byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |+- Enabled (0: stream disabled; 1: enabled)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +-- Rest (0: not resting; 1: resting)</span
        ><br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />Our new subroutine se_check_rest will be in charge of
        setting or clearing this bit of the status byte:<br /><br /><span
          style="font-family: Courier New"
          >se_check_rest:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp; ;read the note byte again</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #rest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;is
          it a rest? (==$5E)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .not_rest</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ora #%00000010&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if so, set the rest bit in
          the status byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .store&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this will
          always branch.&nbsp; bne is cheaper than a jmp.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.not_rest:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%11111101&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;clear the rest bit in the
          status byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.store:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Then we modify se_set_temp_ports to check the rest bit and
        silence the stream if it is set:<br /><br /><span style="font-family: Courier New"
          >se_set_temp_ports:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_vol_duty, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports, y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;vol</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$08</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+1, y&nbsp;&nbsp;&nbsp;&nbsp; ;sweep</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+2, y&nbsp;&nbsp;&nbsp;&nbsp; ;period LO</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+3, y&nbsp;&nbsp;&nbsp;&nbsp; ;period HI</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >;check the rest flag. if set, overwrite volume with silence value
          </span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; and #%00000010</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; beq .done&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if clear, no rest, so
          quit</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; cmp #TRIANGLE&nbsp;&nbsp; ;if triangle, silence with #$80</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; beq .tri&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda #$30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else, silence with
          #$30</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne .store&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this will always branch.&nbsp;
          bne is cheaper than a jmp.</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >.tri:</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda #$80</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >.store:&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />That's it.&nbsp; Now our engine supports rests!&nbsp; They work
        just like notes, so their lengths are controlled with note lengths:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New"
          >song_data:&nbsp; ;this data has two quarter rests in it.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte half, C2, quarter, rest, eighth, D4, C4, quarter, B3, rest</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Putting It All Together</b><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/tempo.zip"
          target="_blank"
          original-href="http://tummaigames.com/tempo.zip"
          >tempo.zip</a
        >
        sample files.&nbsp; Make sure the following files are in the same folder as NESASM3:<br /><br />&nbsp;&nbsp;&nbsp;
        tempo.asm<br />&nbsp;&nbsp;&nbsp; sound_engine.asm<br />&nbsp;&nbsp;&nbsp; tempo.chr<br />&nbsp;&nbsp;&nbsp;
        note_table.i<br />&nbsp;&nbsp;&nbsp; note_length_table.i<br />&nbsp;&nbsp;&nbsp; song0.i<br />&nbsp;&nbsp;&nbsp;
        song1.i<br />&nbsp;&nbsp;&nbsp; song2.i<br />&nbsp;&nbsp;&nbsp; song3.i<br />&nbsp;&nbsp;&nbsp;
        song4.i<br />&nbsp;&nbsp;&nbsp; song5.i<br />&nbsp;&nbsp;&nbsp; tempo.bat<br /><br />Double click
        tempo.bat. That will run NESASM3 and should produce the tempo.nes file. Run that NES file in
        FCEUXD SP.<br /><br />Use the controller to select songs and play them.&nbsp; Controls are as
        follows:<br />&nbsp;&nbsp; &nbsp;<br /><b>Up</b>: Play<br /><b>Down</b>: Stop <br /><b>Right</b>:
        Next Song/SFX<br /><b>Left</b>: Previous Song/SFX<br /><br />Song0 is a silence song.&nbsp; Not
        selectable.&nbsp; tempo.asm "plays" song0 to stop the music when you press down.&nbsp; See
        song0.i to find out how it works.<br />Song1 is last week's evil sounding series of minor thirds,
        but much faster now thanks to tempo settings.<br />Song2 is the same short sound effect from last
        week.<br />Song3 is a simple descending chord progression.&nbsp; We saved some bytes in the
        triangle data using note lengths (compare to last week's file)<br />Song4 is a new song that
        showcases variable note lengths and rests.<br />Song5 is a short sound effect.&nbsp; It plays 10
        notes extremely fast.&nbsp; Play it over songs and see how it steals the SQ2 channel from the
        music.<br /><br />Try creating your own songs and sound effects and add them into the mix.&nbsp;
        To add a new song you will need to take the following steps:<br /><br />1) create a song header
        and song data (use the included songs as reference).&nbsp; Don't forget to add tempos for each
        stream in your header.&nbsp; Data streams are terminated with $FF.<br />2) add your header to the
        song_headers pointer table at the bottom of sound_engine.asm<br />3) update the constant
        NUM_SONGS to reflect the new song number total (also at the bottom of sound_engine.asm)<br /><br />Although
        not necessary, I recommend keeping your song data in a separate file like I've done with song0.i,
        song1.i, song2.i and song3.i.&nbsp; This makes it easier to find the data if you need to edit
        your song later.&nbsp; If you do this, don't forget to .include your file.<br /><br /><b
          >Next Week</b
        >:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25253"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25253"
          >Volume Envelopes</a
        ><br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-6__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=24885"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-7">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Nerdy Nights Sound: Part 7: Volume Envelopes</h2>
      </div>
      <div class="mdl-card__supporting-text">
        <span style="font-weight: bold">Last Week:</span>
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=24885"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=24885"
          >Tempo, Note Lengths, Buffering and Rests</a
        ><br /><br /><span style="font-weight: bold">This Week</span>: Volume Envelopes<br /><font
          size="4"
          ><b><br />Volume Envelopes</b></font
        ><br /><br />This week we will add volume envelopes to our engine.&nbsp; A
        <span style="font-weight: bold">volume envelope</span> is a series of volume values that are
        applied to a note one frame at a time.&nbsp; For example, if we had a volume envelope that looked
        like this:<br /><br /><span style="font-family: Courier New">F E D C 9 5 0</span><br /><br />Then
        whenever we played a note, it would have a volume of F on the first frame, a volume of E on the
        second frame, then D, then C, then 9, then 5 until it is finally silenced with a volume of 0 on
        the 7th frame.&nbsp; Applying this volume envelope on our notes would give them a sharp, short
        staccato feel.&nbsp; Conversely, if we had a volume envelope that looked like this:<br /><br /><span
          style="font-family: Courier New"
          >1 1 2 2 3 3 4 4 7 7 8 8 A A C C D D E E F F F</span
        ><br /><br />Each note would start very quietly and fade in to full volume.&nbsp; Look at this
        volume envelope:<br /><br /><span style="font-family: Courier New"
          >D D D C B 0 0 0 0 0 0 0 0 6 6 6 5 4 0</span
        ><br /><br />Here we start at a high volume (D) and let it ring for 5 frames.&nbsp; Then we
        silence the note for 8 frames.&nbsp; Then the note comes back at a very low volume for 5
        frames.&nbsp; Notes using this volume envelope would sound like they had an faint echo.<br /><br />As
        you can see, volume envelopes are pretty cool.&nbsp; We can get a lot of different sounds out of
        them.&nbsp; Let's add them in.<br /><br /><b>Channels</b><br />Volume envelopes are best suited
        for the square and noise channels where we have full control of the volume.&nbsp; The triangle
        channel on the other hand doesn't allow much volume control.&nbsp; It only has two settings: full
        blast and off.&nbsp; We can still apply volume envelopes in a limited way though.&nbsp; Consider
        these two volume envelopes:<br /><br /><span style="font-family: Courier New"
          >0F 0E 0D 0C 09 05 00</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >04 04 05 05 06 06 07 07 08 08 09 09 0A 0A 00</span
        ><br /><br />These two envelopes would have a vastly different sound on the square channels, but
        to the triangle they look like this:<br /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >On On On On On On Off</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >On On On On On On On On On On On On On On Off</span
        ><br /><br />You don't get the subtle shifts in volume, but you do get a different length.&nbsp;
        We can use volume envelopes that end in 00 to control when the triangle key-off occurs.&nbsp; Not
        as cool as full volume control, but still useful.<br /><br /><b>Defining volume envelopes</b
        ><br />First let's define some volume envelopes so we have some data to work with.&nbsp; We'll
        use some of the examples from above:<br /><br /><span style="font-family: Courier New"
          >se_ve_1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $0F, $0E, $0D, $0C, $09, $05, $00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">se_ve_2:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01, $01, $02, $02, $03, $03, $04, $04, $07, $07</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $08, $08, $0A, $0A, $0C, $0C, $0D, $0D, $0E, $0E</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $0F, $0F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">se_ve_3:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $0D, $0D, $0D, $0C, $0B, $00, $00, $00, $00, $00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $00, $00, $00, $00, $06, $06, $06, $05, $04, $00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $FF</span
        ><br /><br />Notice that I terminated each envelope with $FF.&nbsp; We need some terminator value
        so the engine will know when we've reached the end of the envelope.&nbsp; We could have used any
        value, but $FF is pretty common.<br /><br />Next we will make a pointer table that holds the
        addresses of our volume envelopes:<br /><br /><span style="font-family: Courier New"
          >volume_envelopes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_ve_1, se_ve_2, se_ve_3</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Declaring variables</b><br />In order to apply a volume
        envelope to a particular stream, we will need a variable that tells us which one to use.&nbsp; We
        will also need an index variable that tells us our current position within the volume
        envelope:<br /><br /><span style="font-family: Courier New"
          >stream_ve .rs 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;current volume envelope</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >stream_ve_index .rs 6&nbsp;&nbsp; ;current position within the volume envelope</span
        ><br /><br />stream_ve will tell us which volume envelope to use.&nbsp; Code-wise, it will act as
        an index into our pointer table so we know where to read from.&nbsp; Sound familiar?&nbsp; It
        works the same way as "song number" did for loading a song.&nbsp; We aren't there yet, but here's
        a peek at how we will use these variables to read from the volume envelopes. (x holds the stream
        number):<br /><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty
          sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save y
          because we are about to destroy it.</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ve,
          x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which volume
          envelope?</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 2 because we are indexing into a table of addresses (words)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda volume_envelopes, y&nbsp;&nbsp;&nbsp;&nbsp; ;get the low byte of the
          address from the pointer table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda volume_envelopes+1, y&nbsp;&nbsp; ;get the high byte of the
          address</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy stream_ve_index, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;our current position
          within the volume envelope.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;grab the value.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;check against $FF (our termination value)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;set the volume</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;increment stream_ve_index</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;etc</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Compare this code to the beginning of the sound_load
        routine.&nbsp; Are you starting to see a pattern?<br />&nbsp;&nbsp; &nbsp;<br /><b
          >Initializing</b
        ><br />Whenever we add a new feature, we need to consider how we should initialize it.&nbsp;
        Every stream in our music data will potentially have a different volume envelope, so we should
        add a volume envelope field to our header.&nbsp; Volume envelopes will deprecate our old "initial
        volume" field, but we will still need to have duty cycle info, so we'll just rename that
        field:<br /><br /><span style="font-family: Courier New">main header:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >byte #&nbsp; | what it tells us</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | number of streams</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >01+&nbsp;&nbsp;&nbsp;&nbsp; | stream headers (one for each stream)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >stream headers:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >byte #&nbsp; | what it tells us</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >--------+----------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | which stream (stream number)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | status byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | which channel</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | initial duty (for triangle, set the 7bit)</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | volume envelope</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >05-06&nbsp;&nbsp; | pointer to data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | initial tempo</span
        ><br /><br />To read this data from the header, we will have to insert the following code into
        our sound_load routine (after reading the duty):<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;the stream's volume
          envelope</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ve, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Notes will always start from the beginning of the volume
        envelope, so we can just initialize stream_ve_index to 0:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ve_index, x</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Now we just need to make sure to assign volume envelopes to all
        the streams in our song data and we're ready to go:<br /><br /><span
          style="font-family: Courier New"
          >song5_header:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;1
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte SFX_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;status byte (stream enabled)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte SQUARE_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;initial duty (01).&nbsp; Initial volume deprecated.</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .byte $00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;the
          first volume envelope (se_ve_1)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song5_square2 ;pointer to stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;tempo..very fast tempo</span
        ><br /><br />Remember that you can always create descriptive aliases for your volume envelopes if
        you don't want to remember which number is which:<br /><br /><span
          style="font-family: Courier New"
          >;volume envelope aliases</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >ve_short_staccato = $00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >ve_fade_in = $01</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >ve_blip_echo = $02</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >song5_header:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;1
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte SFX_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;status byte (stream enabled)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte SQUARE_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $7F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;initial duty (01).&nbsp; Initial volume deprecated.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          <span style="color: rgb(255, 0, 0)">ve_short_staccato</span>&nbsp;&nbsp; ;the first volume
          envelope (se_ve_1)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song5_square2 ;pointer to stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;tempo..very fast tempo</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Using aliases is a good idea because the assembler will give you
        an error if you mistype your alias.&nbsp; If you mistype your number, and it is still a valid
        number, the assembler won't know there's a problem and will assemble it.&nbsp; This kind of bug
        in your data can be hard to trace.<br /><br /><br /><font size="3"
          ><b>Implementing Volume Envelopes</b></font
        ><br /><br />To implement volume envelopes, we need to modify the code where we set the
        volume.&nbsp; Instead of using a fixed value like we were doing before, we need to read from our
        current position in the volume envelope and use that value instead.&nbsp; Our volume code is
        starting to get a little complicated, so let's pull it out into its own subroutine.&nbsp; This
        will make our code easier to follow:<br /><br /><span style="font-family: Courier New"
          >;----------------------------------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >; se_set_temp_ports will copy a stream's sound data to the temporary apu variables</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; input:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; X: stream number</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >se_set_temp_ports:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >jsr se_set_stream_volume&nbsp;&nbsp;&nbsp; ;let's stick all of our volume code into a new
            subroutine</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;less cluttered that way</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$08</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+1, y&nbsp;&nbsp;&nbsp;&nbsp; ;sweep</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+2, y&nbsp;&nbsp;&nbsp;&nbsp; ;period LO</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports+3, y&nbsp;&nbsp;&nbsp;&nbsp; ;period HI</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts&nbsp;&nbsp; &nbsp;</span
        ><br /><br />What should our new subroutine se_set_stream_volume do?&nbsp; First it needs to read
        a value from our stream's volume envelope.&nbsp; Then it needs to modify the stream's volume
        using that value.&nbsp; Then we need to update our position within the volume envelope.&nbsp;
        Finally it needs to check to see if we are resting, and silence the stream if we are (we wrote
        this code last week).&nbsp; It looks something like this (new code in red):<br /><br /><br /><span
          style="font-family: Courier New"
          >se_set_stream_volume:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            ;save our index into soft_apu_ports (we are about to destroy y)</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda stream_ve,
          x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which volume
          envelope?</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 2 because we are indexing into a table of addresses (words)</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda volume_envelopes, y&nbsp;&nbsp;&nbsp;&nbsp; ;get the low byte of the
          address from the pointer table</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta
          sound_ptr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;put it into our pointer variable</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda volume_envelopes+1, y&nbsp;&nbsp; ;get the high byte of the
          address</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >.read_ve:</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; ldy stream_ve_index, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;our current position
          within the volume envelope.</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;grab the value.</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; cmp #$FF</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne
          .set_vol&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if not FF, set the volume</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; dec stream_ve_index, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if FF, go back
          one and read again</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; jmp
          .read_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp; FF essentially tells us to repeat the last</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp; volume value for the remainder of the note</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >.set_vol:</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta
          sound_temp2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save our
          new volume value (about to destroy A)</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda stream_vol_duty, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;get current vol/duty
          settings</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; and
          #$F0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;zero out the old volume</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; ora
          sound_temp2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;OR our new
          volume in.</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><br
          style="font-family: Courier New; color: rgb(255, 0, 0)"
        /><span style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; ldy
          sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;get our
          index into soft_apu_ports</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports, y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;store the volume
          in our temp port</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; inc stream_ve_index, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;set our volume
          envelop index to the next position</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">.rest_check:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;check the rest flag. if set, overwrite volume with silence value </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%00000010</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq
          .done&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if clear, no rest, so quit</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp
          #TRIANGLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if triangle, silence with #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq
          .tri&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else, silence with #$30</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne
          .store&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;this always branches.&nbsp; bne is cheaper than a jmp</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.store:&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />After we read a value from our volume envelope, we AND
        stream_vol_duty with #$F0.&nbsp; This has the nice effect of clearing the old volume while
        preserving our squares' duty cycle settings.&nbsp; But we need to be careful here.&nbsp; Recall
        that the triangle channel's on/off status is controlled by the low 7 bits of the port:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">TRI_CTRL ($4008)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">||||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|+++++++- Value</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >+-------- Control Flag (0: use internal counters; 1: disable internal counters)</span
        ><br /><br />If any of those Value bits are set, the triangle channel will be considered
        on.&nbsp; Consider what happens if bit 4, 5 or 6 happen to be set.&nbsp; In this case, ANDing
        with #$F0 won't turn the triangle channel off.&nbsp; If the volume we pull from the volume
        envelope is 0, it won't silence our triangle channel because bit 4, 5 or 6 will still be
        set.&nbsp; If we are careful not to set these bits in our song headers, the problem should never
        come up.&nbsp; But for completeness we should fix it:<br /><br /><span
          style="font-family: Courier New"
          >se_set_stream_volume:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty
          sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save our
          index into soft_apu_ports (we are about to destroy y)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ve,
          x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which volume
          envelope?</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 2 because we are indexing into a table of addresses (words)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda volume_envelopes, y&nbsp;&nbsp;&nbsp;&nbsp; ;get the low byte of the
          address from the pointer table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta
          sound_ptr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;put it into our pointer variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda volume_envelopes+1, y&nbsp;&nbsp; ;get the high byte of the
          address</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.read_ve:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy stream_ve_index, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;our current position
          within the volume envelope.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;grab the value.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne
          .set_vol&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if not FF, set the volume</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dec stream_ve_index, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if FF, go back
          one and read again</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp
          .read_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp; FF essentially tells us to repeat the last</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp; volume value for the remainder of the note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.set_vol:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta
          sound_temp2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save our
          new volume value (about to destroy A)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;<span style="color: rgb(255, 0, 0)">
            cpx #TRIANGLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            &nbsp;</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne
          .squares&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if not triangle channel, go ahead</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda sound_temp2</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne
          .squares&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else if volume not zero, go ahead (treat same as squares)</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda #$80</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bmi
          .store_vol&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else
          silence the channel with #$80</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >.squares:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_vol_duty, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;get current vol/duty
          settings</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and
          #$F0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;zero out the old volume</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ora
          sound_temp2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;OR our new
          volume in.</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >.store_vol:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy
          sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;get our
          index into soft_apu_ports</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports, y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;store the volume
          in our temp port</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inc stream_ve_index, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;set our volume
          envelop index to the next position</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >.rest_check:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;check the rest flag. if set, overwrite volume with silence value </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%00000010</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq
          .done&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if clear, no rest, so quit</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp
          #TRIANGLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if triangle, silence with #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq
          .tri&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else, silence with #$30</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne
          .store&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;this always branches.&nbsp; bne is cheaper than a jmp</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.store:&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta soft_apu_ports, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>New notes</b><br />The last thing we need to consider is new
        notes.&nbsp; When an old note finishes and we start playing a new note, we will want to reset the
        volume envelope back to the beginning.&nbsp; This is as easy as setting stream_ve_index to 0 when
        we read a new note:<br /><br /><span style="font-family: Courier New">se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;...snip... (setup pointers, read byte, test range, etc)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;save our index into the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;restore data stream index</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">lda #$00</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; sta stream_ve_index, x&nbsp; ;reset the volume envelope.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;check if it's a rest and modify the status flag appropriately</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_check_rest&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;...snip... (update pointer)</span
        ><br />&nbsp;&nbsp; &nbsp;<br />And now we have volume envelopes.<br /><br /><b
          >Putting It All Together</b
        ><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/envelopes.zip"
          target="_blank"
          original-href="http://tummaigames.com/envelopes.zip"
          >envelopes.zip</a
        >
        sample files.&nbsp; Make sure the following files are in the same folder as NESASM3:<br /><br />&nbsp;&nbsp;&nbsp;
        envelopes.asm<br />&nbsp;&nbsp;&nbsp; sound_engine.asm<br />&nbsp;&nbsp;&nbsp; envelopes.chr<br />&nbsp;&nbsp;&nbsp;
        note_table.i<br />&nbsp;&nbsp;&nbsp; note_length_table.i<br />&nbsp;&nbsp;&nbsp;
        vol_envelopes.i<br />&nbsp;&nbsp;&nbsp; song0.i<br />&nbsp;&nbsp;&nbsp; song1.i<br />&nbsp;&nbsp;&nbsp;
        song2.i<br />&nbsp;&nbsp;&nbsp; song3.i<br />&nbsp;&nbsp;&nbsp; song4.i<br />&nbsp;&nbsp;&nbsp;
        song5.i<br />&nbsp;&nbsp;&nbsp; envelopes.bat<br /><br />Double click envelopes.bat. That will
        run NESASM3 and should produce the envelopes.nes file. Run that NES file in FCEUXD SP.<br /><br />Use
        the controller to select songs and play them.&nbsp; Controls are as follows:<br />&nbsp;&nbsp;
        &nbsp;<br /><b>Up</b>: Play<br /><b>Down</b>: Stop <br /><b>Right</b> : Next Song/SFX<br /><b
          >Left </b
        >: Previous Song/SFX<br /><br />Song0 is a silence song.&nbsp; Not selectable.<br />Song1 is a
        boss song from The Guardian Legend, almost the same as the original.<br />Song2 is the same short
        sound effect from last week.<br />Song3 is a song from Dragon Warrior, very close to the
        original.<br />Song4 is the same song4 as last week, but volume envelopes allow us to save some
        bytes by reducing rests.<br />Song5 is a short sound effect, same as last week.<br /><br />Try
        creating your own songs and sound effects and add them into the mix.&nbsp; To add a new song you
        will need to take the following steps:<br /><br />1) create a song header and song data (use the
        included songs as reference).&nbsp; Don't forget to select a volume envelope for each stream in
        your header.&nbsp; Data streams are terminated with $FF.<br />2) add your header to the
        song_headers pointer table at the bottom of sound_engine.asm<br />3) update the constant
        NUM_SONGS to reflect the new song number total (also at the bottom of sound_engine.asm)<br /><br />Try
        making your own volume envelopes too.&nbsp; To do so you will need to modify
        vol_envelopes.i.&nbsp; Remember that volume envelopes are terminated with $FF.<br />
        <br /><b>Next Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25583"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25583"
          >Opcodes, Looping</a
        ><br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-7__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25253"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-8">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Nerdy Nights Sound: Part 8: Opcodes and Looping</h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25253"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25253"
          >Volume Envelopes</a
        ><br />
        <br />
        <b>This Week</b>: Opcodes and Looping<br />
        <br />
        <font size="5"><b>Opcodes</b></font
        ><br />
        <br />So far our sound engine handles two type of data that it reads from music data streams:
        notes and note lengths.&nbsp; This is enough to write complex music but of course we are going to
        want more features.&nbsp; We will want control over the sound of our notes.&nbsp; What if we want
        to change duty cycles midstream?&nbsp; Or volume envelopes?&nbsp; Or keys?&nbsp; What if we want
        to loop one part of the song four times?&nbsp; Or loop the entire song continuously?&nbsp; What
        if we want to play a sound effect as part of a song?<br /><br />All of these types of features,
        features where you are issuing commands to the engine, are going to be done through opcodes (also
        called control codes or command codes).&nbsp; An <b>opcode</b> is a value in the data stream that
        tells the engine to run a specific, specialized subroutine or piece of code.&nbsp; Most opcodes
        will have <b>arguments</b> sent along with them.&nbsp; For example, an opcode that changes a
        stream's volume envelope will come with an argument that specifies which volume envelope to
        change to.<br /><br />We've actually been using an opcode for weeks, I just haven't mentioned
        it.&nbsp; It's the opcode that ends a sound, and we've been encoding it in our data streams as
        $FF.&nbsp; Here is the code we've been using:<br /><br /><span style="font-family: Courier New"
          >se_fetch_byte:</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip--- (fetch a byte and range test)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .end</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x&nbsp;&nbsp;&nbsp; ;if $FF, end of stream, so disable
          it and silence</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%11111110</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_status, x&nbsp;&nbsp;&nbsp; ;clear enable flag in status
          byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #TRIANGLE</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .silence_tri&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;triangle is
          silenced differently from squares and noise</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda
          #$30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;squares and noise silenced with #$30</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .silence</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.silence_tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda
          #$80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;triangle silenced with #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.silence:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_vol_duty, x&nbsp; ;store silence value in the stream's volume
          variable.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .update_pointer&nbsp;&nbsp;&nbsp;&nbsp; ;done</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip--- (do note lengths and notes, update the stream's pointer)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Here we check if the byte read has a value of $FF.&nbsp; If so we
        turn the stream off and silence it.&nbsp; That's an opcode.<br /><br />It would be pretty messy
        if every opcode we had was just written straight out like this.&nbsp; Normally we would pull this
        code into its own subroutine, like this:<br /><br /><span style="font-family: Courier New"
          >se_fetch_byte:</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip--- (fetch a byte and range test)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp
          #$FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;end sound opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .end</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><span style="color: rgb(255, 0, 0); font-family: Courier New"
          >jsr se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;call the endsound subroutine</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp
          .fetch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;grab the
          next byte in the stream.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip--- (do note lengths and notes, update the stream's pointer)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >se_op_endsound:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x&nbsp;&nbsp;&nbsp; ;end of stream, so disable it and
          silence</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%11111110</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_status, x&nbsp;&nbsp;&nbsp; ;clear enable flag in status
          byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #TRIANGLE</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .silence_tri&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;triangle is
          silenced differently from squares and noise</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda
          #$30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;squares and noise silenced with #$30</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .silence</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.silence_tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda
          #$80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;triangle silenced with #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.silence:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_vol_duty, x&nbsp; ;store silence value in the stream's volume
          variable.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />The .opcode branch is much shorter now.&nbsp; If we wanted to add
        more opcodes, we could just add some more compares:<br /><br /><span
          style="font-family: Courier New"
          >.opcode:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;is it the end sound opcode? </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .not_FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >jsr se_op_endsound&nbsp; ;if so, call the end sound subroutine</span
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;and finish</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.not_FF:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$FE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else is it the loop opcode?</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .not_FE</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >jsr se_op_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if so, call the loop subroutine</span
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .opcode_done</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.not_FE:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$FD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else is it the change volume envelope opcode?</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne .not_FD</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >jsr se_op_change_ve ;if so, call the change volume envelope subroutine</span
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .opcode_done</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.not_FD:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode_done:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;update index to next byte in the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp .fetch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;go fetch
          another byte</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><br />This will work, but it's ugly.&nbsp; The more opcodes we
        add to our engine, the more checks we need to make.&nbsp; What if we have 20 opcodes?&nbsp; Do we
        really want to do that many compares?&nbsp; It's a waste of ROM space and cycles.<br /><br /><b
          >Tables</b
        ><br />Anytime you find yourself in a situation where you are doing a lot of CMPs on one value,
        the answer is to use a <b>lookup tabl</b>e.&nbsp; It will simplify everything!&nbsp; We've done
        it already with notes, note lengths, song numbers and volume envelopes.&nbsp; Could you imagine
        trying to get a note's period without using the lookup table?&nbsp; It would look like this:<br /><br /><span
          style="font-family: Courier New"
          >Is the note an A1?&nbsp; If so, use this period, else</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >Is the note an A#1?&nbsp; If so, use this period, else</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >Is the note a B1?&nbsp; If so, use this period, else</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >Is the note a C2?&nbsp; If so, use this period, else</span
        ><br style="font-family: Courier New" /><b style="color: rgb(255, 0, 0)"
          ><span style="font-family: Courier New">... (about 100 more checks)</span></b
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >Is the note an F#9? If so, use this period, else</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >Is the note a rest?&nbsp; If so, use this period</span
        ><br /><br />That's just crazy.&nbsp; It would be hundreds of lines of unreadable code and you'd
        run into branch-range errors too.&nbsp; When we use a lookup table, the code is simplified to
        this:<br /><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;save our index</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;restore data stream index</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Much cleaner.&nbsp; Again, I can't stress it enough:
        <b>if you find yourself doing lots of CMPs on a single value, use a table instead!</b
        ><br />&nbsp;&nbsp; &nbsp;<br />With notes and note lengths we used a straight
        <i>lookup table</i> of values.&nbsp; With song numbers and volume envelopes we used a special
        type of lookup table called a <i>pointer table</i>, which stored data addresses.&nbsp; For
        opcodes we have two choices.&nbsp; We can use something called a <b>jump table</b> or we can use
        an <b>RTS table</b>.&nbsp; They are almost the same and the difference in performance between the
        two methods is negligible so for most programmers it's a matter of personal preference. &nbsp;<br /><br />I
        prefer RTS tables myself, but we're going to use jump tables because they are easier to explain
        and understand.<br /><br /><b>Jump Tables</b><br />Ok, here's our problem:&nbsp; Our sound engine
        has opcodes.&nbsp; A lot of them, let's say 10 or more.&nbsp; Each opcode has its own
        subroutine.&nbsp; When our sound engine reads an opcode byte from the data stream, we want to
        avoid a long list of CMP and BNE instructions to select the right subroutine.&nbsp; How do we do
        that?&nbsp;&nbsp; We use a jump table.<br /><br />A jump table is similar to a pointer table: it
        is a table of addresses.&nbsp; But whereas a pointer table holds addresses that point to the
        start of data, a <b>jump table</b> holds addresses that point to the start of <i>code</i> (ie,
        the start of subroutines).&nbsp; For example, suppose we have some subroutines:<br /><br /><span
          style="font-family: Courier New"
          >sub_a:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldx #$FF</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">sub_b:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc #$03</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">sub_c:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sec</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sbc #$03</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Here is how a jump table would look using these subroutines:<br /><br /><span
          style="font-family: Courier New"
          >sub_jump_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word sub_a, sub_b, sub_c</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Hey, that's pretty easy.&nbsp; We just use the subroutine label
        and the assembler will translate that into the address where the subroutine starts.&nbsp; Let's
        make a jump table for our sound opcode subroutines:<br /><br /><span
          style="font-family: Courier New"
          >se_op_endsound:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >se_op_infinite_loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >se_op_change_ve:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;etc..&nbsp; more subroutines</span
        ><br style="font-family: Courier New" /><br />
        <span style="font-family: Courier New">;this is our jump table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_endsound</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_infinite_loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_change_ve</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;etc, one entry per subroutine</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Cool.&nbsp; We have a jump table now.&nbsp; So how do we use
        it?<br /><br /><b>Indirect Jumping</b><br />The 6502 let's us do some cool things.&nbsp; One of
        those things is called an indirect jump.&nbsp; An <b>indirect jump</b> let's you stick a
        destination address into a zero-page pointer variable and jump there.&nbsp; It works like
        this:<br /><br /><span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; .rsset $0000</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;first declare a pointer variable somewhere in the zero-page</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >jmp_ptr .rs 2&nbsp; ;2 bytes because an address is always a word</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp [jmp_ptr] ;will jump to $8000</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Here we stick an address ($8000, lo byte first) into our
        <b>jmp_ptr</b> variable.&nbsp; Then we do an indirect jump by using the JMP instruction followed
        by a pointer variable in brackets:<br /><br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp [jmp_ptr] ;indirect jump</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This instruction translates into English as "Jump to the address
        that is stored in jmp_ptr and jmp_ptr+1".&nbsp; It's extrememly useful.&nbsp; We can stick any
        address we want in there:<br />&nbsp;&nbsp; &nbsp;<br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$C0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp [jmp_ptr] ;will jump to $C000</span
        ><br />&nbsp;&nbsp; &nbsp;<br />We could read an address from ROM and use that if we wanted to,
        for example our reset vector:<br />&nbsp;&nbsp; &nbsp;<br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda $FFFC</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda $FFFD</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp [jmp_ptr] ;will jump to our reset routine</span
        ><br />&nbsp;&nbsp; &nbsp;<br />And we can use it in combination with our jump table:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_opcodes, y&nbsp;&nbsp;&nbsp; ;read low byte of address from jump
          table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_opcodes+1, y&nbsp; ;read high byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp [jmp_ptr]&nbsp;&nbsp; ;will jump to whatever address we pulled from the
          table.</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Pretty powerful.&nbsp; We can dynamically jump to any section of
        code we want!<br />&nbsp;&nbsp; &nbsp;<br /><b>Implementation</b><br />So we know how to build a
        jump table and we know how to do an indirect jump.&nbsp; Let's tie it all together and stick it
        into our sound engine.&nbsp; Let's start with <b>se_fetch_byte</b>.&nbsp; se_fetch_byte reads a
        byte from the data stream and range-checks it to see if it is a note, note length or
        opcode.&nbsp; Recall that notes have a byte range of $00-$7F.&nbsp; Note lengths have a range of
        $80-$9F.&nbsp; The opcode byte range is $A0-$FF:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if
          &lt; #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span
        ><span style="color: rgb(255, 0, 0); font-family: Courier New"
          >;else ($A0-$FF) it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note length stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note stuff</span
        ><br />&nbsp;&nbsp; &nbsp;<br />So we need to assign our opcodes to values between $A0 and
        $FF.&nbsp; Just as with notes and note lengths, the opcode byte we read from the data stream will
        be used as a table index (after subtracting $A0), so we will assign our opcodes in the same order
        as our table:<br /><br /><span style="font-family: Courier New">sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this should
          be $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_infinite_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this should
          be $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_change_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this should be
          $A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;etc, 1 entry per subroutine</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >;these are aliases to use in the sound data.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >endsound = $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >loop = $A1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;be
          careful of conflicts here.&nbsp; this might be too generic.&nbsp; maybe song_loop is
          better</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >volume_envelope = $A2</span
        ><br /><br />Now let's alter se_fetch_byte to take care of our opcodes:<br /><br /><span
          style="font-family: Courier New"
          >se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.fetch:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if
          &lt; #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else ($A0-$FF) it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">;do Opcode stuff</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; jsr se_opcode_launcher&nbsp;&nbsp; ;launch our opcode!!!</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;next position in the data stream</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; and #%00000001</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne
          .fetch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;after our opcode is done, grab another byte unless the stream is disabled</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp;
          rts&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ; in which case we quit&nbsp; (explained below)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note length stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note stuff</span
        ><br />&nbsp;&nbsp; &nbsp;<br />I added a call to a subroutine called se_opcode_launcher and a
        little branch.&nbsp; Not a big change is it?&nbsp; But there's an important detail here.&nbsp;
        se_opcode_launcher will be a short, simple subroutine that will read from the jump table and
        perform an indirect jump.&nbsp; It looks like this:<br /><br /><span
          style="font-family: Courier New"
          >se_opcode_launcher:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save y
          register, because we are about to destroy it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sec</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sbc
          #$A0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;turn our opcode byte into a table index by subtracting $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp;&nbsp; $A0-&gt;$00, $A1-&gt;$01, $A2-&gt;$02, etc.&nbsp; Tables index from $00.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl
          a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;multiply by 2 because we index into a table of addresses (words)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_opcodes, y&nbsp;&nbsp;&nbsp; ;get low byte of subroutine
          address</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_opcodes+1, y&nbsp; ;get high byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta jmp_ptr+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;restore
          our y register</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;set to next position in data stream (assume an argument)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jmp [jmp_ptr]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;indirect jump to our opcode subroutine</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Short and simple.&nbsp; So why did I wrap this code in its own
        subroutine?&nbsp; Why not just stick this code as-is in the .opcode branch of
        se_fetch_byte?&nbsp; Because we need a place to return to.<br /><br />The JSR and RTS
        instructions work as a pair.&nbsp; They go hand in hand.&nbsp; They need each other.&nbsp;
        Without going into too much detail, this is what goes on behind the scenes:<br />
        <br />
        <b>JSR</b> sticks a return address on the stack and jumps to a subroutine.&nbsp; One way to look
        at it is to think of JSR as a JMP that remembers where it started from.<br />
        <b>RTS</b> pops the return address off the stack and jumps there.&nbsp; <br />
        <br />
        So JSR leaves a treasure map for RTS to pick up and follow later.&nbsp; The <b>key point</b> here
        is that <b>RTS expects a return address to be waiting for it on the stack</b>. &nbsp;<br /><br />Now
        our opcode subroutines all end in an RTS instruction.&nbsp; Do you see the potential problem
        here?<br /><br />We call our opcode subroutines using an indirect jump.&nbsp; This requires us to
        use a JMP instruction, not a JSR instruction.&nbsp; A JMP instruction doesn't remember where it
        started from.&nbsp; No return address is pushed onto the stack with a JMP instruction.&nbsp; So
        when we jump to our opcode subroutine and hit the RTS instruction at the end, there is no return
        address waiting for us!&nbsp; The RTS will pull whatever random values happen to be on the stack
        at the time and jump there.&nbsp; We'll end up somewhere random and our program will surely
        crash!<br /><br />To fix this, we wrap our indirect jump in a subroutine,
        se_opcode_launcher.&nbsp; We call it with a JSR instruction, completing the JSR/RTS pair:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_opcode_launcher&nbsp; ;this jsr will let us remember where we came
          from</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This JSR instruction will stick a return address on the stack for
        us.&nbsp; Then inside se_opcode_launcher we perform our indirect jump to our desired opcode
        subroutine.&nbsp; Now when we hit that RTS instruction at the end of the opcode subroutine we
        have a return address waiting for us on the stack.&nbsp; Our program returns back to where we
        started.&nbsp; We are safe.<br /><font size="4"
          ><b
            ><br />
            Opcode Subroutines</b
          ></font
        ><br />With our opcode launcher written, we are all set up to make opcodes.&nbsp; We already have
        one written: the <b>endsound</b> opcode.&nbsp; This is the opcode we will use to terminate sound
        effects.&nbsp; Sound effects don't loop continuously like songs do, so they need to be
        stopped.&nbsp; Let's take a look again:<br /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >se_op_endsound:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_status, x&nbsp;&nbsp;&nbsp; ;end of stream, so disable it and
          silence</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%11111110</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_status, x&nbsp;&nbsp;&nbsp; ;clear enable flag in status
          byte</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #TRIANGLE</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .silence_tri&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;triangle is
          silenced differently from squares and noise</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda
          #$30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;squares and noise silenced with #$30</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bne
          .silence&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; (this will always
          branch.&nbsp; bne is cheaper than a jmp)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.silence_tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda
          #$80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;triangle silenced with #$80</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.silence:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_vol_duty, x&nbsp; ;store silence value in the stream's volume
          variable.</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This opcode is special.&nbsp; It's the reason for the check after
        the call to se_opcode_launcher:<br /><br /><span style="font-family: Courier New"
          >se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip---</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else ($A0-$FF) it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_opcode_launcher</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;next position in the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">lda stream_status, x</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; and #%00000001</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne
          .fetch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;after our opcode is done, grab another byte unless the stream is disabled</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp;
          rts&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ; in which case we quit&nbsp; (explained below)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip---</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Normally, we want se_fetch_byte to keep fetching bytes until it
        hits a note.&nbsp; Recall that with note lengths we jumped back to .fetch after setting the new
        note length.&nbsp; This is because after setting the length of the note, we needed to know WHAT
        note to play.&nbsp; So we fetch another byte.&nbsp; The same thing is true of opcodes.&nbsp; If
        we change the volume envelope with an opcode, great!&nbsp; But we still need to know what note to
        play next.&nbsp; If we use an opcode to switch our square's duty cycle, great!&nbsp; But we still
        need to know what note to play next.&nbsp; If we use an opcode to loop back to the beginning of
        the song, that's great!&nbsp; But we still need to read that first note of the song.&nbsp; This
        is why we jump back to fetch a byte after we run an opcode.<br /><br />The ONE exception to this
        rule is when we end a sound effect.&nbsp; We are terminating the sound effect completely, so
        there is no next note.&nbsp; We don't want to fetch something that isn't there, so we need to
        skip the jump.&nbsp; That's why we check the status byte after we run the opcode.&nbsp; If the
        stream is disabled by the endsound opcode, we are finished.&nbsp; Otherwise, fetch another
        byte.<br /><br /><b>Looping</b><br />The next opcode in our list is the <b>loop</b> opcode.&nbsp;
        This is the opcode that we will stick at the end of every song to tell the sound engine to play
        the song again, and again and again.&nbsp; It is actually quite easy to implement.&nbsp; It takes
        a <b>2-byte argument</b>, which is <b>the address to loop back to</b>.&nbsp; The subroutine looks
        like this:<br /><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >se_op_infinite_loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read LO byte of the
          address argument from the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x&nbsp;&nbsp;&nbsp; ;save as our new data stream
          position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read HI byte of the
          address argument from the data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_HI, x&nbsp;&nbsp;&nbsp; ;save as our new data stream
          position data stream position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;update the
          pointer to reflect the new position.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy
          #$FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;after opcodes return, we do an iny.&nbsp; Since we reset &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;the stream buffer position, we will want y to start out at 0 again.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />The first thing to notice about this subroutine is that it reads
        two bytes from the data stream.&nbsp; This is the address argument that gets passed along with
        the opcode.&nbsp; To make it clear, let's look at some example sound data:<br /><br /><span
          style="font-family: Courier New"
          >song1_square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth ;set note length to eighth notes</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C5, E5, G5, C6, E6, G6, C5, Eb5, G5, C6, Eb6, half, G6 ;play some
          notes</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >.byte loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this alias evaluates to
            $A1, the loop opcode</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .word song1_square1 ;this evaluates to the address of the song1_square1
          label</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;ie, the address we want to loop to.</span
        ><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;<br />After the "loop" opcode comes a word which is the address to loop back to.&nbsp; In
        this example I chose to loop back to the beginning of the stream data.<br /><br />So what does
        our loop opcode do?&nbsp; It reads the first byte of this address argument (the low byte) and
        stores it in stream_ptr_LO.&nbsp; Then it reads the second byte of the address argument (the high
        byte) and stores it in stream_ptr_HI.&nbsp; These are the variables that keep track of our data
        stream position!&nbsp; The loop opcode just changes these values to some address that we
        specify.&nbsp; Not too complicated at all.&nbsp; The last step is to update the actual pointer
        (<b>sound_ptr</b>) so that the next byte we read from the data stream will be the first note we
        looped back to.<br /><br />In the example sound data above I looped back to the beginning of the
        stream data, but there's nothing stopping me from looping somewhere else:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">song1_square1:</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >;intro, don't loop this part</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte quarter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C4, C4, C4, C4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          ><span style="color: rgb(255, 0, 0)">.loop_point:</span>&nbsp;&nbsp;&nbsp; ;this is where we
          will loop back to.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth ;set note length to eighth notes</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C5, E5, G5, C6, E6, G6, C5, Eb5, G5, C6, Eb6, half, G6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.byte loop</span
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this alias evaluates to $A1, the loop
          opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">.word .loop_point</span> ;this
          evaluates to the address of the .loop_point label</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;ie, the address we want to loop to.</span
        ><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        &nbsp;<br />Technically we can also "loop" to a forward position, in which case it's actually
        more like a jump than a loop.&nbsp; That's all a loop is really: a jump... backwards.<br /><br /><b
          >Changing Volume Envelopes</b
        ><br />Let's write the opcode subroutine to change volume envelopes.&nbsp; This one is even
        easier.&nbsp; It takes <b>one argument</b>, which will be
        <b>which volume envelope to switch to</b>:<br /><br /><span style="font-family: Courier New"
          >se_op_change_ve:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read the argument</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ve, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;store it in our
          volume envelope variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ve_index, x&nbsp; ;reset volume envelope index to the
          beginning</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />That's it!<br /><br /><b>Changing Duty Cycles</b><br />Now let's
        add an opcode that will change the duty cycle for a square stream.&nbsp; This one also takes
        <b>one argument: which duty cycle to switch to</b>.<br /><br /><span
          style="font-family: Courier New"
          >se_op_duty:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read the argument (which
          duty cycle to change to)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_vol_duty, x&nbsp; ;store it.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Done!&nbsp; Now we have the subroutine, but we still need to add
        it to our jump table:<br /><br /><span style="font-family: Courier New">sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this should
          be $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;this should be $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_change_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;this should be
          $A2</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_duty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;this should be $A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;etc, 1 entry per subroutine</span
        ><br /><br /><span style="font-family: Courier New"
          >;these are aliases to use in the sound data.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >endsound = $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop = $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >volume_envelope = $A2</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >duty = $A3</span
        ><br /><br />And it's ready to use:<br /><br /><span style="font-family: Courier New"
          >song0_square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;intro, don't loop this part</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte quarter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C4, C4, C4, C4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.loop_point:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;this is where we will loop back to.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.byte duty, $B0</span
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;change the duty cycle</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.byte volume_envelope, ve_blip_echo</span> ;change the
          volume envelope</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          eighth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;set note length to eighth notes</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C5, E5, G5, C6, E6, G6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;play some notes</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.byte duty, $30&nbsp;</span
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;change the duty cycle</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.byte volume_envelope, ve_short_staccato</span
          >&nbsp;&nbsp;&nbsp; ;change volume envelope</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C5, Eb5, G5, C6, Eb6, half, G6&nbsp;&nbsp;&nbsp; ;play some eighth
          notes and a half note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;loop to .loop_point </span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word .loop_point</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Readability</b><br />sound_engine.asm is getting pretty bulky
        with all these subroutines.&nbsp; It will only get bigger as we add more opcodes.&nbsp; It's nice
        to have all of our opcodes together in one place, but it's annoying to have to scroll around to
        find them.&nbsp; So let's pull all of our opcodes into their own file:
        <b>sound_opcodes.asm</b>.&nbsp; Then, at the bottom of sound_engine.asm, we can .include it:<br /><br />&nbsp;&nbsp;&nbsp;
        <span style="color: rgb(255, 0, 0)">.include "sound_opcodes.asm"</span> ;our opcode subroutines,
        jump table and aliases<br />&nbsp;&nbsp;&nbsp; .include "note_table.i" ;period lookup table for
        notes<br />&nbsp;&nbsp;&nbsp; .include "note_length_table.i"<br />&nbsp;&nbsp;&nbsp; .include
        "vol_envelopes.i"<br />&nbsp;&nbsp;&nbsp; .include "song0.i"&nbsp; ;holds the data for song 0
        (header and data streams)<br />&nbsp;&nbsp;&nbsp; .include "song1.i"&nbsp; ;holds the data for
        song 1<br />&nbsp;&nbsp;&nbsp; .include "song2.i"<br />&nbsp;&nbsp;&nbsp; .include "song3.i"<br />&nbsp;&nbsp;&nbsp;
        .include "song4.i"<br />&nbsp;&nbsp;&nbsp; .include "song5.i"<br />&nbsp;&nbsp;&nbsp;
        <span style="color: rgb(255, 0, 0)">.include "song6.i"</span>&nbsp; ;oooh.. new song!<br />&nbsp;&nbsp;
        &nbsp;<br />I gave it the extension .asm because it contains code as well as data, and I like to
        be able to tell at a glance what files have what in them.&nbsp; Now whenever we want to add new
        opcodes, or tweak old ones, we have them nice and compact in their own file.<br /><br /><b
          >Updating Sound Data</b
        ><br />Whenever we add new things to our sound engine, we have to think about how it will affect
        our old sound data.&nbsp; This week we added opcodes, which will change our songs and sound
        effects terminate.&nbsp; Before we were terminating them with $FF.&nbsp; This won't work anymore
        because $FF doesn't do anything.&nbsp; For songs, we should terminate with "loop" followed by an
        address to loop to.&nbsp; With sound effects we should terminate with the opcode
        "endsound".&nbsp; See the included songs and sound effects for examples.<br /><br /><b
          >RTS Tables</b
        ><br />We talked about jump tables and indirect jumping this week.&nbsp; Another method for doing
        the same thing involves something called an <b>RTS table</b> and the <b>RTS Trick</b>.&nbsp; I
        won't cover it in these tutorials, but if you are curious to know how this works you can read
        <a
          href="http://wiki.nesdev.com/w/index.php/RTS_Trick"
          target="_blank"
          original-href="http://wiki.nesdev.com/w/index.php/RTS_Trick"
          >this nesdev wiki article I wrote about the RTS Trick</a
        >.<br /><br /><br /><b>Putting It All Together</b><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/opcodes.zip"
          target="_blank"
          original-href="http://tummaigames.com/opcodes.zip"
          >opcodes.zip</a
        >
        sample files.&nbsp; Make sure the following files are in the same folder as NESASM3:<br /><br />&nbsp;&nbsp;&nbsp;
        opcodes.asm<br />&nbsp;&nbsp;&nbsp; sound_engine.asm<br />&nbsp;&nbsp;&nbsp; sound_opcodes.asm<br />&nbsp;&nbsp;&nbsp;
        opcodes.chr<br />&nbsp;&nbsp;&nbsp; note_table.i<br />&nbsp;&nbsp;&nbsp; note_length_table.i<br />&nbsp;&nbsp;&nbsp;
        vol_envelopes.i<br />&nbsp;&nbsp;&nbsp; song0.i<br />&nbsp;&nbsp;&nbsp; song1.i<br />&nbsp;&nbsp;&nbsp;
        song2.i<br />&nbsp;&nbsp;&nbsp; song3.i<br />&nbsp;&nbsp;&nbsp; song4.i<br />&nbsp;&nbsp;&nbsp;
        song5.i<br />&nbsp;&nbsp;&nbsp; song6.i<br />&nbsp;&nbsp;&nbsp; opcodes.bat<br /><br />Double
        click opcodes.bat. That will run NESASM3 and should produce the opcodes.nes file. Run that NES
        file in FCEUXD SP.<br /><br />Use the controller to select songs and play them.&nbsp; Controls
        are as follows:<br />&nbsp;&nbsp; &nbsp;<br /><b>Up</b>: Play<br /><b>Down</b>: Stop <br /><b
          >Right</b
        >: Next Song/SFX<br /><b>Left</b>: Previous Song/SFX<br /><br />Song0 is a silence song.&nbsp;
        Not selectable.<br />Song1 is a boss song from The Guardian Legend.&nbsp; Now it loops!<br />Song2
        is the same short sound effect from last week.&nbsp; Terminated with endsound.<br />Song3 is a
        song from Dragon Warrior.&nbsp; Now it loops!<br />Song4 is the same song4 as last week, but now
        it loops!<br />Song5 is a short sound effect, terminated with the endsound opcode.<br />Song6
        should be familiar to readers of this forum.&nbsp; Do you recognize it?&nbsp; It utilizes opcodes
        for changing duty cycles and volume envelopes.&nbsp; Plus it loops!<br /><br />Try adding your
        own songs and sound effects in.&nbsp; Try to add your own opcodes too.&nbsp; Here's some ideas
        for opcodes:<br /><br />1. Trigger a sound effect mid-song<br />2. Implement duty cycle envelopes
        (similar to volume envelopes).&nbsp; Then make an opcode that allows you to change it.<br />3.
        Finite loops<br /><br /><b>Next Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=26247"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=26247"
          >more opcode fun.&nbsp; Finite Loops, Changing Keys and Autom...</a
        >
        .<br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-8__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25583"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-9">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">
          Nerdy Nights Sound: Part 9: Finite Loops, Key Changes, Chord Progressions
        </h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25583"
          target="_blank"
          original-href="http://www.nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=25583"
          >Opcodes and Looping</a
        ><br /><br /><b>This Week</b>: More opcodes: Finite Loops, Key Changes, Chord Progressions<br /><br /><font
          size="4"
          ><b>Opcodes</b></font
        ><br />Last week we learned how to use opcodes.&nbsp; Opcodes allow a song's streams to call a
        subroutine mid-play.&nbsp; This is a very powerful tool.&nbsp; We learned some of the most common
        opcodes: infinite loop (really a jump), change volume envelopes and change duty cycles.&nbsp;
        Today we are going to expand on opcodes and learn some cool opcode tricks that can save us a lot
        (!) of bytes and time.<br /><b
          ><font size="3"
            ><br />
            Finite Looping</font
          ></b
        ><br />Last week we added the infinite loop opcode, which was really just an unconditional jump
        back to an earlier part of the song.&nbsp; Today we're going to add a finite loop opcode.&nbsp; A
        finite loop opcode tells the sound engine to repeat a particular section of a song X times, where
        X is some number defined by you.&nbsp; In the Battle Kid theme song I added last week there is a
        passage that looks like this:<br /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte sixteenth</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, E4, E3, E2</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This is really just the same 4 notes repeated over and over
        again.&nbsp; Wouldn't it be cooler if we could do something like this instead:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; .byte sixteenth</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte loop_13_times_please</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, E4, E3, E2</span
        ><br />&nbsp;&nbsp; &nbsp;<br />That saves a lot of bytes.&nbsp; We go from 56 bytes all the way
        down to around 10.&nbsp; The Battle Kid song actually plays this same phrase on both square
        channels, so really we go from 100+ bytes down to 20 or so.&nbsp; That's a big deal!&nbsp; If we
        consider how common repetitions of 4 or 8 occur in music, we can easily see that having a finite
        loop opcode could potential save us hundreds if not thousands of bytes in our sound data.<br /><br /><b
          >Finite Looping?</b
        ><br />So what is a finite loop really?&nbsp; We saw that with an infinite loop it was really
        more like an unconditional jump.&nbsp; When the sound engine hits the infinite loop opcode, it
        jumps back, always, no matter what, no questions asked.&nbsp;&nbsp; A finite loop on the other
        hand is a conditional jump.&nbsp; It checks a counter.&nbsp; If the counter isn't 0 it
        jumps.&nbsp; If it is 0, it doesn't jump. &nbsp;<br /><b
          ><br />
          Loop Counter</b
        ><br />First things first we need a loop counter.&nbsp; Each stream will have the ability to
        loop, so each stream will need its own loop counter:<br /><br /><span
          style="font-family: Courier New"
          >stream_loop1 .rs 6&nbsp; ;loop counter variable (one for each stream)</span
        ><br /><br />We will want to initialize this to 0 in our sound_load code:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_loop1, x</span
        ><br style="font-family: Courier New" /><br />Next we will need a way to set this counter to some
        value.&nbsp; Some games bundle this up together in the finite loop opcode, but I prefer to make
        it its own opcode:<br /><br /><span style="font-family: Courier New"
          >;-----------------------------------------------------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;this is our JUMP TABLE!</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_infinite_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_change_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_duty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.word se_op_set_loop1_counter&nbsp;&nbsp; ;$A4</span></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;etc, one entry per subroutine</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;these are aliases to use in the sound data.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >endsound = $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop = $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >volume_envelope = $A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">duty = $A3</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >set_loop1_counter = $A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >se_op_set_loop1_counter:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read the argument (#
          times to loop)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_loop1, x&nbsp;&nbsp;&nbsp;&nbsp; ;store it in the loop counter
          variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br /><br />Now we have an easy way to set the loop counter any time we want, like this:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; ;somewhere in sound data:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_loop1_counter, $04&nbsp;&nbsp;&nbsp; ;repeat 4 times</span
        ><br /><b
          ><br />
          Looping With The Counter</b
        ><br />Our finite loop opcode will work like the infinite loop opcode, with two changes:<br /><br />1)
        it will decrement the loop counter<br />2) it will check the result and only jump on a non-zero
        result<br /><br />Let's write it:<br /><br /><span style="font-family: Courier New"
          >;-----------------------------------------------------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;this is our JUMP TABLE!</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_infinite_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_change_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_duty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_set_loop1_counter&nbsp;&nbsp; ;$A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >.word
            se_op_loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            ;$A5</span
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;etc, one entry per subroutine</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;these are aliases to use in the sound data.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >endsound = $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop = $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >volume_envelope = $A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">duty = $A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >set_loop1_counter = $A4</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >loop1 = $A5</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">se_op_loop1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dec stream_loop1, x&nbsp;&nbsp;&nbsp;&nbsp; ;decrement the counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_loop1, x&nbsp;&nbsp;&nbsp;&nbsp; ;and check it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .last_iteration&nbsp;&nbsp;&nbsp;&nbsp; ;if zero, we are done
          looping</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop_back:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read ptr LO from the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x&nbsp;&nbsp;&nbsp; ;update our data stream
          position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read ptr HI from the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_HI, x&nbsp;&nbsp;&nbsp; ;update our data stream
          position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;update the
          pointer to reflect the new position.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy
          #$FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;after opcodes return, we do an iny.&nbsp; Since we reset &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;the stream buffer position, we will want y to start out at 0 again.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.last_iteration:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;skip the first byte of the address argument</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ; the second byte will be skipped automatically upon return</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ; (see se_fetch_byte.&nbsp; There is an "iny" after "jsr se_opcode_launcher")</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Now we can loop.&nbsp; To use the Battle Kid example above, we go
        from this (56 bytes):<br /><br /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4, A3, C4, E4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4, A3, E4, E3, E2</span
        ><br />&nbsp;&nbsp; &nbsp;<br />to this (13 bytes):<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp;
        <span style="font-family: Courier New">.byte set_loop1_counter, 13 ;repeat 13 times.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.intro_loop:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;make sure our loop point is AFTER we set the counter!</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, C4, E4, A4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;the phrase
          to repeat.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;finite loop opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          .intro_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;address to jump back
          to</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, E4, E3, E2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;the last 4
          notes</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Pretty nice savings.&nbsp; Chances are we will be using this
        opcode set a lot.<br /><br /><b>Bonus</b><br />We can save a few more bytes here.&nbsp; You may
        have noticed that the code in the .loop_back section of our finite loop opcode is identical to
        the infinite loop code:<br /><br /><span style="font-family: Courier New">se_op_loop1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip---</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop_back:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read ptr LO from the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x&nbsp;&nbsp;&nbsp; ;update our data stream
          position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read ptr HI from the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_HI, x&nbsp;&nbsp;&nbsp; ;update our data stream
          position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;update the
          pointer to reflect the new position.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy
          #$FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;after opcodes return, we do an iny.&nbsp; Since we reset &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;the stream buffer position, we will want y to start out at 0 again.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip---</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Compare with:<br /><br /><span style="font-family: Courier New"
          >se_op_infinite_loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read ptr LO from the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x&nbsp;&nbsp;&nbsp; ;update our data stream
          position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read ptr HI from the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_HI, x&nbsp;&nbsp;&nbsp; ;update our data stream
          position</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr+1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;update the
          pointer to reflect the new position.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_ptr</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy
          #$FF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;after opcodes return, we do an iny.&nbsp; Since we reset &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;the stream buffer position, we will want y to start out at 0 again.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Why have identical code in two places?&nbsp; Let's cut out the
        whole .loop_back section and replace it with a "jmp se_op_infinite_loop":<br /><br /><span
          style="font-family: Courier New"
          >se_op_loop1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; dec stream_loop1, x&nbsp;&nbsp;&nbsp;&nbsp; ;decrement the counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_loop1, x&nbsp;&nbsp;&nbsp;&nbsp; ;check the counter</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .last_iteration&nbsp;&nbsp;&nbsp;&nbsp; ;if zero, we are done
          looping</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >jmp se_op_infinite_loop ;if not zero, loop back</span
          ></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.last_iteration:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          iny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;skip the first byte of the address argument</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ; the second byte will be skipped automatically upon return</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ; (see se_fetch_byte after "jsr se_opcode_launcher")</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Multiple Finite Loops</b><br />You may have been wondering why
        I named the finite loop opcode "loop1".&nbsp; Why stick a 1 on the end there?&nbsp; This is
        because sometimes one finite loop opcode isn't enough.&nbsp; Consider the following song
        structure.&nbsp; Assume each letter represents a long series of notes:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; A A A B C</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; A A A B C</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; A A A B C</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; A A A B C</span
        ><br />&nbsp;&nbsp; &nbsp;<br />With one finite loop opcode you could reduce it to this:<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; (A A A B C)x4</span
        ><br />&nbsp;&nbsp; &nbsp;<br />But if you had two finite loop opcodes available, you could nest
        them to reduce it even further:<br /><br />&nbsp;&nbsp;<span style="font-family: Courier New"
          >&nbsp; (Ax3 B C)x4</span
        ><br />&nbsp;&nbsp; &nbsp;<br />If the music you write has a lot of patterns like this, it may be
        worth your while to have two or more finite loop opcodes available to you so that you can nest
        them.&nbsp; To add another finite loop opcode you need to:<br /><br />1) declare another loop
        counter variable block in RAM (stream_loop2 .rs 6)<br />2) initialize the new loop counter to 0
        in the sound_load routine.<br />3) add a new opcode for setting the new loop counter
        (se_op_set_loop2_counter)<br />4) add a new opcode to check the new counter and loop
        (se_op_loop2)<br />5) make sure to add the new opcodes to the jump table and give them an alias
        (set_loop2_counter, loop2).<br /><br /><br />Each finite loop opcode you add requires 6 bytes of
        RAM (a limited resource!), so please consider carefully if it is worth the tradeoff.&nbsp; It all
        depends on your music data.<br /><br />
        <br /><b><font size="3">Changing Keys</font></b
        ><br /><br />Another useful feature to have is the ability to change keys.&nbsp; Imagine you
        write a song and you have it all done.&nbsp; Then at the last minute you decide you want it to be
        in another key, say a step (2 notes) lower.&nbsp; Rather than rewrite the whole song by hand (it
        takes forever), wouldn't it be nice if there was an opcode that you could set to automatically
        subtract two from every note?&nbsp; What if you have a song pattern that gets played in more than
        one key (a rhythm track for a Blues song, for example)?&nbsp; We could save lots of bytes if we
        can figure out a way to write the pattern once, and then loop it while changing keys each
        iteration.&nbsp; Let's do it.<br /><br /><b>Note Offset</b><br />We will implement keys by having
        a note offset variable:<br /><br /><span style="font-family: Courier New"
          >stream_note_offset .rs 6&nbsp;&nbsp;&nbsp; ;note offset</span
        ><br /><br />The note offset is a value that gets added to the note value before pulling the
        period out of the note_table.&nbsp; We will initialize stream_note_offset to 0 so that the
        default behavior is to add 0 to the note (resulting in no change).&nbsp; However, if we set
        stream_note_offset to some value via an opcode, it will change the notes.&nbsp; Here is an
        updated se_fetch_byte that demonstrates how this works:<br /><br /><span
          style="font-family: Courier New"
          >se_fetch_byte:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;...snip...</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;save our index into the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; <span style="color: rgb(255, 0, 0)">clc</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; adc stream_note_offset, x&nbsp;&nbsp; ;add note offset</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;restore data stream index</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;...snip...</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Imagine what would happen if we have stream_note_offset set to
        2.&nbsp; Say we read a C4 note from the data stream:<br />&nbsp;&nbsp; &nbsp;<br />1. A C4 note
        is equivalent to hex value #$1b (see aliases in note_table.i)<br />2. we add stream_note_offset
        to this value.&nbsp; #$1b + #$02 = #$1d.<br />3. hex value #$1d is equivalent to a D4 note (see
        note_table.i)<br />4. wow, we raised the note up a step!<br /><br />Using the same value for
        stream_note_offset, if we had a string of notes like this:<br /><br /><span
          style="font-family: Courier New"
          >C4, E4, G4, B4, C5, E5, G5, E5, B5, C6 ;Cmaj7</span
        ><br style="font-family: Courier New" /><br />it would get translated to:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">D4, Fs4, A4, C#5, D5, Fs5, A5, C#6, D6 ;Dmaj7</span
        ><br /><br />Using stream_note_offset we can easily transpose entire sections of music into other
        keys.&nbsp; As mentioned above, we will initialize a stream's stream_note_offset to zero:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">sound_load:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip---</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_offset, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;---snip---</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Set Note Offset</b><br />Now let's make an opcode that will
        set stream_note_offset to a specific value:<br /><br /><span style="font-family: Courier New"
          >;-----------------------------------------------------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;this is our JUMP TABLE!</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_infinite_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_change_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_duty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_set_loop1_counter&nbsp;&nbsp; ;$A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A5</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .word se_op_set_note_offset&nbsp;&nbsp;&nbsp;&nbsp; ;$A6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;these are aliases to use in the sound data.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >endsound = $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop = $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >volume_envelope = $A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">duty = $A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >set_loop1_counter = $A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop1 = $A5</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >set_note_offset = $A6</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >se_op_set_note_offset:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;read the argument</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_offset, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;set the note
          offset.</span
        ><br /><span style="font-family: Courier New">&nbsp;&nbsp;&nbsp; rts</span><br /><br />Now we can
        set the note offset anytime we want in the data stream:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New"
          >;oops, after writing the song, I realized I wanted it to be in D instead.&nbsp; No
          problem.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">sound_data:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_note_offset, 2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C2, C3, C4, C5, ;etc.. more notes in the key of C.</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><b>Adjust Note Offset</b><br />Setting the note offset to a
        specific value has very limited application.&nbsp; It's like a one-time keychange.&nbsp; More
        often we will want to set the note offset to some relative value.&nbsp; For example, instead of
        setting stream_note_offset to 2, we might want to set stream_note_offset to "the current offset +
        2".&nbsp; If we had an opcode that let us adjust stream_note_offset by a relative value, we could
        use it together with loops.&nbsp; First let's write the opcode:<br /><br /><span
          style="font-family: Courier New"
          >;-----------------------------------------------------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;this is our JUMP TABLE!</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_infinite_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_change_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_duty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_set_loop1_counter&nbsp;&nbsp; ;$A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A5</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_set_note_offset&nbsp;&nbsp;&nbsp;&nbsp; ;$A6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">.word se_op_adjust_note_offset&nbsp; ;$A7</span></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;these are aliases to use in the sound data.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >endsound = $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop = $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >volume_envelope = $A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">duty = $A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >set_loop1_counter = $A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop1 = $A5</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >set_note_offset = $A6</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >adjust_note_offset = $A7</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >se_op_adjust_note_offset:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;read the argument (what value to add)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_note_offset, x&nbsp;&nbsp; ;add it to the current offset</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_offset, x&nbsp;&nbsp; ;and save.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Let's look at this opcode in use.&nbsp; Say we have a long
        arpeggiated line like this:<br /><br /><span style="font-family: Courier New"
          >C2, E2, G2, B2, C3, E3, G3, B3, C4, E4, G4, B4, C5, E5, G5, B5, C6, E6, G6, B6, C7 ;Cmaj7 (21
          bytes)</span
        ><br /><br />This passage just repeats the same 4 notes (C E G B) over 5 octaves. &nbsp;<br /><br /><span
          style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_loop1_counter, 5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;loop 5
          times</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C2, E2, G2,
          B2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;these are the 4 notes to
          loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte adjust_note_offset, 12&nbsp;&nbsp;&nbsp; ;each iteration add 12 to
          the offset (ie, go up an octave)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          C2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;will be a C7.&nbsp; Cmaj7 (12 bytes)</span
        ><br />&nbsp;&nbsp; &nbsp;<br />The first time through the loop it will play C2, E2, G2,
        B2.&nbsp; The second time through the loop it will play C3, E3, G3, B3.&nbsp; The third time
        through will be C4, E4, G4, B4, etc.&nbsp; Using our opcodes, we reduce the size of our data from
        21 bytes to 12 bytes.&nbsp; That's almost 50% savings.<br /><br /><b>Battle Kid</b><br />To take
        a better example, let's look at the bassline to the Battle Kid theme song.&nbsp; Last week, it
        looked like this:<br /><br /><span style="font-family: Courier New">song6_tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, A3, A4, A4, A3, A3, A4, A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte G3, G3, G4, G4, G3, G3, G4,
          G4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;down a step (-2)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte F3, F3, F4, F4, F3, F3, F4,
          F4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;down a step (-2)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte Eb3, Eb3, Eb4, Eb4, Eb3, Eb3, Eb4, Eb4&nbsp;&nbsp;&nbsp; ;down a step
          (-2)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song6_tri</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;36 bytes</span
        ><br />&nbsp;&nbsp; &nbsp;<br />We have a pattern here:
        <span style="font-family: Verdana">X3, X3, X4, X4, X3, X3, X4, X4</span>, where X = some
        note.&nbsp; It just so happens that each new X is just the previous X minus 2. Using our new
        opcode, we can rewrite the bassline like this:<br /><br /><span style="font-family: Courier New"
          >song6_tri:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_loop1_counter,
          4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;repeat 4
          times</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A3, A3, A4, A4, A3, A3, A4, A4&nbsp;&nbsp;&nbsp; ;series of notes to
          repeat</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte adjust_note_offset,
          -2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;go down a step</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte loop1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_note_offset,
          0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;after 4 repeats, reset note offset to 0.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;infinite loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          song6_tri&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;21 bytes</span
        ><br />&nbsp;&nbsp; &nbsp;<br />We drop from 36 bytes to 21 bytes of ROM space.&nbsp; About 40%
        savings!<br />&nbsp;&nbsp; &nbsp;<br /><b>Loopy Sound Effects</b><br />We can produce some cool
        sound effects if we combine loops and key changes at high tempos.&nbsp; Look at this one (tempo
        is $FF):<br /><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >song7_square2:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_loop1_counter, $08&nbsp;&nbsp;&nbsp; ;repeat 8 times</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte thirtysecond, D7, D6, G6&nbsp; ;play two D notes at different octaves
          and a G.&nbsp; Pretty random</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte adjust_note_offset, -4&nbsp;&nbsp;&nbsp; ;go down 2 steps</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte loop1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte endsound</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This sound effect plays a simple 3-note pattern in descending
        keys super fast.&nbsp; The sound data is only 12 bytes, but it produces a pretty complex sound
        effect.&nbsp; Listen to song7 in this week's sample files to hear it.&nbsp; By experimenting with
        loops like this we can come up with some sounds that would be difficult to compose by hand.<br />&nbsp;&nbsp;
        &nbsp;<br /><b><font size="3">Complex Chord Progressions</font></b
        ><br />We made some good savings percentage-wise on the bassline to Battle Kid.&nbsp; But we were
        lucky.&nbsp; The chord progression went down in consistent steps: -2, -2, -2.&nbsp; It was
        possible to loop this because we adjust the note_offset by the same value (-2) each time.&nbsp;
        But what if we had a pattern that was repeated in a more complicated way?&nbsp; We do.&nbsp;
        Let's look at the rhythm pattern for our Guardian Legend boss song:<br /><br /><span
          style="font-family: Courier New"
          >song1_square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A2, A2, A2, A3, A2, A3, A2, A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte F3, F3, F3, F4, F3, F4, F3,
          F4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;+8 (A2 + 8 = F3)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A2, A2, A2, A3, A2, A3, A2,
          A3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;-8</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte F3, F3, F3, F4, F3, F4, F3,
          F4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;+8</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte E3, E3, E3, E4, E3, E4, E3,
          E4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte E3, E3, E3, E4, E3, E4, E3,
          E4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;+0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte Ds3, Ds3, Ds3, Ds4, Ds3, Ds4, Ds3, Ds4&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte D3, D3, D3, D4, D3, D4, D3,
          D4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte C3, C3, C3, C4, C3, C4, C3,
          C4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;-2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte B2, B2, B2, B3, B2, B3, B2,
          B3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte As2, As2, As2, As3, As2, As3, As2, As3&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A2, A2, A2, A3, A2, A3, A2,
          A3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte Gs2, Gs2, Gs2, Gs3, Gs2, Gs3, Gs2, Gs3&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte G2, G2, G2, G3, G2, G3, G2,
          G3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;+2 (loop back to A2)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song1_square1</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Here we have another pattern: Xi, Xi, Xi, Xi+1, Xi, Xi+1, Xi,
        Xi+1, where X = some note and i = some octave.&nbsp; Cool.&nbsp; A pattern means we have an
        opportunity to save bytes by looping.&nbsp; But wait.&nbsp; Unlike Battle Kid, this pattern jumps
        around in an inconsistent way.&nbsp; What should we do?<br /><br /><b
          >Super TGL Transposition Trick</b
        ><br />I learned this trick from The Guardian Legend, so I call it the
        <b>TGL Transposition Trick</b>.&nbsp; What we do is we loop the pattern, and then use the loop
        counter as an index into a lookup table.&nbsp; The lookup table contains note offset
        values.&nbsp; Because the loop counter decrements, our lookup table will be sequentially
        backwards.<br /><br />Wait, what?&nbsp; Let's looks at our example:<br /><br /><span
          style="font-family: Courier New"
          >song1_square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_loop1_counter,
          14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;repeat 14
          times</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A2, A2, A2, A3, A2, A3, A2, A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)">;pull a value from lookup_table and</span></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; ; add it to stream_note_offset</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;finite loop (14 times)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;infinite loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song1_square1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.lookup_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte 2, -1, -1, -1, -1, -1, -2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte -1, -1, 0, -1, 8, -8, 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;14
          entries long, reverse order</span
        ><br />&nbsp;&nbsp; &nbsp;<br />I'm going to break it down in a second here, but first let me
        tell you that the part highlighted in red above will be covered by a single opcode,
        transpose.&nbsp; The transpose opcode takes a 2-byte argument, so altogether that commented
        section will be replaced with 3 bytes of data.&nbsp; So if we count up all of the bytes in our
        rhythm sound data we get 34 bytes.&nbsp; The original was 116 bytes.&nbsp; By using the TGL
        Transposition Trick, we save 82 bytes.&nbsp; That's 70%!<br /><br /><span
          style="font-family: Courier New"
          >song1_square1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte set_loop1_counter,
          14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;repeat 14
          times</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.loop:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte A2, A2, A2, A3, A2, A3, A2, A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >.byte
            transpose&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            ;the transpose opcode take a 2-byte argument</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .word
          .lookup_table&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;which is the address of the lookup table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;finite loop (14 times)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word .loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte
          loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;infinite loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song1_square1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.lookup_table:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte 2, -1, -1, -1, -1, -1, -2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte -1, -1, 0, -1, 8, -8, 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;14
          entries long, reverse order</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >;*** altogether 34 bytes ***</span
        ><br /><br />The transpose opcode will set up a pointer variable to point to the lookup
        table.&nbsp; Then it will take the loop counter, subtract 1, and use the result as an index into
        the table.&nbsp; We subtract 1 because the tables index from zero.&nbsp; If we loop 14 times, our
        table will have 14 entries numbered 0-13.&nbsp; Once the transpose opcode has its index, it will
        pull a value from the table.&nbsp; This value will be added to stream_note_offset.<br /><br />Before
        we write the opcode, let's trace through the data to see how it works.&nbsp; We'll start at the
        very first byte of song1_square1:<br /><br />1) set note length to eighth notes<br />2) set the
        loop counter to 14<br /><br />(.loop iteration 1)<br />3) play a series of notes: A2, A2, A2, A3,
        A2, A3, A2, A3<br />4) transpose opcode.&nbsp; Setup a pointer to lookup_table.&nbsp; Use our
        loop counter, minus one, as an index.&nbsp; The loop counter is 14 now, so we will pull out
        .lookup_table+13, which is an 8.&nbsp; Add 8 to the current stream_note_offset: 0 + 8 = 8.<br />5)
        decrement the loop counter (14-&gt;13) and loop back to the .loop label<br /><br />(iteration
        2)<br />6) our new string of notes with the +8: F3, F3, F3, F4, F3, F4, F3, F4. <br />7)
        transpose opcode.&nbsp; Loop counter is 13.&nbsp; Grab .lookup_table+12, which is -8.&nbsp; Add
        -8 to stream_note_offset: 8 + -8 = 0.<br />8) decrement loop counter (13-&gt;12) and loop back to
        .loop label<br /><br />(iteration 3)<br />9) our new string of notes with the +0: A2, A2, A2, A3,
        A2, A3, A2, A3 <br />10) transpose opcode.&nbsp; Loop counter is 12.&nbsp; Grab .lookup_table+11,
        which is 8.&nbsp; Add 8 to stream_note_offset: 0 + 8 = 8.<br />11) decrement loop counter
        (12-&gt;11) and loop back to .loop label<br /><br />(iteration 4)<br />12) our new string of
        notes with the +8: F3, F3, F3, F4, F3, F4, F3, F4. <br />13) transpose opcode.&nbsp; Loop counter
        is 11.&nbsp; Grab .lookup_table+10, which is -1.&nbsp; Add -1 to stream_note_offset: 8 + -1 =
        7.<br />14) decrement loop counter (11-&gt;10) and loop back to .loop label<br /><br />(iteration
        4)<br />15) our new string of notes with the +7: E3, E3, E3, E4, E3, E4, E3, E4. <br />16)
        transpose opcode.&nbsp; Loop counter is 10.&nbsp; Grab .lookup_table+9, which is 0.&nbsp; Add 0
        to stream_note_offset: 7 + 0 = 7.<br />17) decrement loop counter (10-&gt;9) and loop back to
        .loop label<br /><br />etc.&nbsp; On the last iteration our loop counter is 1.&nbsp; We grab
        .lookup_table+0 and add it to stream_note_offset.&nbsp; Then we decrement the loop counter
        (1-&gt;0).&nbsp; Our loop counter is now 0, so our loop breaks.&nbsp; Pretty cool, no?&nbsp;
        Let's write it.<br /><br /><span style="font-family: Courier New"
          >;-----------------------------------------------------------------------</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;this is our JUMP TABLE!</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >sound_opcodes:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_endsound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_infinite_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_change_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_duty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_set_loop1_counter&nbsp;&nbsp; ;$A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_loop1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;$A5</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_set_note_offset&nbsp;&nbsp;&nbsp;&nbsp; ;$A6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word se_op_adjust_note_offset&nbsp; ;$A7</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .word
          se_op_transpose&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;$A8</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >;these are aliases to use in the sound data.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >endsound = $A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop = $A1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >volume_envelope = $A2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">duty = $A3</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >set_loop1_counter = $A4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">loop1 = $A5</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >set_note_offset = $A6</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >adjust_note_offset = $A7</span
        ><br style="font-family: Courier New" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >transpose = $A8</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >se_op_transpose:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;read low byte of the pointer to our lookup table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta
          <span style="color: rgb(255, 0, 0)">sound_ptr2</span
          >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;store it in a
          new pointer variable</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;read high byte of pointer to table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta <span style="color: rgb(255, 0, 0)">sound_ptr2</span>+1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty
          sound_temp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;save
          y because we are about to destroy it</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda stream_loop1, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;get
          loop counter, put it in Y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          tay&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;&nbsp;&nbsp; this will be our index into the lookup table</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          dey&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;subtract 1 because indexes start from 0.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [<span style="color: rgb(255, 0, 0)">sound_ptr2</span>],
          y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;read a value from the table.</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_note_offset, x&nbsp;&nbsp; ;add it to the note offset</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_offset, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy
          sound_temp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;restore Y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />There is a new pointer variable here, sound_ptr2.&nbsp; Actually,
        what I really did was rename jmp_ptr to sound_ptr2.&nbsp; The new name let's me know it's for
        sound engine use only.&nbsp; Since we finish with jmp_ptr as soon as we jump, there are no
        pointer conflicts here.<br /><br /><b>Conclusion</b><br />This is just an example of how clever
        use of opcodes and looping can save you lots of bytes.&nbsp; Keep in mind that this transpose
        opcode is only useful if you write music that has repeating patterns in the rhythm section.&nbsp;
        If you don't, then save yourself some bytes and cut the opcode from your sound engine.<br /><br /><b
          >Putting It All Together</b
        ><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/opcodes2.zip"
          target="_blank"
          original-href="http://tummaigames.com/opcodes2.zip"
          >opcodes2.zip</a
        >
        sample files.&nbsp; Make sure the following files are in the same folder as NESASM3:<br /><br />&nbsp;&nbsp;&nbsp;
        opcodes2.asm<br />&nbsp;&nbsp;&nbsp; sound_engine.asm<br />&nbsp;&nbsp;&nbsp;
        sound_opcodes.asm<br />&nbsp;&nbsp;&nbsp; opcodes2.chr<br />&nbsp;&nbsp;&nbsp; note_table.i<br />&nbsp;&nbsp;&nbsp;
        note_length_table.i<br />&nbsp;&nbsp;&nbsp; vol_envelopes.i<br />&nbsp;&nbsp;&nbsp; song0.i<br />&nbsp;&nbsp;&nbsp;
        song1.i<br />&nbsp;&nbsp;&nbsp; song2.i<br />&nbsp;&nbsp;&nbsp; song3.i<br />&nbsp;&nbsp;&nbsp;
        song4.i<br />&nbsp;&nbsp;&nbsp; song5.i<br />&nbsp;&nbsp;&nbsp; song6.i<br />&nbsp;&nbsp;&nbsp;
        song7.i<br />&nbsp;&nbsp;&nbsp; opcodes2.bat<br /><br />Double click opcodes2.bat. That will run
        NESASM3 and should produce the opcodes2.nes file. Run that NES file in FCEUXD SP.<br /><br />Use
        the controller to select songs and play them.&nbsp; Controls are as follows:<br />&nbsp;&nbsp;
        &nbsp;<br /><b>Up</b>: Play<br /><b>Down</b>: Stop <br /><b>Right</b> : Next Song/SFX<br /><b
          >Left</b
        >
        : Previous Song/SFX<br /><br />Song0 is a silence song.&nbsp; Not selectable.<br />Song1-Song6
        are the same as last week, but they take up less ROM-space now<br />Song7 is a new sound effect
        created by looping a key change at high tempo.<br /><br />As usual, try adding your own songs and
        sound effects in using the new opcodes.&nbsp; Experiment.<br /><br /><b>Next Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=27943"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=27943"
          >Noise, Simple Drums</a
        ><br />
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-9__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=26247"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
    <div class="tutorialCard mdl-card mdl-shadow--2dp" id="audio_tutorial-10">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Nerdy Nights Sound: Part 10: Simple Drums</h2>
      </div>
      <div class="mdl-card__supporting-text">
        <b>Last Week</b>:
        <a
          href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=26247"
          target="_blank"
          original-href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=26247"
          >Finite Looping, Key Changes, Chord Progressions</a
        ><br /><b
          ><br />
          This Week</b
        >: Simple Drums<br /><br /><font size="5"><b>Drums</b></font
        ><br />This week we are going to take a look at drums.&nbsp; I saved them until now because they
        use the <b>Noise</b> channel, which operates much differently from the other 3 channels.&nbsp;
        With the Square and Triangle channels we manually set the waveform period to choose what note to
        play.&nbsp; Our note lookup table was just a table of periods to plug into the channel
        ports.&nbsp; The Noise channel on the other hand produces random noise.&nbsp; We don't use a note
        table at all.<br /><br /><font size="3"><b>Noise Channel</b></font
        ><br />The noise channel doesn't produce notes, it produces noise.&nbsp; We communicate with the
        noise channel through 3 ports: <b>$400C</b>, <b>$400E</b>, <b>$400F</b>.&nbsp; Note that port
        $400D is <i>unused</i>.&nbsp; Let's take a closer look at the Noise ports.<br /><br /><b
          >Volume - $400C</b
        ><br />$400C let's you control the volume of the Noise channel.&nbsp; It works just like the
        Square channels, except there is no Duty Cycle:<br /><br /><span style="font-family: Courier New"
          >NOI_ENV ($400C)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; ||||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; ||++++- Volume</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; |+----- Saw Envelope Disable (0: use internal counter for volume; 1: use Volume for
          volume)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp; +------ Length Counter Disable (0: use Length Counter; 1: disable Length Counter)</span
        ><br />&nbsp; <br />For our purposes, we will set Saw Envelope Disable and Length Counter Disable
        and forget about them.&nbsp; This will allow us to have full control of "note" length and volume
        via Volume Envelopes.&nbsp; We did the same thing for the Square channels.<br /><br /><b
          >Random Generator - $400E</b
        ><br />$400E let's us control the settings for the random generator.&nbsp; It looks like this:<br /><br /><span
          style="font-family: Courier New"
          >NOI_RAND ($400E)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|&nbsp;&nbsp; ||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|&nbsp;&nbsp; ++++- Sound Type</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >+-------- Mode</span
        ><br /><br /><b>Mode</b> sets the mode.&nbsp; There are two modes, <b>Mode-0</b> and
        <b>Mode-1</b>.&nbsp; Mode-0 sounds dull and breathy, like static sssh.&nbsp; Mode-1 sounds more
        sharp, robotic and buzzy.&nbsp; There's really no good way to describe in words, so the best way
        to know the difference in sound is to listen to both modes.&nbsp; (see below)<br /><br />Each
        mode has 16 possible sounds, selected by <b>Sound Type</b>.&nbsp; This means that the Noise
        channel really only gives us 32 possible sounds total!&nbsp; More complex sound effects on the
        Noise channel are created by playing combinations of these 32 noises one after another.&nbsp; To
        hear what each of the 32 sounds sound like, listen to <b>Song 8</b> in this week's sample
        program.&nbsp; It plays the 16 Mode-0 sounds followed by the 16 Mode-1 sounds.<br /><br />Note:
        In this tutorial I will assign each of the 32 Noise channel sounds a number 00-1F.&nbsp; The left
        number (0 or 1) refers to the <i>Mode</i>.&nbsp; The right number (0-F) refers to the
        <i>Sound Type</i>.&nbsp; For example, sound "04" means "Mode 0, Sound Type 4".&nbsp; Sound "1E"
        means "Mode 1, Sound Type E".<br /><br /><b>Length Counter - $400F</b><br />$400F is the Noise
        channel's length counter.&nbsp; We disabled the length counter in $400C, so we can ignore this
        port completely!<br /><font size="3"
          ><b
            ><br />
            Simple Noise Drums<br /> </b></font
        ><br />The simplest way to make a drum sound on the Noise channel is to play a single Sound Type
        under a volume envelope that decays to 0 (silence).&nbsp; Many games use this kind of drum
        exclusively.&nbsp; The Guardian Legend for example only uses two drum sounds throughout the whole
        game: 04 and 06.&nbsp; Battle Kid makes heavy use this simple drum style too.&nbsp; Lots of games
        do.<br /><br />So how will we represent simple drums in the sound data?&nbsp; Recall that our
        sound engine distinguishes between Notes, Note Lengths and Opcodes using ranges:<br /><br /><span
          style="font-family: Courier New"
          >.fetch:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda [sound_ptr], y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bpl
          .note&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;if &lt; #$80, it's a Note</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; cmp #$A0</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .note_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;else if
          &lt; #$A0, it's a Note Length</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.opcode:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else it's an opcode</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do opcode stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;<span style="color: rgb(255, 0, 0)">range A0-FF</span></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.note_length:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note length stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;<span style="color: rgb(255, 0, 0)">range 80-9F</span></span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do note stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;<span style="color: rgb(255, 0, 0)">range 00-7F</span></span
        ><br />&nbsp;&nbsp; &nbsp;<br />Although we won't use our note table for the Noise channel, we
        will treat drums like notes as far as ranges are concerned.&nbsp; So we need our drum data values
        to be in the range of $00-$7F.&nbsp; That's easy.&nbsp; We'll assign the Mode-0 sounds to $00-$0F
        and Mode-1 sounds to $10-$1F.&nbsp; Some drum data might look like this then:<br /><br /><span
          style="font-family: Courier New"
          >example_drum_data:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth, $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte sixteenth, $1E, $1E, $1F</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte d_eighth, $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte sixteenth, $06, $06, $08, $08</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth, $17, $07</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word example_drum_data</span
        ><br /><br /><br />Since we are not using the note table for Noise, we will need to alter our
        Note code to check the channel and branch to different code if we are processing the Noise
        channel (new stuff in red):<br /><br /><span style="font-family: Courier New">.note:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;do Note stuff</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp;
          <span style="color: rgb(255, 0, 0)"
            >sta sound_temp2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            ;save the note value</span
          ></span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda stream_channel, x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;what channel are
          we using?</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; cmp
          #NOISE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;is it the Noise channel?</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; bne
          .not_noise&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; jsr
          se_do_noise&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if so, JSR
          to a subroutine to handle noise data</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; jmp
          .reset_ve&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;and skip the note table when we return</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >.not_noise:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;else grab a period from the note_table</span
        ><br style="font-family: Courier New; color: rgb(255, 0, 0)" /><span
          style="font-family: Courier New; color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; lda sound_temp2&nbsp;&nbsp;&nbsp;&nbsp; ;restore note value</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sty sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;save our index into the data
          stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_note_offset, x&nbsp;&nbsp; ;add note offset</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; asl a</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tay</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda note_table+1, y</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ldy sound_temp1&nbsp;&nbsp;&nbsp;&nbsp; ;restore data stream index</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ;check if it's a rest and modify the status flag appropriately</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; jsr se_check_rest</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          ><span style="color: rgb(255, 0, 0)">.reset_ve:</span>&nbsp;&nbsp; &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda #$00</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ve_index, x &nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >.update_pointer:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; iny</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; tya</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; clc</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; adc stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_ptr_LO, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; bcc .end</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; inc stream_ptr_HI, x</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.end:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />This code checks to see if the channel is the Noise
        channel.&nbsp; If so it JSRs to a special Noise subroutine.&nbsp; Upon return, it jumps over the
        note_table code and updates the volume envelope and stream pointer like normal.<br /><br />So
        what does our special Noise subroutine,
        <span style="font-family: Courier New">se_do_noise</span>, look like?&nbsp; The job of
        <span style="font-family: Courier New">se_do_noise</span> will be to take the note value and
        convert it into something we can write to $400E (NOI_RAND).&nbsp; Recall that $400E expects the
        Mode number in bit7 and the Sound Type in bits 0-3:<br /><br
          style="font-family: Courier New"
        /><span style="font-family: Courier New">NOI_RAND ($400E)</span
        ><br style="font-family: Courier New" /><br style="font-family: Courier New" /><span
          style="font-family: Courier New"
          >76543210</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|&nbsp;&nbsp; ||||</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >|&nbsp;&nbsp; ++++- Sound Type</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >+-------- Mode</span
        ><br /><br /><b>Mode-0</b> sounds don't need to be converted at all.&nbsp; We represent them with
        the values $00-$0F, which correspond exactly to the values we need to write to $400E.<br /><br /><b
          >Mode-1</b
        >
        sounds need to be tweaked a bit.&nbsp; We represent Mode-1 sounds with the values $10-$1F, or in
        binary %00010000-%00011111.&nbsp; Notice we identify the Mode number using bit4.&nbsp; Port $400E
        expects the Mode number in bit7 though, not bit4, so we will need to set bit7 ourselves:<br /><br /><span
          style="font-family: Courier New"
          >se_do_noise:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_temp2&nbsp;&nbsp;&nbsp;&nbsp; ;restore the note value</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; and #%00010000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;isolate bit4</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; beq .mode0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;if it's
          clear, Mode-0, so no conversion</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.mode1:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_temp2&nbsp;&nbsp;&nbsp;&nbsp; ;else Mode-1, restore the note
          value</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; ora #%10000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;set bit 7 to set Mode-1</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta sound_temp2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">.mode0:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; lda sound_temp2</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; sta stream_note_LO, x&nbsp;&nbsp; ;temporary port that gets copied to
          $400E</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; rts</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Now everything is set.&nbsp; Note values of $00-$0F will get
        written to <span style="font-family: Courier New">stream_note_LO</span> directly.&nbsp; Note
        values of $10-$1F will get converted to $90-$9F first and then get written to
        <span style="font-family: Courier New">stream_note_LO</span>.&nbsp; Note that we do not bother
        clearing bit4 for Mode-1 sounds.&nbsp; Bit4 has no effect on $400E so we can just leave it as it
        is.<br /><br /><font size="3"><b>Drum Decay</b></font
        ><br />The only thing left to add is a volume envelope for the simple drums to use.&nbsp; It
        should be short and decay to zero (silence):<br /><br />volume_envelopes:<br />&nbsp;&nbsp;&nbsp;
        .word se_ve_1<br />&nbsp;&nbsp;&nbsp; .word se_ve_2<br />&nbsp;&nbsp;&nbsp; .word se_ve_3<br />&nbsp;&nbsp;&nbsp;
        .word se_ve_tgl_1<br />&nbsp;&nbsp;&nbsp; .word se_ve_tgl_2<br />&nbsp;&nbsp;&nbsp; .word
        se_battlekid_loud<br />&nbsp;&nbsp;&nbsp; .word se_battlekid_loud_long<br />&nbsp;&nbsp;&nbsp;
        .word se_battlekid_soft<br />&nbsp;&nbsp;&nbsp; .word se_battlekid_soft_long<br />&nbsp;&nbsp;&nbsp;
        <span style="color: rgb(255, 0, 0)">.word se_drum_decay</span><br />&nbsp;&nbsp; &nbsp;<br /><span
          style="color: rgb(255, 0, 0)"
          >se_drum_decay:</span
        ><br style="color: rgb(255, 0, 0)" /><span style="color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .byte $0E, $09, $08, $06, $04, $03, $02, $01, $00&nbsp; ;7 frames per
          drum.&nbsp; Experiment to get the length and attack you want.</span
        ><br style="color: rgb(255, 0, 0)" /><span style="color: rgb(255, 0, 0)"
          >&nbsp;&nbsp;&nbsp; .byte $FF</span
        ><br />&nbsp;&nbsp; &nbsp;<br /><span style="color: rgb(255, 0, 0)">ve_drum_decay = $09</span
        ><br style="color: rgb(255, 0, 0)" /><br />You can of course make multiple volume envelopes for
        the drums to choose from.<br /><br /><font size="3"><b>Conclusion</b></font
        ><br /><br />Now we can add drum data to our songs.&nbsp; Here is the drum data for The Guardian
        Legend boss song we've been using:<br /><br /><span style="font-family: Courier New"
          >;in the song header, after the header info for Squares and Triangle:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte MUSIC_NOI&nbsp;&nbsp;&nbsp;&nbsp; ;which stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;status byte: enabled</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte NOISE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;which
          channel</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;initial volume_duty value (disable length counter and saw envelope)</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte ve_drum_decay ;volume envelope</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song1_noise&nbsp;&nbsp; ;pointer to the sound data stream</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte $53&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;tempo</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">&nbsp;</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New">song1_noise:</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth,
          $04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          ;this song only uses drum 04 (Mode-0, Sound Type 4) for a snare</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte sixteenth, $04, $04, $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte d_eighth, $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte sixteenth, $04, $04, $04, $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte eighth, $04, $04</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .byte loop</span
        ><br style="font-family: Courier New" /><span style="font-family: Courier New"
          >&nbsp;&nbsp;&nbsp; .word song1_noise</span
        ><br />&nbsp;&nbsp; &nbsp;<br />Try adding some drums to your own songs!<br />&nbsp;&nbsp;
        &nbsp;<br /><b>Putting It All Together</b><br />Download and unzip the
        <a
          href="downloads/NerdyNightsSoundSourceCollection/drums.zip"
          target="_blank"
          original-href="http://tummaigames.com/drums.zip"
          >drums.zip</a
        >
        sample files.&nbsp; Make sure the following files are in the same folder as NESASM3:<br /><br />&nbsp;&nbsp;&nbsp;
        drums.asm<br />&nbsp;&nbsp;&nbsp; sound_engine.asm<br />&nbsp;&nbsp;&nbsp; sound_opcodes.asm<br />&nbsp;&nbsp;&nbsp;
        drums.chr<br />&nbsp;&nbsp;&nbsp; note_table.i<br />&nbsp;&nbsp;&nbsp; note_length_table.i<br />&nbsp;&nbsp;&nbsp;
        vol_envelopes.i<br />&nbsp;&nbsp;&nbsp; song0.i<br />&nbsp;&nbsp;&nbsp; song1.i<br />&nbsp;&nbsp;&nbsp;
        song2.i<br />&nbsp;&nbsp;&nbsp; song3.i<br />&nbsp;&nbsp;&nbsp; song4.i<br />&nbsp;&nbsp;&nbsp;
        song5.i<br />&nbsp;&nbsp;&nbsp; song6.i<br />&nbsp;&nbsp;&nbsp; song7.i<br />&nbsp;&nbsp;&nbsp;
        song8.i<br />&nbsp;&nbsp;&nbsp; drums.bat<br /><br />Double click drums.bat. That will run
        NESASM3 and should produce the drums.nes file. Run that NES file in FCEUXD SP.<br /><br />Use the
        controller to select songs and play them.&nbsp; Controls are as follows:<br />&nbsp;&nbsp;
        &nbsp;<br /><b>Up</b>: Play<br /><b>Down</b>: Stop <br /><b>Right</b> : Next Song/SFX<br /><b
          >Left</b
        >
        : Previous Song/SFX<br /><br /><b>Song0</b> is a silence song.&nbsp; Not selectable.<br /><b
          >Song1-Song7</b
        >
        are the same as last week, but a few of them (1, 4 and 6) have drums now.<br /><b
          style="color: rgb(255, 0, 0)"
          >Song8</b
        >
        is a new "song" that plays each of the Noise channel's 32 sounds, in order from 00-1F.&nbsp;
        First it plays them with a sustained volume envelope so that you can hear how they sound drawn
        out.&nbsp; Next they are played using the 7-frame ve_drum_decay volume envelope we made so you
        can hear how they sound as simple drum sounds.<br /><br /><b>Next Week</b>: More Complex Drums,
        Noise SFX
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="#audio_tutorial-toc"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Back to Table of Contents
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>
        <a
          class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
          href="javascript:doCommentToggle('audio_tutorial-10__comments');"
          data-upgraded=",MaterialButton,MaterialRipple"
        >
          Toggle Comments
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
        ></a>

        <div style="float: right">
          <a
            class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect mdl-button--accent"
            href="http://nintendoage.com/forum/messageview.cfm?catid=22&amp;threadid=27943"
            target="_blank"
            data-upgraded=",MaterialButton,MaterialRipple"
          >
            Original Article
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span
          ></a>
        </div>
      </div>
    </div>
  </body>
</html>
